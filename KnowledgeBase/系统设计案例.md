# ç³»ç»Ÿè®¾è®¡æ¡ˆä¾‹ï¼ˆé«˜é¢‘é¢è¯•é¢˜ï¼‰

## ç›®å½•
1. [æ’è¡Œæ¦œç³»ç»Ÿ](#æ’è¡Œæ¦œç³»ç»Ÿ)
2. [ç§’æ€ç³»ç»Ÿ](#ç§’æ€ç³»ç»Ÿ)
3. [çŸ­é“¾æ¥ç³»ç»Ÿ](#çŸ­é“¾æ¥ç³»ç»Ÿ)
4. [æŠ¢çº¢åŒ…ç³»ç»Ÿ](#æŠ¢çº¢åŒ…ç³»ç»Ÿ)
5. [å»¶æ—¶é˜Ÿåˆ—](#å»¶æ—¶é˜Ÿåˆ—)
6. [åˆ†å¸ƒå¼é”](#åˆ†å¸ƒå¼é”)
7. [é™æµç³»ç»Ÿ](#é™æµç³»ç»Ÿ)
8. [åˆ†åº“åˆ†è¡¨](#åˆ†åº“åˆ†è¡¨)

---

## ğŸ“Œ æ’è¡Œæ¦œç³»ç»Ÿï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ éœ€æ±‚åˆ†æ

**åŠŸèƒ½éœ€æ±‚ï¼š**
1. å®æ—¶æ›´æ–°ç”¨æˆ·åˆ†æ•°
2. æŸ¥è¯¢ç”¨æˆ·æ’å
3. æŸ¥è¯¢Top Næ’è¡Œæ¦œ
4. æŸ¥è¯¢æŸä¸ªåˆ†æ•°æ®µçš„ç”¨æˆ·
5. æ”¯æŒå¤šç»´åº¦æ’è¡Œï¼ˆæ—¥æ¦œã€å‘¨æ¦œã€æœˆæ¦œã€æ€»æ¦œï¼‰

**éåŠŸèƒ½éœ€æ±‚ï¼š**
- é«˜å¹¶å‘ï¼šæ—¥æ´»åƒä¸‡çº§åˆ«
- ä½å»¶è¿Ÿï¼šæŸ¥è¯¢æ’å<10ms
- å‡†ç¡®æ€§ï¼šæ’åå¿…é¡»å‡†ç¡®
- å¯æ‰©å±•ï¼šæ”¯æŒå¤šç§æ¦œå•ç±»å‹

**æ•°æ®é‡ä¼°ç®—ï¼š**
```
ç”¨æˆ·é‡ï¼š1000ä¸‡
å¹¶å‘QPSï¼š10ä¸‡
å­˜å‚¨ï¼š1000ä¸‡ Ã— (userID 8å­—èŠ‚ + score 8å­—èŠ‚) â‰ˆ 160MB
```

### âœ… æŠ€æœ¯æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šMySQLï¼ˆâŒ ä¸æ¨èï¼‰

**è®¾è®¡ï¼š**
```sql
CREATE TABLE leaderboard (
    user_id BIGINT PRIMARY KEY,
    score BIGINT NOT NULL,
    update_time TIMESTAMP,
    INDEX idx_score (score DESC)
);

-- æ›´æ–°åˆ†æ•°
UPDATE leaderboard SET score = score + 10 WHERE user_id = 100;

-- æŸ¥è¯¢æ’å
SELECT COUNT(*) + 1 AS rank
FROM leaderboard
WHERE score > (SELECT score FROM leaderboard WHERE user_id = 100);

-- æŸ¥è¯¢Top 100
SELECT user_id, score
FROM leaderboard
ORDER BY score DESC
LIMIT 100;
```

**é—®é¢˜ï¼š**
- âŒ æŸ¥è¯¢æ’åéœ€è¦å…¨è¡¨æ‰«æï¼ŒO(n)å¤æ‚åº¦
- âŒ é«˜å¹¶å‘ä¸‹UPDATEä¼šäº§ç”Ÿé”ç«äº‰
- âŒ æ’åºå¼€é”€å¤§

#### æ–¹æ¡ˆ2ï¼šRedis ZSetï¼ˆâœ… æ¨èï¼‰

**æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š**
```
Redis ZSetï¼ˆæœ‰åºé›†åˆï¼‰ï¼š
- memberï¼šç”¨æˆ·ID
- scoreï¼šåˆ†æ•°
- åº•å±‚ï¼šè·³è¡¨ + å“ˆå¸Œè¡¨
- æ—¶é—´å¤æ‚åº¦ï¼š
  - ZADDï¼šO(logN)
  - ZRANKï¼šO(logN)
  - ZRANGEï¼šO(logN + M)ï¼ŒMä¸ºè¿”å›å…ƒç´ æ•°
```

**å®ç°ä»£ç ï¼š**
```java
public class LeaderboardService {
    private RedisTemplate<String, String> redisTemplate;

    // æ¦œå•keyå‘½åè§„èŒƒ
    private static final String DAILY_RANK = "rank:daily:";
    private static final String WEEKLY_RANK = "rank:weekly:";
    private static final String TOTAL_RANK = "rank:total";

    /**
     * å¢åŠ ç”¨æˆ·åˆ†æ•°
     */
    public void incrScore(Long userId, double score) {
        String today = LocalDate.now().toString();

        // æ›´æ–°æ—¥æ¦œ
        redisTemplate.opsForZSet().incrementScore(
            DAILY_RANK + today,
            userId.toString(),
            score
        );

        // æ›´æ–°æ€»æ¦œ
        redisTemplate.opsForZSet().incrementScore(
            TOTAL_RANK,
            userId.toString(),
            score
        );
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·æ’åï¼ˆä»0å¼€å§‹ï¼‰
     */
    public Long getRank(Long userId) {
        // ZREVRANKï¼šæŒ‰åˆ†æ•°ä»å¤§åˆ°å°æ’å
        Long rank = redisTemplate.opsForZSet().reverseRank(
            TOTAL_RANK,
            userId.toString()
        );
        return rank != null ? rank + 1 : null;  // è½¬ä¸ºä»1å¼€å§‹
    }

    /**
     * æŸ¥è¯¢Top N
     */
    public List<UserScore> getTopN(int n) {
        // ZREVRANGEï¼šæŒ‰åˆ†æ•°é™åºè·å–
        Set<ZSetOperations.TypedTuple<String>> set =
            redisTemplate.opsForZSet().reverseRangeWithScores(
                TOTAL_RANK,
                0,
                n - 1
            );

        List<UserScore> result = new ArrayList<>();
        int rank = 1;
        for (ZSetOperations.TypedTuple<String> tuple : set) {
            result.add(new UserScore(
                Long.parseLong(tuple.getValue()),
                tuple.getScore(),
                rank++
            ));
        }
        return result;
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ†æ•°
     */
    public Double getScore(Long userId) {
        return redisTemplate.opsForZSet().score(
            TOTAL_RANK,
            userId.toString()
        );
    }

    /**
     * æŸ¥è¯¢åˆ†æ•°æ®µå†…çš„ç”¨æˆ·æ•°é‡
     */
    public Long countByScoreRange(double min, double max) {
        return redisTemplate.opsForZSet().count(
            TOTAL_RANK,
            min,
            max
        );
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·å‘¨å›´çš„æ’å
     */
    public List<UserScore> getRankAround(Long userId, int range) {
        Long rank = redisTemplate.opsForZSet().reverseRank(
            TOTAL_RANK,
            userId.toString()
        );

        if (rank == null) return null;

        long start = Math.max(0, rank - range);
        long end = rank + range;

        Set<ZSetOperations.TypedTuple<String>> set =
            redisTemplate.opsForZSet().reverseRangeWithScores(
                TOTAL_RANK,
                start,
                end
            );

        // è½¬æ¢ä¸ºList<UserScore>
        // ...
    }
}
```

**Rediså‘½ä»¤ç¤ºä¾‹ï¼š**
```bash
# æ·»åŠ /æ›´æ–°åˆ†æ•°
ZADD rank:total 1000 user:100
ZINCRBY rank:total 50 user:100    # å¢åŠ 50åˆ†

# æŸ¥è¯¢æ’åï¼ˆä»0å¼€å§‹ï¼‰
ZREVRANK rank:total user:100      # è¿”å›ï¼š0ï¼ˆç¬¬1åï¼‰

# æŸ¥è¯¢åˆ†æ•°
ZSCORE rank:total user:100        # è¿”å›ï¼š1050

# æŸ¥è¯¢Top 10
ZREVRANGE rank:total 0 9 WITHSCORES

# è¾“å‡ºï¼š
1) "user:100"
2) "1050"
3) "user:200"
4) "user:50"
...

# æŸ¥è¯¢åˆ†æ•°æ®µï¼ˆ1000-2000åˆ†ï¼‰
ZRANGEBYSCORE rank:total 1000 2000 WITHSCORES

# æŸ¥è¯¢åˆ†æ•°æ®µçš„æ•°é‡
ZCOUNT rank:total 1000 2000       # è¿”å›ï¼š125

# æŸ¥è¯¢ç”¨æˆ·å‘¨å›´æ’å
ZREVRANK rank:total user:100      # å‡è®¾è¿”å›50
ZREVRANGE rank:total 45 55 WITHSCORES  # å‰å5å
```

### ğŸ”¥ è¿›é˜¶ä¼˜åŒ–

#### 1ï¸âƒ£ å¤šç»´åº¦æ¦œå•ï¼ˆæ—¥æ¦œã€å‘¨æ¦œã€æœˆæ¦œï¼‰

**è®¾è®¡æ€è·¯ï¼š**
```
rank:daily:2024-01-01    # æ—¥æ¦œï¼Œæ¯å¤©ä¸€ä¸ª
rank:weekly:2024-W01     # å‘¨æ¦œï¼Œæ¯å‘¨ä¸€ä¸ª
rank:monthly:2024-01     # æœˆæ¦œï¼Œæ¯æœˆä¸€ä¸ª
rank:total               # æ€»æ¦œ
```

**å®šæ—¶ä»»åŠ¡æ¸…ç†ï¼š**
```java
@Scheduled(cron = "0 0 0 * * ?")  // æ¯å¤©0ç‚¹æ‰§è¡Œ
public void cleanExpiredRanks() {
    String yesterday = LocalDate.now().minusDays(8).toString();
    redisTemplate.delete(DAILY_RANK + yesterday);  // åˆ é™¤8å¤©å‰çš„æ—¥æ¦œ
}
```

#### 2ï¸âƒ£ æ¦œå•åˆ†ç‰‡ï¼ˆç™¾ä¸‡çº§ç”¨æˆ·ï¼‰

**é—®é¢˜ï¼š** å•ä¸ªZSetç™¾ä¸‡çº§åˆ«æ—¶ï¼ŒZRANGEæ€§èƒ½ä¸‹é™

**è§£å†³æ–¹æ¡ˆï¼šåˆ†æ®µå­˜å‚¨**
```
rank:segment:0    # 0-100ä¸‡åˆ†
rank:segment:1    # 100ä¸‡-200ä¸‡åˆ†
rank:segment:2    # 200ä¸‡-300ä¸‡åˆ†
```

**æŸ¥è¯¢æ—¶åˆå¹¶ï¼š**
```java
public List<UserScore> getTopN(int n) {
    List<UserScore> result = new ArrayList<>();

    // ä»é«˜åˆ†æ®µå¼€å§‹æŸ¥
    for (int i = maxSegment; i >= 0 && result.size() < n; i--) {
        Set<ZSetOperations.TypedTuple<String>> set =
            redisTemplate.opsForZSet().reverseRangeWithScores(
                "rank:segment:" + i,
                0,
                n - result.size() - 1
            );
        result.addAll(convertToUserScore(set));
    }

    return result;
}
```

#### 3ï¸âƒ£ ç¼“å­˜Top Nåˆ°æœ¬åœ°

**ä¼˜åŒ–æ€è·¯ï¼š**
- Top 100çš„æ•°æ®è®¿é—®é¢‘ç‡æé«˜
- å¯ä»¥ç¼“å­˜åˆ°æœ¬åœ°ï¼Œå‡å°‘Redisè®¿é—®

```java
@Component
public class TopNCache {
    private volatile List<UserScore> cachedTopN;
    private final ReentrantReadWriteLock lock = new ReentrantReadWriteLock();

    @Scheduled(fixedRate = 5000)  // æ¯5ç§’æ›´æ–°
    public void refreshCache() {
        List<UserScore> newTopN = fetchTopNFromRedis(100);

        lock.writeLock().lock();
        try {
            cachedTopN = newTopN;
        } finally {
            lock.writeLock().unlock();
        }
    }

    public List<UserScore> getTopN() {
        lock.readLock().lock();
        try {
            return new ArrayList<>(cachedTopN);
        } finally {
            lock.readLock().unlock();
        }
    }
}
```

#### 4ï¸âƒ£ é˜²åˆ·åˆ†

**æ–¹æ¡ˆ1ï¼šé™æµ**
```java
// æ¯ä¸ªç”¨æˆ·æ¯ç§’æœ€å¤šå¢åŠ 10æ¬¡åˆ†æ•°
String key = "rate:limit:user:" + userId;
Long count = redisTemplate.opsForValue().increment(key);
if (count == 1) {
    redisTemplate.expire(key, 1, TimeUnit.SECONDS);
}
if (count > 10) {
    throw new TooManyRequestsException();
}
```

**æ–¹æ¡ˆ2ï¼šåˆ†æ•°å¢é•¿ä¸Šé™**
```java
// æ¯å¤©æœ€å¤šå¢åŠ 1000åˆ†
String dailyKey = "daily:score:" + userId + ":" + LocalDate.now();
Long dailyScore = redisTemplate.opsForValue().increment(dailyKey, score);
if (dailyScore > 1000) {
    throw new DailyLimitExceededException();
}
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

**Qï¼šå¦‚ä½•è®¾è®¡ä¸€ä¸ªæ’è¡Œæ¦œç³»ç»Ÿï¼Ÿ**

```
ã€éœ€æ±‚ã€‘
1. å®æ—¶æ›´æ–°åˆ†æ•°
2. æŸ¥è¯¢æ’å
3. æŸ¥è¯¢Top N
4. æ—¥æ´»åƒä¸‡çº§åˆ«ï¼ŒQPS 10ä¸‡

ã€æŠ€æœ¯é€‰å‹ã€‘
ä½¿ç”¨Redis ZSetï¼ˆæœ‰åºé›†åˆï¼‰ï¼š
- memberå­˜å‚¨ç”¨æˆ·ID
- scoreå­˜å‚¨åˆ†æ•°
- åº•å±‚è·³è¡¨ï¼Œæ—¶é—´å¤æ‚åº¦O(logN)

ã€æ ¸å¿ƒæ¥å£ã€‘
1. ZINCRBYï¼šå¢åŠ åˆ†æ•°ï¼ŒO(logN)
2. ZREVRANKï¼šæŸ¥è¯¢æ’åï¼ŒO(logN)
3. ZREVRANGEï¼šæŸ¥è¯¢Top Nï¼ŒO(logN + M)

ã€ä¼˜åŒ–æ–¹æ¡ˆã€‘
1. å¤šç»´åº¦æ¦œå•ï¼šæ—¥æ¦œã€å‘¨æ¦œã€æœˆæ¦œã€æ€»æ¦œ
2. å®šæ—¶æ¸…ç†ï¼šåˆ é™¤è¿‡æœŸæ¦œå•
3. æœ¬åœ°ç¼“å­˜ï¼šTop 100ç¼“å­˜åˆ°æœ¬åœ°ï¼Œæ¯5ç§’æ›´æ–°
4. åˆ†ç‰‡ï¼šç™¾ä¸‡çº§ç”¨æˆ·åˆ†æ®µå­˜å‚¨
5. é˜²åˆ·ï¼šé™æµ + æ¯æ—¥ä¸Šé™

ã€æ•°æ®æŒä¹…åŒ–ã€‘
1. Redis AOFæŒä¹…åŒ–
2. å®šæ—¶dumpåˆ°MySQLï¼ˆç¦»çº¿åˆ†æï¼‰
```

---

## ğŸ“Œ ç§’æ€ç³»ç»Ÿï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ éœ€æ±‚åˆ†æ

**åŠŸèƒ½éœ€æ±‚ï¼š**
1. å•†å“ç§’æ€æŠ¢è´­
2. åº“å­˜æ‰£å‡
3. è®¢å•ç”Ÿæˆ
4. é˜²æ­¢è¶…å–
5. é˜²æ­¢é‡å¤è´­ä¹°

**éåŠŸèƒ½éœ€æ±‚ï¼š**
- é«˜å¹¶å‘ï¼šç¬æ—¶QPS 10ä¸‡+
- é«˜å¯ç”¨ï¼šä¸èƒ½å®•æœº
- é˜²è¶…å–ï¼šåº“å­˜å¿…é¡»å‡†ç¡®
- é˜²åˆ·ï¼šä¸€äººä¸€å•

**æŒ‘æˆ˜ï¼š**
```
ç¬æ—¶æµé‡ï¼š
- æ­£å¸¸ï¼š1000 QPS
- ç§’æ€ï¼š100000 QPSï¼ˆ100å€æµé‡ï¼‰
- æŒç»­æ—¶é—´ï¼š1-2ç§’

æ•°æ®åº“å‹åŠ›ï¼š
- è¯»ï¼šæŸ¥è¯¢åº“å­˜ã€ç”¨æˆ·ä¿¡æ¯
- å†™ï¼šæ‰£å‡åº“å­˜ã€åˆ›å»ºè®¢å•
```

### âœ… æ¶æ„è®¾è®¡

#### æ•´ä½“æ¶æ„

```
å®¢æˆ·ç«¯ï¼ˆAPP/H5ï¼‰
    â†“
CDNï¼ˆé™æ€èµ„æºï¼‰
    â†“
Nginxï¼ˆé™æµã€è´Ÿè½½å‡è¡¡ï¼‰
    â†“
ç½‘å…³ï¼ˆè®¤è¯ã€é™æµã€é™çº§ï¼‰
    â†“
ç§’æ€æœåŠ¡ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
    â†“
Redisï¼ˆåº“å­˜ç¼“å­˜ã€é™æµï¼‰
    â†“
æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¼‚æ­¥ä¸‹å•ï¼‰
    â†“
è®¢å•æœåŠ¡ï¼ˆåˆ›å»ºè®¢å•ï¼‰
    â†“
MySQLï¼ˆæŒä¹…åŒ–ï¼‰
```

#### åˆ†å±‚é™æµ

```
               100ä¸‡è¯·æ±‚
                  â†“
ç¬¬1å±‚ï¼šCDNé™æ€é¡µé¢
                  â†“
               10ä¸‡è¯·æ±‚ï¼ˆ90%è¢«CDNæŒ¡ä½ï¼‰
                  â†“
ç¬¬2å±‚ï¼šNginxé™æµï¼ˆIPé™æµï¼‰
                  â†“
               5ä¸‡è¯·æ±‚ï¼ˆ50%è¢«é™æµï¼‰
                  â†“
ç¬¬3å±‚ï¼šç½‘å…³é™æµï¼ˆä»¤ç‰Œæ¡¶ï¼‰
                  â†“
               2ä¸‡è¯·æ±‚ï¼ˆ60%è¢«é™æµï¼‰
                  â†“
ç¬¬4å±‚ï¼šRedisé¢„æ‰£åº“å­˜
                  â†“
               1000è¯·æ±‚ï¼ˆ95%åº“å­˜ä¸è¶³ï¼‰
                  â†“
ç¬¬5å±‚ï¼šæ•°æ®åº“æ‰£åº“å­˜
```

### ğŸ’» æ ¸å¿ƒä»£ç å®ç°

#### æ–¹æ¡ˆ1ï¼šRedisé¢„å‡åº“å­˜ + æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥ä¸‹å•

**æµç¨‹å›¾ï¼š**
```
ç”¨æˆ·ç‚¹å‡»ç§’æ€
    â†“
RedisåŸå­æ‰£å‡åº“å­˜ï¼ˆDECRï¼‰
    â†“
æ‰£å‡æˆåŠŸï¼Ÿ
  â”œâ”€ æ˜¯ â†’ å‘é€MQæ¶ˆæ¯ â†’ å¼‚æ­¥åˆ›å»ºè®¢å• â†’ è¿”å›"æ’é˜Ÿä¸­"
  â””â”€ å¦ â†’ è¿”å›"åº“å­˜ä¸è¶³"
```

**ä»£ç å®ç°ï¼š**

```java
@Service
public class SeckillService {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    @Autowired
    private RabbitTemplate rabbitTemplate;

    /**
     * ç§’æ€æ¥å£
     */
    public SeckillResult seckill(Long productId, Long userId) {
        // 1. æ£€æŸ¥æ˜¯å¦å·²ç»ç§’æ€è¿‡ï¼ˆé˜²æ­¢é‡å¤è´­ä¹°ï¼‰
        String userKey = "seckill:user:" + productId + ":" + userId;
        Boolean hasOrdered = redisTemplate.opsForValue().setIfAbsent(
            userKey,
            "1",
            24,
            TimeUnit.HOURS
        );

        if (!hasOrdered) {
            return SeckillResult.fail("æ‚¨å·²ç»å‚ä¸è¿‡è¯¥å•†å“çš„ç§’æ€");
        }

        // 2. RedisåŸå­æ‰£å‡åº“å­˜
        String stockKey = "seckill:stock:" + productId;
        Long stock = redisTemplate.opsForValue().decrement(stockKey);

        if (stock < 0) {
            // åº“å­˜ä¸è¶³ï¼Œå›æ»šç”¨æˆ·è´­ä¹°è®°å½•
            redisTemplate.delete(userKey);
            return SeckillResult.fail("åº“å­˜ä¸è¶³");
        }

        // 3. å‘é€MQæ¶ˆæ¯ï¼Œå¼‚æ­¥åˆ›å»ºè®¢å•
        SeckillMessage message = new SeckillMessage(productId, userId);
        rabbitTemplate.convertAndSend("seckill.queue", message);

        return SeckillResult.success("æ’é˜Ÿä¸­ï¼Œè¯·ç¨åæŸ¥è¯¢è®¢å•");
    }

    /**
     * åˆå§‹åŒ–åº“å­˜åˆ°Redis
     */
    @PostConstruct
    public void initStock() {
        List<Product> products = productMapper.selectSeckillProducts();
        for (Product product : products) {
            String stockKey = "seckill:stock:" + product.getId();
            redisTemplate.opsForValue().set(
                stockKey,
                String.valueOf(product.getStock())
            );
        }
    }
}
```

**MQæ¶ˆè´¹è€…ï¼šå¼‚æ­¥åˆ›å»ºè®¢å•**

```java
@Component
public class SeckillConsumer {

    @Autowired
    private OrderService orderService;

    @RabbitListener(queues = "seckill.queue")
    public void handleSeckillOrder(SeckillMessage message) {
        try {
            // åˆ›å»ºè®¢å•
            orderService.createOrder(message.getProductId(), message.getUserId());
        } catch (Exception e) {
            log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
            // å›æ»šåº“å­˜
            rollbackStock(message.getProductId());
        }
    }

    private void rollbackStock(Long productId) {
        String stockKey = "seckill:stock:" + productId;
        redisTemplate.opsForValue().increment(stockKey);
    }
}
```

**è®¢å•æœåŠ¡ï¼šæ•°æ®åº“æ‰£åº“å­˜**

```java
@Service
public class OrderService {

    @Transactional(rollbackFor = Exception.class)
    public void createOrder(Long productId, Long userId) {
        // 1. æ•°æ®åº“æ‰£å‡åº“å­˜ï¼ˆé˜²æ­¢è¶…å–ï¼‰
        int rows = productMapper.decrStock(productId);
        if (rows == 0) {
            throw new StockNotEnoughException("åº“å­˜ä¸è¶³");
        }

        // 2. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setProductId(productId);
        order.setUserId(userId);
        order.setCreateTime(new Date());
        orderMapper.insert(order);
    }
}
```

**é˜²æ­¢è¶…å–çš„SQLï¼š**
```sql
-- âŒ é”™è¯¯åšæ³•ï¼šå…ˆæŸ¥åå‡
SELECT stock FROM product WHERE id = 100;  -- stock = 10
UPDATE product SET stock = 9 WHERE id = 100;  -- å¹¶å‘æ—¶ä¼šè¶…å–

-- âœ… æ­£ç¡®åšæ³•ï¼šä¹è§‚é”
UPDATE product
SET stock = stock - 1
WHERE id = 100
  AND stock > 0;  -- ä¿è¯ä¸ä¼šå‡åˆ°è´Ÿæ•°
```

#### æ–¹æ¡ˆ2ï¼šLuaè„šæœ¬åŸå­æ“ä½œ

**é—®é¢˜ï¼š** DECRå’ŒæŸ¥è¯¢ç”¨æˆ·æ˜¯å¦è´­ä¹°æ˜¯ä¸¤ä¸ªæ“ä½œï¼Œä¸æ˜¯åŸå­çš„

**è§£å†³ï¼š** ä½¿ç”¨Luaè„šæœ¬ï¼ŒRedisä¿è¯Luaè„šæœ¬çš„åŸå­æ€§

```lua
-- seckill.lua
local stockKey = KEYS[1]      -- seckill:stock:100
local userKey = KEYS[2]       -- seckill:user:100:1000
local ttl = ARGV[1]           -- 86400

-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è´­ä¹°
if redis.call('exists', userKey) == 1 then
    return -1  -- å·²ç»è´­ä¹°è¿‡
end

-- æ‰£å‡åº“å­˜
local stock = redis.call('decr', stockKey)
if stock < 0 then
    return -2  -- åº“å­˜ä¸è¶³
end

-- æ ‡è®°ç”¨æˆ·å·²è´­ä¹°
redis.call('setex', userKey, ttl, '1')

return stock  -- è¿”å›å‰©ä½™åº“å­˜
```

**Javaè°ƒç”¨ï¼š**
```java
public SeckillResult seckill(Long productId, Long userId) {
    String stockKey = "seckill:stock:" + productId;
    String userKey = "seckill:user:" + productId + ":" + userId;

    DefaultRedisScript<Long> script = new DefaultRedisScript<>();
    script.setScriptText(luaScript);
    script.setResultType(Long.class);

    Long result = redisTemplate.execute(
        script,
        Arrays.asList(stockKey, userKey),
        "86400"
    );

    if (result == -1) {
        return SeckillResult.fail("æ‚¨å·²ç»å‚ä¸è¿‡è¯¥å•†å“çš„ç§’æ€");
    } else if (result == -2) {
        return SeckillResult.fail("åº“å­˜ä¸è¶³");
    } else {
        // å‘é€MQæ¶ˆæ¯
        rabbitTemplate.convertAndSend("seckill.queue",
            new SeckillMessage(productId, userId));
        return SeckillResult.success("æ’é˜Ÿä¸­");
    }
}
```

### ğŸ”¥ è¿›é˜¶ä¼˜åŒ–

#### 1ï¸âƒ£ å‰ç«¯ä¼˜åŒ–

**é¡µé¢é™æ€åŒ–ï¼š**
```html
<!-- å•†å“è¯¦æƒ…é¡µé™æ€åŒ–ï¼Œæ”¾åˆ°CDN -->
<div id="product-info">
  <h1>iPhone 15 Pro Max</h1>
  <p>ä»·æ ¼ï¼š<span id="price">6999</span>å…ƒ</p>
  <p>åº“å­˜ï¼š<span id="stock">1000</span>å°</p>
  <button id="seckill-btn">ç«‹å³ç§’æ€</button>
</div>

<script>
// åŠ¨æ€æ•°æ®é€šè¿‡AJAXè·å–
fetch('/api/product/stock/100')
  .then(res => res.json())
  .then(data => {
    document.getElementById('stock').textContent = data.stock;
  });

// æŒ‰é’®é˜²æŠ–
let clicking = false;
document.getElementById('seckill-btn').onclick = function() {
  if (clicking) return;
  clicking = true;

  fetch('/api/seckill/100', {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      clicking = false;
    });
};
</script>
```

#### 2ï¸âƒ£ é™æµ

**Nginxé™æµï¼š**
```nginx
# é™åˆ¶æ¯ä¸ªIPæ¯ç§’æœ€å¤š10ä¸ªè¯·æ±‚
limit_req_zone $binary_remote_addr zone=seckill:10m rate=10r/s;

server {
    location /api/seckill {
        limit_req zone=seckill burst=20 nodelay;
        proxy_pass http://backend;
    }
}
```

**ä»¤ç‰Œæ¡¶é™æµï¼š**
```java
@Component
public class TokenBucketLimiter {
    private final RateLimiter rateLimiter = RateLimiter.create(10000);  // æ¯ç§’10000ä¸ªä»¤ç‰Œ

    public boolean tryAcquire() {
        return rateLimiter.tryAcquire(100, TimeUnit.MILLISECONDS);
    }
}

@GetMapping("/seckill/{productId}")
public Result seckill(@PathVariable Long productId) {
    if (!tokenBucketLimiter.tryAcquire()) {
        return Result.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
    }

    // ç§’æ€é€»è¾‘
    return seckillService.seckill(productId, userId);
}
```

#### 3ï¸âƒ£ åº“å­˜åˆ†æ®µ

**é—®é¢˜ï¼š** æ‰€æœ‰è¯·æ±‚éƒ½æ‰“åˆ°ä¸€ä¸ªRedis keyï¼Œå•ç‚¹ç“¶é¢ˆ

**è§£å†³ï¼š** åº“å­˜åˆ†æ®µï¼Œåˆ†æ•£å‹åŠ›

```java
// å°†1000ä¸ªåº“å­˜åˆ†ä¸º10æ®µï¼Œæ¯æ®µ100ä¸ª
seckill:stock:100:0 â†’ 100
seckill:stock:100:1 â†’ 100
...
seckill:stock:100:9 â†’ 100

// éšæœºé€‰æ‹©ä¸€ä¸ªåˆ†æ®µ
int segment = ThreadLocalRandom.current().nextInt(10);
String stockKey = "seckill:stock:" + productId + ":" + segment;
Long stock = redisTemplate.opsForValue().decrement(stockKey);
```

#### 4ï¸âƒ£ æ•°æ®åº“ä¼˜åŒ–

**è¯»å†™åˆ†ç¦»ï¼š**
```
å†™ï¼šä¸»åº“ï¼ˆæ‰£å‡åº“å­˜ã€åˆ›å»ºè®¢å•ï¼‰
è¯»ï¼šä»åº“ï¼ˆæŸ¥è¯¢è®¢å•ã€æŸ¥è¯¢åº“å­˜ï¼‰
```

**æ‰¹é‡æ’å…¥è®¢å•ï¼š**
```java
// ä¸è¦ä¸€æ¡ä¸€æ¡æ’å…¥
// âŒ for (Order order : orders) { insert(order); }

// âœ… æ‰¹é‡æ’å…¥
<insert id="batchInsert" parameterType="list">
  INSERT INTO orders (product_id, user_id, create_time) VALUES
  <foreach collection="list" item="item" separator=",">
    (#{item.productId}, #{item.userId}, #{item.createTime})
  </foreach>
</insert>
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ¶æ„ã€‘
åˆ†å±‚é™æµ + Redisé¢„å‡åº“å­˜ + MQå¼‚æ­¥ä¸‹å•

ã€æ ¸å¿ƒæµç¨‹ã€‘
1. CDNé™æ€é¡µé¢ï¼Œå‡å°‘90%æµé‡
2. Nginxé™æµï¼Œæ¯IPæ¯ç§’10è¯·æ±‚
3. ç½‘å…³ä»¤ç‰Œæ¡¶é™æµï¼ŒQPS 1ä¸‡
4. Redis Luaè„šæœ¬åŸå­æ‰£åº“å­˜
5. æ‰£å‡æˆåŠŸå‘MQï¼Œå¼‚æ­¥åˆ›å»ºè®¢å•
6. æ•°æ®åº“ä¹è§‚é”é˜²æ­¢è¶…å–

ã€é˜²è¶…å–ã€‘
1. Redis DECRåŸå­æ‰£å‡
2. æ•°æ®åº“UPDATE WHERE stock > 0
3. ä¸¤å±‚ä¿éšœï¼Œä¸ä¼šè¶…å–

ã€é˜²é‡å¤è´­ä¹°ã€‘
1. Redis SETNXè®°å½•ç”¨æˆ·è´­ä¹°
2. Luaè„šæœ¬ä¿è¯åŸå­æ€§

ã€ä¼˜åŒ–ã€‘
1. åº“å­˜åˆ†æ®µï¼Œåˆ†æ•£å‹åŠ›
2. é¡µé¢é™æ€åŒ–åˆ°CDN
3. è¯»å†™åˆ†ç¦»
4. æ‰¹é‡æ’å…¥è®¢å•
```

---

## ğŸ“Œ çŸ­é“¾æ¥ç³»ç»Ÿï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ éœ€æ±‚åˆ†æ

**åŠŸèƒ½éœ€æ±‚ï¼š**
1. é•¿é“¾æ¥è½¬çŸ­é“¾æ¥
2. çŸ­é“¾æ¥è·³è½¬åˆ°é•¿é“¾æ¥
3. ç»Ÿè®¡ç‚¹å‡»æ¬¡æ•°
4. é“¾æ¥è¿‡æœŸæ—¶é—´

**éåŠŸèƒ½éœ€æ±‚ï¼š**
- é«˜å¹¶å‘ï¼šQPS 10ä¸‡+
- çŸ­é“¾æ¥å°½å¯èƒ½çŸ­
- å…¨å±€å”¯ä¸€
- ä¸å¯é¢„æµ‹ï¼ˆå®‰å…¨æ€§ï¼‰

**ç¤ºä¾‹ï¼š**
```
é•¿é“¾æ¥ï¼š
https://www.example.com/product/detail?id=123456&category=electronics&from=homepage

çŸ­é“¾æ¥ï¼š
https://short.url/abc123
```

### âœ… è®¾è®¡æ–¹æ¡ˆ

#### æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•ç”ŸæˆçŸ­é“¾æ¥ï¼Ÿ

**æ–¹æ¡ˆå¯¹æ¯”ï¼š**

| æ–¹æ¡ˆ | é•¿åº¦ | å”¯ä¸€æ€§ | å¯é¢„æµ‹æ€§ | å¤æ‚åº¦ |
|------|------|--------|---------|--------|
| **è‡ªå¢ID** | çŸ­ | âœ… | âŒ å®¹æ˜“é¢„æµ‹ | ç®€å• |
| **Hash** | å›ºå®š | âš ï¸ æœ‰ç¢°æ’ | âœ… | ä¸­ç­‰ |
| **éšæœºå­—ç¬¦ä¸²** | å¯æ§ | âš ï¸ éœ€æ£€æŸ¥ | âœ… | ç®€å• |
| **é›ªèŠ±ç®—æ³•** | è¾ƒé•¿ | âœ… | âš ï¸ | ä¸­ç­‰ |

#### æ–¹æ¡ˆ1ï¼šè‡ªå¢ID + Base62ç¼–ç ï¼ˆâœ… æ¨èï¼‰

**åŸç†ï¼š**
```
1. ä½¿ç”¨MySQLè‡ªå¢IDæˆ–Redis INCRç”Ÿæˆå”¯ä¸€ID
2. å°†IDè½¬æ¢ä¸ºBase62ç¼–ç ï¼ˆ0-9, a-z, A-Zï¼‰

ç¤ºä¾‹ï¼š
ID=1 â†’ 1
ID=62 â†’ 10
ID=3844 â†’ aa
ID=238328 â†’ abc123
```

**Base62ç¼–ç ï¼š**
```java
public class Base62 {
    private static final String ALPHABET = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private static final int BASE = ALPHABET.length();

    /**
     * å°†æ•°å­—è½¬æ¢ä¸ºBase62
     */
    public static String encode(long num) {
        if (num == 0) return "0";

        StringBuilder sb = new StringBuilder();
        while (num > 0) {
            sb.append(ALPHABET.charAt((int)(num % BASE)));
            num /= BASE;
        }
        return sb.reverse().toString();
    }

    /**
     * å°†Base62è½¬æ¢ä¸ºæ•°å­—
     */
    public static long decode(String str) {
        long num = 0;
        for (char c : str.toCharArray()) {
            num = num * BASE + ALPHABET.indexOf(c);
        }
        return num;
    }
}

// æµ‹è¯•
Base62.encode(1);       // "1"
Base62.encode(62);      // "10"
Base62.encode(238328);  // "W7c"
Base62.decode("W7c");   // 238328
```

**çŸ­é“¾æ¥é•¿åº¦åˆ†æï¼š**
```
Base62: 62^n ç§ç»„åˆ

n=6: 62^6 = 568äº¿ï¼ˆè¶³å¤Ÿç”¨ï¼‰
n=7: 62^7 = 3.5ä¸‡äº¿

ç»“è®ºï¼š6ä½çŸ­ç å¯ä»¥æ”¯æŒ568äº¿æ¡è®°å½•
```

**å®ç°ä»£ç ï¼š**

```java
@Service
public class ShortUrlService {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    @Autowired
    private ShortUrlMapper shortUrlMapper;

    private static final String SHORT_URL_PREFIX = "https://short.url/";
    private static final String ID_KEY = "short:url:id";

    /**
     * ç”ŸæˆçŸ­é“¾æ¥
     */
    public String generateShortUrl(String longUrl) {
        // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¹‚ç­‰æ€§ï¼‰
        String cached = redisTemplate.opsForValue().get("long:" + longUrl);
        if (cached != null) {
            return SHORT_URL_PREFIX + cached;
        }

        // 2. ç”Ÿæˆå”¯ä¸€ID
        Long id = redisTemplate.opsForValue().increment(ID_KEY);

        // 3. Base62ç¼–ç 
        String shortCode = Base62.encode(id);

        // 4. å­˜å‚¨åˆ°Redis
        redisTemplate.opsForValue().set("short:" + shortCode, longUrl);
        redisTemplate.opsForValue().set("long:" + longUrl, shortCode);

        // 5. å¼‚æ­¥å­˜å‚¨åˆ°æ•°æ®åº“
        asyncSaveToDb(id, shortCode, longUrl);

        return SHORT_URL_PREFIX + shortCode;
    }

    /**
     * çŸ­é“¾æ¥è·³è½¬
     */
    public String redirect(String shortCode) {
        // 1. ä»RedisæŸ¥è¯¢
        String longUrl = redisTemplate.opsForValue().get("short:" + shortCode);

        if (longUrl == null) {
            // 2. Redisç¼“å­˜missï¼ŒæŸ¥è¯¢æ•°æ®åº“
            Long id = Base62.decode(shortCode);
            ShortUrl entity = shortUrlMapper.selectById(id);

            if (entity == null) {
                throw new NotFoundException("çŸ­é“¾æ¥ä¸å­˜åœ¨");
            }

            longUrl = entity.getLongUrl();

            // 3. å›å†™Redis
            redisTemplate.opsForValue().set(
                "short:" + shortCode,
                longUrl,
                7,
                TimeUnit.DAYS
            );
        }

        // 4. å¼‚æ­¥ç»Ÿè®¡ç‚¹å‡»æ¬¡æ•°
        asyncIncrClickCount(shortCode);

        return longUrl;
    }

    /**
     * ç»Ÿè®¡ç‚¹å‡»æ¬¡æ•°
     */
    private void asyncIncrClickCount(String shortCode) {
        CompletableFuture.runAsync(() -> {
            redisTemplate.opsForValue().increment("click:" + shortCode);
        });
    }
}
```

**æ•°æ®åº“è®¾è®¡ï¼š**
```sql
CREATE TABLE short_url (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    short_code VARCHAR(10) NOT NULL UNIQUE,
    long_url VARCHAR(2048) NOT NULL,
    click_count BIGINT DEFAULT 0,
    expire_time DATETIME,
    create_time DATETIME NOT NULL,
    INDEX idx_short_code (short_code),
    INDEX idx_create_time (create_time)
);
```

#### æ–¹æ¡ˆ2ï¼šHash + å†²çªæ£€æµ‹

**å®ç°ï¼š**
```java
public String generateShortUrl(String longUrl) {
    // 1. MD5 hash
    String md5 = DigestUtils.md5Hex(longUrl);

    // 2. å–å‰6ä½
    String shortCode = md5.substring(0, 6);

    // 3. æ£€æŸ¥å†²çª
    String existing = redisTemplate.opsForValue().get("short:" + shortCode);
    if (existing != null && !existing.equals(longUrl)) {
        // å†²çªï¼Œé‡æ–°hashæˆ–å–å…¶ä»–ä½
        shortCode = md5.substring(6, 12);
    }

    // 4. å­˜å‚¨
    redisTemplate.opsForValue().set("short:" + shortCode, longUrl);

    return SHORT_URL_PREFIX + shortCode;
}
```

**ä¼˜ç¼ºç‚¹ï¼š**
- âœ… ç›¸åŒURLç”Ÿæˆç›¸åŒçŸ­ç ï¼ˆå¤©ç„¶å»é‡ï¼‰
- âŒ å­˜åœ¨å“ˆå¸Œç¢°æ’
- âŒ éœ€è¦é¢å¤–çš„å†²çªæ£€æµ‹é€»è¾‘

### ğŸ”¥ è¿›é˜¶ä¼˜åŒ–

#### 1ï¸âƒ£ å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆé˜²æ­¢ç¼“å­˜ç©¿é€ï¼‰

```java
@Component
public class BloomFilterService {
    private BloomFilter<String> bloomFilter = BloomFilter.create(
        Funnels.stringFunnel(Charset.defaultCharset()),
        100000000,  // é¢„è®¡å…ƒç´ æ•°é‡1äº¿
        0.001       // è¯¯åˆ¤ç‡0.1%
    );

    public void add(String shortCode) {
        bloomFilter.put(shortCode);
    }

    public boolean mightContain(String shortCode) {
        return bloomFilter.mightContain(shortCode);
    }
}

public String redirect(String shortCode) {
    // 1. å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­
    if (!bloomFilterService.mightContain(shortCode)) {
        throw new NotFoundException("çŸ­é“¾æ¥ä¸å­˜åœ¨");
    }

    // 2. æŸ¥è¯¢Redis
    // ...
}
```

#### 2ï¸âƒ£ é™æµé˜²åˆ·

```java
@GetMapping("/{shortCode}")
@RateLimiter(qps = 100, timeout = 500)  // è‡ªå®šä¹‰æ³¨è§£
public void redirect(@PathVariable String shortCode, HttpServletResponse response) {
    String longUrl = shortUrlService.redirect(shortCode);
    response.sendRedirect(longUrl);
}
```

#### 3ï¸âƒ£ è¿‡æœŸæ—¶é—´

```java
public String generateShortUrl(String longUrl, Integer expireDays) {
    Long id = redisTemplate.opsForValue().increment(ID_KEY);
    String shortCode = Base62.encode(id);

    // è®¾ç½®è¿‡æœŸæ—¶é—´
    if (expireDays != null) {
        redisTemplate.opsForValue().set(
            "short:" + shortCode,
            longUrl,
            expireDays,
            TimeUnit.DAYS
        );
    } else {
        redisTemplate.opsForValue().set("short:" + shortCode, longUrl);
    }

    return SHORT_URL_PREFIX + shortCode;
}
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ–¹æ¡ˆã€‘
è‡ªå¢ID + Base62ç¼–ç 

ã€æµç¨‹ã€‘
ç”ŸæˆçŸ­é“¾æ¥ï¼š
1. Redis INCRç”Ÿæˆå…¨å±€å”¯ä¸€ID
2. Base62ç¼–ç ï¼ˆ0-9a-zA-Zï¼‰
3. å­˜å‚¨æ˜ å°„å…³ç³»åˆ°Redis
4. å¼‚æ­¥æŒä¹…åŒ–åˆ°MySQL

è·³è½¬ï¼š
1. æ ¹æ®shortCodeæŸ¥è¯¢Redis
2. ç¼“å­˜missæŸ¥è¯¢MySQL
3. å›å†™Redis
4. 302é‡å®šå‘
5. å¼‚æ­¥ç»Ÿè®¡ç‚¹å‡»æ¬¡æ•°

ã€å®¹é‡ã€‘
Base62çš„6ä½çŸ­ç ï¼š62^6 = 568äº¿

ã€ä¼˜åŒ–ã€‘
1. å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€
2. Redisç¼“å­˜ï¼Œ7å¤©è¿‡æœŸ
3. é™æµé˜²åˆ·
4. è¯»å†™åˆ†ç¦»

ã€æ‰©å±•ã€‘
æ”¯æŒè‡ªå®šä¹‰çŸ­ç ã€è¿‡æœŸæ—¶é—´ã€è®¿é—®ç»Ÿè®¡
```

---

## ğŸ“Œ æŠ¢çº¢åŒ…ç³»ç»Ÿï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ éœ€æ±‚åˆ†æ

**åŠŸèƒ½éœ€æ±‚ï¼š**
1. å‘çº¢åŒ…ï¼ˆæ€»é‡‘é¢ã€ä¸ªæ•°ï¼‰
2. æŠ¢çº¢åŒ…
3. æŸ¥çœ‹çº¢åŒ…è¯¦æƒ…
4. é˜²æ­¢è¶…æŠ¢ï¼ˆçº¢åŒ…ä¸ªæ•°æœ‰é™ï¼‰

**éåŠŸèƒ½éœ€æ±‚ï¼š**
- é«˜å¹¶å‘ï¼šç¬æ—¶10ä¸‡+äººæŠ¢
- é‡‘é¢å‡†ç¡®ï¼šæ€»é‡‘é¢å¿…é¡»ç­‰äºæ‰€æœ‰çº¢åŒ…ä¹‹å’Œ
- éšæœºæ€§ï¼šæ¯ä¸ªçº¢åŒ…é‡‘é¢éšæœº
- å…¬å¹³æ€§ï¼šå…ˆæŠ¢ä¸ä¸€å®šé‡‘é¢å¤§

**ç¤ºä¾‹ï¼š**
```
å‘çº¢åŒ…ï¼š100å…ƒå‘10ä¸ªçº¢åŒ…
å¯èƒ½çš„åˆ†é…ï¼š
ç”¨æˆ·Aï¼š15.23å…ƒ
ç”¨æˆ·Bï¼š8.76å…ƒ
ç”¨æˆ·Cï¼š12.45å…ƒ
...
ç”¨æˆ·Jï¼š9.87å…ƒ
æ€»å’Œï¼š100.00å…ƒ
```

### âœ… æ ¸å¿ƒç®—æ³•ï¼šäºŒå€å‡å€¼æ³•

**åŸç†ï¼š**
```
å‰©ä½™é‡‘é¢ï¼šMå…ƒ
å‰©ä½™ä¸ªæ•°ï¼šNä¸ª
å½“å‰çº¢åŒ…é‡‘é¢ï¼šrandom(0.01, M/N * 2)

ä¿è¯ï¼š
1. æ¯ä¸ªçº¢åŒ…è‡³å°‘0.01å…ƒ
2. å¹³å‡æ¯ä¸ªçº¢åŒ… M/N å…ƒ
3. æœ€åä¸€ä¸ªçº¢åŒ…å¿…å®šèƒ½åˆ†é…å®Œ

ç¤ºä¾‹ï¼š100å…ƒ10ä¸ªçº¢åŒ…
ç¬¬1ä¸ªï¼šrandom(0.01, 100/10*2) = random(0.01, 20) = 15å…ƒï¼Œå‰©ä½™85å…ƒ9ä¸ª
ç¬¬2ä¸ªï¼šrandom(0.01, 85/9*2) = random(0.01, 18.89) = 10å…ƒï¼Œå‰©ä½™75å…ƒ8ä¸ª
...
ç¬¬10ä¸ªï¼šå‰©ä½™é‡‘é¢ç›´æ¥åˆ†é…
```

**ä»£ç å®ç°ï¼š**
```java
public class RedPacketAlgorithm {

    /**
     * äºŒå€å‡å€¼æ³•ç”Ÿæˆçº¢åŒ…é‡‘é¢åˆ—è¡¨
     * @param totalAmount æ€»é‡‘é¢ï¼ˆåˆ†ï¼‰
     * @param count çº¢åŒ…ä¸ªæ•°
     * @return çº¢åŒ…é‡‘é¢åˆ—è¡¨ï¼ˆåˆ†ï¼‰
     */
    public static List<Long> generateRedPackets(long totalAmount, int count) {
        List<Long> result = new ArrayList<>();
        long remainAmount = totalAmount;
        int remainCount = count;

        Random random = new Random();

        for (int i = 0; i < count - 1; i++) {
            // å½“å‰çº¢åŒ…çš„æœ€å¤§é‡‘é¢ï¼šå‰©ä½™é‡‘é¢çš„2å€å‡å€¼
            long maxAmount = remainAmount / remainCount * 2;

            // éšæœºé‡‘é¢ï¼š1åˆ† ~ maxAmount
            long amount = (long) (random.nextDouble() * (maxAmount - 1)) + 1;

            result.add(amount);
            remainAmount -= amount;
            remainCount--;
        }

        // æœ€åä¸€ä¸ªçº¢åŒ…ï¼šå‰©ä½™å…¨éƒ¨é‡‘é¢
        result.add(remainAmount);

        return result;
    }

    // æµ‹è¯•
    public static void main(String[] args) {
        List<Long> packets = generateRedPackets(10000, 10);  // 100å…ƒ10ä¸ª
        long sum = packets.stream().mapToLong(Long::valueOf).sum();

        System.out.println("çº¢åŒ…é‡‘é¢åˆ†é…ï¼š");
        for (int i = 0; i < packets.size(); i++) {
            System.out.printf("ç¬¬%dä¸ªï¼š%.2få…ƒ\n", i + 1, packets.get(i) / 100.0);
        }
        System.out.printf("æ€»å’Œï¼š%.2få…ƒ\n", sum / 100.0);
    }
}
```

### ğŸ’» ç³»ç»Ÿè®¾è®¡

#### æ–¹æ¡ˆ1ï¼šé¢„ç”Ÿæˆçº¢åŒ…é‡‘é¢ï¼ˆæ¨èï¼‰

**æµç¨‹ï¼š**
```
å‘çº¢åŒ…ï¼š
1. è°ƒç”¨äºŒå€å‡å€¼ç®—æ³•ç”Ÿæˆæ‰€æœ‰çº¢åŒ…é‡‘é¢
2. å­˜å‚¨åˆ°Redis Listä¸­
3. è¿”å›çº¢åŒ…ID

æŠ¢çº¢åŒ…ï¼š
4. Redis RPOPåŸå­å¼¹å‡ºä¸€ä¸ªé‡‘é¢
5. å¼¹å‡ºæˆåŠŸï¼šè·å¾—çº¢åŒ…
6. å¼¹å‡ºå¤±è´¥ï¼šçº¢åŒ…å·²æŠ¢å®Œ
```

**ä»£ç å®ç°ï¼š**

```java
@Service
public class RedPacketService {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    /**
     * å‘çº¢åŒ…
     */
    public String sendRedPacket(long totalAmount, int count, long userId) {
        // 1. ç”Ÿæˆçº¢åŒ…ID
        String redPacketId = UUID.randomUUID().toString();

        // 2. äºŒå€å‡å€¼æ³•ç”Ÿæˆçº¢åŒ…é‡‘é¢
        List<Long> amounts = RedPacketAlgorithm.generateRedPackets(totalAmount, count);

        // 3. å­˜å‚¨åˆ°Redis List
        String key = "redpacket:" + redPacketId;
        for (Long amount : amounts) {
            redisTemplate.opsForList().leftPush(key, String.valueOf(amount));
        }

        // 4. è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶ï¼‰
        redisTemplate.expire(key, 24, TimeUnit.HOURS);

        // 5. å­˜å‚¨çº¢åŒ…ä¿¡æ¯
        RedPacket redPacket = new RedPacket();
        redPacket.setId(redPacketId);
        redPacket.setUserId(userId);
        redPacket.setTotalAmount(totalAmount);
        redPacket.setCount(count);
        redPacket.setCreateTime(new Date());

        String infoKey = "redpacket:info:" + redPacketId;
        redisTemplate.opsForValue().set(infoKey, JSON.toJSONString(redPacket));

        return redPacketId;
    }

    /**
     * æŠ¢çº¢åŒ…
     */
    public RedPacketResult grabRedPacket(String redPacketId, long userId) {
        // 1. æ£€æŸ¥æ˜¯å¦å·²ç»æŠ¢è¿‡
        String grabKey = "redpacket:grab:" + redPacketId + ":" + userId;
        Boolean grabbed = redisTemplate.opsForValue().setIfAbsent(
            grabKey,
            "1",
            24,
            TimeUnit.HOURS
        );

        if (!grabbed) {
            return RedPacketResult.fail("æ‚¨å·²ç»æŠ¢è¿‡è¯¥çº¢åŒ…");
        }

        // 2. RPOPå¼¹å‡ºä¸€ä¸ªçº¢åŒ…é‡‘é¢
        String key = "redpacket:" + redPacketId;
        String amountStr = redisTemplate.opsForList().rightPop(key);

        if (amountStr == null) {
            // çº¢åŒ…å·²æŠ¢å®Œï¼Œåˆ é™¤æŠ¢è¿‡è®°å½•
            redisTemplate.delete(grabKey);
            return RedPacketResult.fail("çº¢åŒ…å·²æŠ¢å®Œ");
        }

        long amount = Long.parseLong(amountStr);

        // 3. è®°å½•æŠ¢çº¢åŒ…è®°å½•
        RedPacketRecord record = new RedPacketRecord();
        record.setRedPacketId(redPacketId);
        record.setUserId(userId);
        record.setAmount(amount);
        record.setCreateTime(new Date());

        // å¼‚æ­¥å­˜å‚¨åˆ°æ•°æ®åº“
        asyncSaveRecord(record);

        return RedPacketResult.success(amount);
    }

    /**
     * æŸ¥è¯¢çº¢åŒ…è¯¦æƒ…
     */
    public RedPacketDetail getDetail(String redPacketId) {
        String infoKey = "redpacket:info:" + redPacketId;
        String info = redisTemplate.opsForValue().get(infoKey);

        if (info == null) {
            return null;
        }

        RedPacket redPacket = JSON.parseObject(info, RedPacket.class);

        // æŸ¥è¯¢å‰©ä½™ä¸ªæ•°
        String key = "redpacket:" + redPacketId;
        Long remainCount = redisTemplate.opsForList().size(key);

        RedPacketDetail detail = new RedPacketDetail();
        detail.setRedPacket(redPacket);
        detail.setRemainCount(remainCount.intValue());
        detail.setGrabbedCount(redPacket.getCount() - remainCount.intValue());

        return detail;
    }
}
```

#### æ–¹æ¡ˆ2ï¼šLuaè„šæœ¬åŸå­æŠ¢çº¢åŒ…

**é—®é¢˜ï¼š** æ£€æŸ¥æ˜¯å¦æŠ¢è¿‡ + å¼¹å‡ºé‡‘é¢ï¼Œä¸æ˜¯åŸå­æ“ä½œ

**è§£å†³ï¼š** Luaè„šæœ¬ä¿è¯åŸå­æ€§

```lua
-- grab_redpacket.lua
local redPacketKey = KEYS[1]    -- redpacket:xxx
local grabKey = KEYS[2]         -- redpacket:grab:xxx:userId
local ttl = ARGV[1]             -- 86400

-- æ£€æŸ¥æ˜¯å¦å·²æŠ¢è¿‡
if redis.call('exists', grabKey) == 1 then
    return '-1'  -- å·²ç»æŠ¢è¿‡
end

-- å¼¹å‡ºçº¢åŒ…é‡‘é¢
local amount = redis.call('rpop', redPacketKey)
if not amount then
    return '-2'  -- çº¢åŒ…å·²æŠ¢å®Œ
end

-- æ ‡è®°å·²æŠ¢è¿‡
redis.call('setex', grabKey, ttl, '1')

return amount  -- è¿”å›é‡‘é¢
```

**Javaè°ƒç”¨ï¼š**
```java
public RedPacketResult grabRedPacket(String redPacketId, long userId) {
    String redPacketKey = "redpacket:" + redPacketId;
    String grabKey = "redpacket:grab:" + redPacketId + ":" + userId;

    DefaultRedisScript<String> script = new DefaultRedisScript<>();
    script.setScriptText(luaScript);
    script.setResultType(String.class);

    String result = redisTemplate.execute(
        script,
        Arrays.asList(redPacketKey, grabKey),
        "86400"
    );

    if ("-1".equals(result)) {
        return RedPacketResult.fail("æ‚¨å·²ç»æŠ¢è¿‡è¯¥çº¢åŒ…");
    } else if ("-2".equals(result)) {
        return RedPacketResult.fail("çº¢åŒ…å·²æŠ¢å®Œ");
    } else {
        long amount = Long.parseLong(result);
        // å¼‚æ­¥è®°å½•
        asyncSaveRecord(redPacketId, userId, amount);
        return RedPacketResult.success(amount);
    }
}
```

### ğŸ”¥ ä¼˜åŒ–æ–¹æ¡ˆ

#### 1ï¸âƒ£ åˆ†å¸ƒå¼çº¢åŒ…ï¼ˆç™¾ä¸‡ç”¨æˆ·æŠ¢ï¼‰

**é—®é¢˜ï¼š** å•ä¸ªRedis Listï¼ŒQPSå—é™

**è§£å†³ï¼š** åˆ†æ®µå­˜å‚¨

```java
// 100ä¸ªçº¢åŒ…åˆ†ä¸º10æ®µï¼Œæ¯æ®µ10ä¸ª
for (int i = 0; i < 10; i++) {
    String segmentKey = "redpacket:" + redPacketId + ":segment:" + i;
    List<Long> segment = amounts.subList(i * 10, (i + 1) * 10);
    for (Long amount : segment) {
        redisTemplate.opsForList().leftPush(segmentKey, String.valueOf(amount));
    }
}

// æŠ¢çº¢åŒ…æ—¶éšæœºé€‰æ‹©ä¸€ä¸ªåˆ†æ®µ
int segment = ThreadLocalRandom.current().nextInt(10);
String key = "redpacket:" + redPacketId + ":segment:" + segment;
String amount = redisTemplate.opsForList().rightPop(key);
```

#### 2ï¸âƒ£ æ•°æ®åº“è®¾è®¡

```sql
-- çº¢åŒ…è¡¨
CREATE TABLE red_packet (
    id VARCHAR(64) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    total_amount BIGINT NOT NULL COMMENT 'æ€»é‡‘é¢ï¼ˆåˆ†ï¼‰',
    count INT NOT NULL COMMENT 'çº¢åŒ…ä¸ªæ•°',
    create_time DATETIME NOT NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_create_time (create_time)
);

-- æŠ¢çº¢åŒ…è®°å½•è¡¨
CREATE TABLE red_packet_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    red_packet_id VARCHAR(64) NOT NULL,
    user_id BIGINT NOT NULL,
    amount BIGINT NOT NULL COMMENT 'é‡‘é¢ï¼ˆåˆ†ï¼‰',
    create_time DATETIME NOT NULL,
    INDEX idx_red_packet_id (red_packet_id),
    INDEX idx_user_id (user_id),
    UNIQUE KEY uk_red_packet_user (red_packet_id, user_id)
);
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€ç®—æ³•ã€‘
äºŒå€å‡å€¼æ³•ï¼š
- å½“å‰çº¢åŒ…é‡‘é¢ = random(0.01, å‰©ä½™é‡‘é¢/å‰©ä½™ä¸ªæ•° * 2)
- ä¿è¯å…¬å¹³æ€§å’Œéšæœºæ€§
- æ€»é‡‘é¢ç²¾ç¡®ä¸å·®

ã€æµç¨‹ã€‘
å‘çº¢åŒ…ï¼š
1. äºŒå€å‡å€¼æ³•ç”Ÿæˆæ‰€æœ‰é‡‘é¢
2. å­˜å…¥Redis List
3. è¿”å›çº¢åŒ…ID

æŠ¢çº¢åŒ…ï¼š
1. Luaè„šæœ¬åŸå­æ“ä½œ
2. æ£€æŸ¥æ˜¯å¦å·²æŠ¢è¿‡
3. RPOPå¼¹å‡ºé‡‘é¢
4. æ ‡è®°å·²æŠ¢è¿‡
5. å¼‚æ­¥è®°å½•åˆ°æ•°æ®åº“

ã€é˜²æ­¢è¶…æŠ¢ã€‘
1. Redis Listå¤©ç„¶ä¿è¯ä¸ä¼šè¶…æŠ¢
2. RPOPåŸå­æ“ä½œ
3. æ£€æŸ¥æ˜¯å¦å·²æŠ¢è¿‡ï¼ˆä¸€äººä¸€æ¬¡ï¼‰

ã€ä¼˜åŒ–ã€‘
1. åˆ†æ®µå­˜å‚¨ï¼Œåˆ†æ•£å‹åŠ›
2. Luaè„šæœ¬ä¿è¯åŸå­æ€§
3. å¼‚æ­¥æŒä¹…åŒ–åˆ°MySQL
```

---

## ğŸ“Œ å»¶æ—¶é˜Ÿåˆ—ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ éœ€æ±‚åˆ†æ

**åº”ç”¨åœºæ™¯ï¼š**
1. è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼ˆä¸‹å•30åˆ†é’Ÿæœªæ”¯ä»˜ï¼‰
2. å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©8ç‚¹å‘é€é€šçŸ¥ï¼‰
3. å»¶è¿Ÿé‡è¯•ï¼ˆå¤±è´¥å5åˆ†é’Ÿé‡è¯•ï¼‰
4. ä¼šå‘˜åˆ°æœŸæé†’ï¼ˆåˆ°æœŸå‰3å¤©æé†’ï¼‰

**åŠŸèƒ½éœ€æ±‚ï¼š**
- æ”¯æŒä»»æ„æ—¶é—´çš„å»¶è¿Ÿ
- é«˜å¯é ï¼ˆä»»åŠ¡ä¸èƒ½ä¸¢å¤±ï¼‰
- é«˜å¯ç”¨ï¼ˆæœåŠ¡ä¸èƒ½æŒ‚ï¼‰
- ç²¾ç¡®è§¦å‘ï¼ˆè¯¯å·®<1ç§’ï¼‰

### âœ… æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **å®šæ—¶è½®è¯¢DB** | ç®€å• | æµªè´¹èµ„æºï¼Œå»¶è¿Ÿé«˜ | å°é¡¹ç›® |
| **JDK DelayQueue** | ç®€å• | å•æœºï¼Œæ•°æ®æ˜“ä¸¢å¤± | æµ‹è¯• |
| **RabbitMQå»¶è¿Ÿæ’ä»¶** | åŠŸèƒ½å®Œå–„ | ä¾èµ–MQ | ä¸­å°é¡¹ç›® |
| **Redis ZSet** | é«˜æ€§èƒ½ï¼Œç®€å• | éœ€è‡ªå·±å®ç° | âœ… æ¨è |
| **æ—¶é—´è½®** | é«˜æ€§èƒ½ | å®ç°å¤æ‚ | å¤§å‹é¡¹ç›® |

### ğŸ’» æ–¹æ¡ˆ1ï¼šRedis ZSetå®ç°ï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ€è·¯ï¼š**
```
ZSetï¼š
- memberï¼šä»»åŠ¡ID
- scoreï¼šæ‰§è¡Œæ—¶é—´æˆ³

æ‰«æï¼š
æ¯ç§’æ‰«æ score <= å½“å‰æ—¶é—´ çš„ä»»åŠ¡å¹¶æ‰§è¡Œ
```

**å®ç°ä»£ç ï¼š**

```java
@Component
public class DelayQueue {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    private static final String DELAY_QUEUE_KEY = "delay:queue";

    /**
     * æ·»åŠ å»¶æ—¶ä»»åŠ¡
     * @param taskId ä»»åŠ¡ID
     * @param delaySeconds å»¶è¿Ÿç§’æ•°
     */
    public void addTask(String taskId, long delaySeconds) {
        long executeTime = System.currentTimeMillis() + delaySeconds * 1000;

        redisTemplate.opsForZSet().add(
            DELAY_QUEUE_KEY,
            taskId,
            executeTime
        );
    }

    /**
     * æ‰«æå¹¶æ‰§è¡Œåˆ°æœŸä»»åŠ¡
     */
    @Scheduled(fixedDelay = 1000)  // æ¯ç§’æ‰§è¡Œä¸€æ¬¡
    public void scan() {
        long now = System.currentTimeMillis();

        // æŸ¥è¯¢ score <= now çš„ä»»åŠ¡
        Set<String> tasks = redisTemplate.opsForZSet().rangeByScore(
            DELAY_QUEUE_KEY,
            0,
            now,
            0,
            100  // æ¯æ¬¡æœ€å¤šå–100ä¸ª
        );

        if (tasks == null || tasks.isEmpty()) {
            return;
        }

        for (String taskId : tasks) {
            // å°è¯•åˆ é™¤ä»»åŠ¡ï¼ˆé˜²æ­¢é‡å¤æ‰§è¡Œï¼‰
            Long removed = redisTemplate.opsForZSet().remove(DELAY_QUEUE_KEY, taskId);

            if (removed != null && removed > 0) {
                // åˆ é™¤æˆåŠŸï¼Œæ‰§è¡Œä»»åŠ¡
                executeTask(taskId);
            }
        }
    }

    /**
     * æ‰§è¡Œä»»åŠ¡
     */
    private void executeTask(String taskId) {
        try {
            // æ ¹æ®taskIdè·å–ä»»åŠ¡è¯¦æƒ…å¹¶æ‰§è¡Œ
            log.info("æ‰§è¡Œä»»åŠ¡ï¼š{}", taskId);

            // å®é™…ä¸šåŠ¡é€»è¾‘
            // ...

        } catch (Exception e) {
            log.error("ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼š{}", taskId, e);
            // å¤±è´¥é‡è¯•ï¼šé‡æ–°åŠ å…¥é˜Ÿåˆ—
            addTask(taskId, 60);  // 60ç§’åé‡è¯•
        }
    }
}
```

**Luaè„šæœ¬ä¼˜åŒ–ï¼ˆåŸå­æ“ä½œï¼‰ï¼š**

```lua
-- scan_and_execute.lua
local queueKey = KEYS[1]
local now = ARGV[1]
local limit = ARGV[2]

-- æŸ¥è¯¢åˆ°æœŸä»»åŠ¡
local tasks = redis.call('ZRANGEBYSCORE', queueKey, 0, now, 'LIMIT', 0, limit)

if #tasks == 0 then
    return {}
end

-- åˆ é™¤ä»»åŠ¡
for i, taskId in ipairs(tasks) do
    redis.call('ZREM', queueKey, taskId)
end

return tasks
```

**Javaè°ƒç”¨ï¼š**
```java
@Scheduled(fixedDelay = 1000)
public void scanWithLua() {
    DefaultRedisScript<List> script = new DefaultRedisScript<>();
    script.setScriptText(luaScript);
    script.setResultType(List.class);

    List<String> tasks = redisTemplate.execute(
        script,
        Collections.singletonList(DELAY_QUEUE_KEY),
        String.valueOf(System.currentTimeMillis()),
        "100"
    );

    if (tasks != null && !tasks.isEmpty()) {
        for (String taskId : tasks) {
            executeTask(taskId);
        }
    }
}
```

### ğŸ”¥ è¿›é˜¶ä¼˜åŒ–

#### 1ï¸âƒ£ å¤šå®ä¾‹éƒ¨ç½²ï¼ˆé«˜å¯ç”¨ï¼‰

**é—®é¢˜ï¼š** å¤šä¸ªå®ä¾‹åŒæ—¶æ‰«æï¼Œä»»åŠ¡å¯èƒ½è¢«é‡å¤æ‰§è¡Œ

**è§£å†³ï¼š** åˆ†å¸ƒå¼é”

```java
@Scheduled(fixedDelay = 1000)
public void scanWithLock() {
    String lockKey = "delay:queue:lock";
    String lockValue = UUID.randomUUID().toString();

    // å°è¯•è·å–é”
    Boolean locked = redisTemplate.opsForValue().setIfAbsent(
        lockKey,
        lockValue,
        2,
        TimeUnit.SECONDS
    );

    if (!locked) {
        return;  // å…¶ä»–å®ä¾‹æ­£åœ¨æ‰«æ
    }

    try {
        // æ‰«æå¹¶æ‰§è¡Œä»»åŠ¡
        scan();
    } finally {
        // é‡Šæ”¾é”ï¼ˆLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
        releaseLock(lockKey, lockValue);
    }
}
```

#### 2ï¸âƒ£ ä»»åŠ¡åˆ†ç‰‡ï¼ˆæµ·é‡ä»»åŠ¡ï¼‰

**é—®é¢˜ï¼š** å•ä¸ªZSetä»»åŠ¡é‡å¤ªå¤§

**è§£å†³ï¼š** æŒ‰å°æ—¶åˆ†ç‰‡

```java
// æŒ‰å°æ—¶åˆ†ç‰‡
String getQueueKey() {
    long hour = System.currentTimeMillis() / (1000 * 3600);
    return "delay:queue:" + hour;
}

// æ‰«æå½“å‰å°æ—¶å’Œä¸‹ä¸€å°æ—¶çš„é˜Ÿåˆ—
for (int i = 0; i <= 1; i++) {
    String queueKey = "delay:queue:" + (currentHour + i);
    scanQueue(queueKey);
}
```

#### 3ï¸âƒ£ ä»»åŠ¡æŒä¹…åŒ–

```java
// ä»»åŠ¡ä¿¡æ¯å­˜å‚¨åˆ°Hash
public void addTask(DelayTask task) {
    String taskId = task.getId();
    long executeTime = System.currentTimeMillis() + task.getDelaySeconds() * 1000;

    // 1. ä»»åŠ¡è¯¦æƒ…å­˜å…¥Hash
    String taskKey = "delay:task:" + taskId;
    redisTemplate.opsForHash().putAll(taskKey, BeanUtil.beanToMap(task));

    // 2. ä»»åŠ¡IDå­˜å…¥ZSet
    redisTemplate.opsForZSet().add(DELAY_QUEUE_KEY, taskId, executeTime);
}

// æ‰§è¡Œä»»åŠ¡æ—¶ä»Hashè·å–è¯¦æƒ…
private void executeTask(String taskId) {
    String taskKey = "delay:task:" + taskId;
    Map<Object, Object> map = redisTemplate.opsForHash().entries(taskKey);

    if (map.isEmpty()) {
        return;
    }

    DelayTask task = BeanUtil.mapToBean(map, DelayTask.class, true);

    // æ‰§è¡Œä»»åŠ¡
    // ...

    // åˆ é™¤ä»»åŠ¡è¯¦æƒ…
    redisTemplate.delete(taskKey);
}
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ–¹æ¡ˆã€‘
Redis ZSetå®ç°å»¶æ—¶é˜Ÿåˆ—

ã€åŸç†ã€‘
- memberï¼šä»»åŠ¡ID
- scoreï¼šæ‰§è¡Œæ—¶é—´æˆ³
- å®šæ—¶æ‰«æ score <= å½“å‰æ—¶é—´ çš„ä»»åŠ¡

ã€æµç¨‹ã€‘
1. ZADDæ·»åŠ ä»»åŠ¡ï¼Œscore=æ‰§è¡Œæ—¶é—´
2. å®šæ—¶ä»»åŠ¡æ¯ç§’æ‰«æ
3. ZRANGEBYSCOREæŸ¥è¯¢åˆ°æœŸä»»åŠ¡
4. ZREMåˆ é™¤ä»»åŠ¡ï¼ˆé˜²é‡å¤ï¼‰
5. æ‰§è¡Œä»»åŠ¡

ã€é«˜å¯ç”¨ã€‘
1. å¤šå®ä¾‹éƒ¨ç½²
2. åˆ†å¸ƒå¼é”é˜²æ­¢é‡å¤æ‰«æ
3. Luaè„šæœ¬ä¿è¯åŸå­æ€§

ã€ä¼˜åŒ–ã€‘
1. ä»»åŠ¡åˆ†ç‰‡ï¼ˆæŒ‰å°æ—¶ï¼‰
2. å¤±è´¥é‡è¯•ï¼ˆé‡æ–°åŠ å…¥é˜Ÿåˆ—ï¼‰
3. ä»»åŠ¡æŒä¹…åŒ–ï¼ˆHashå­˜å‚¨è¯¦æƒ…ï¼‰

ã€å…¶ä»–æ–¹æ¡ˆã€‘
- RabbitMQå»¶è¿Ÿæ’ä»¶
- æ—¶é—´è½®ç®—æ³•
```

---

## ğŸ“Œ åˆ†å¸ƒå¼é”ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ éœ€æ±‚åˆ†æ

**åº”ç”¨åœºæ™¯ï¼š**
1. é˜²æ­¢é‡å¤ä¸‹å•
2. å®šæ—¶ä»»åŠ¡ï¼ˆåªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œï¼‰
3. åº“å­˜æ‰£å‡
4. åˆ†å¸ƒå¼äº‹åŠ¡

**è¦æ±‚ï¼š**
- äº’æ–¥æ€§ï¼šåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”
- é˜²æ­»é”ï¼šæŒæœ‰é”çš„è¿›ç¨‹æŒ‚äº†ï¼Œé”èƒ½è‡ªåŠ¨é‡Šæ”¾
- å¯é‡å…¥ï¼šåŒä¸€çº¿ç¨‹å¯é‡å¤è·å–é”
- é«˜å¯ç”¨ï¼šé”æœåŠ¡ä¸èƒ½æŒ‚

### âœ… å®ç°æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šRedis SETNXï¼ˆåŸºç¡€ç‰ˆï¼‰

```java
public boolean tryLock(String key, String value, long expireSeconds) {
    Boolean result = redisTemplate.opsForValue().setIfAbsent(
        key,
        value,
        expireSeconds,
        TimeUnit.SECONDS
    );
    return result != null && result;
}

public void unlock(String key, String value) {
    // å¿…é¡»æ£€æŸ¥æ˜¯è‡ªå·±çš„é”æ‰èƒ½åˆ é™¤
    String currentValue = redisTemplate.opsForValue().get(key);
    if (value.equals(currentValue)) {
        redisTemplate.delete(key);
    }
}
```

**é—®é¢˜ï¼š** unlockä¸æ˜¯åŸå­æ“ä½œ

#### æ–¹æ¡ˆ2ï¼šLuaè„šæœ¬é‡Šæ”¾é”ï¼ˆæ¨èï¼‰

```lua
-- unlock.lua
local key = KEYS[1]
local value = ARGV[1]

if redis.call('get', key) == value then
    return redis.call('del', key)
else
    return 0
end
```

**å®Œæ•´å®ç°ï¼š**

```java
@Component
public class RedisDistributedLock {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    private static final String LOCK_PREFIX = "lock:";

    /**
     * å°è¯•è·å–é”
     */
    public boolean tryLock(String lockKey, String requestId, long expireSeconds) {
        String key = LOCK_PREFIX + lockKey;
        Boolean result = redisTemplate.opsForValue().setIfAbsent(
            key,
            requestId,
            expireSeconds,
            TimeUnit.SECONDS
        );
        return result != null && result;
    }

    /**
     * é‡Šæ”¾é”ï¼ˆLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
     */
    public boolean unlock(String lockKey, String requestId) {
        String key = LOCK_PREFIX + lockKey;

        String luaScript =
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('del', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";

        DefaultRedisScript<Long> script = new DefaultRedisScript<>();
        script.setScriptText(luaScript);
        script.setResultType(Long.class);

        Long result = redisTemplate.execute(
            script,
            Collections.singletonList(key),
            requestId
        );

        return result != null && result > 0;
    }

    /**
     * è‡ªåŠ¨ç»­æœŸé”ï¼ˆçœ‹é—¨ç‹—ï¼‰
     */
    public void renewLock(String lockKey, String requestId, long expireSeconds) {
        ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);

        scheduler.scheduleAtFixedRate(() -> {
            String key = LOCK_PREFIX + lockKey;
            String currentValue = redisTemplate.opsForValue().get(key);

            if (requestId.equals(currentValue)) {
                // ç»­æœŸ
                redisTemplate.expire(key, expireSeconds, TimeUnit.SECONDS);
            } else {
                // é”å·²é‡Šæ”¾ï¼Œåœæ­¢ç»­æœŸ
                scheduler.shutdown();
            }
        }, expireSeconds / 3, expireSeconds / 3, TimeUnit.SECONDS);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```java
public void doSomething() {
    String lockKey = "order:create:user:100";
    String requestId = UUID.randomUUID().toString();

    try {
        // å°è¯•è·å–é”ï¼Œ10ç§’è¿‡æœŸ
        if (redisLock.tryLock(lockKey, requestId, 10)) {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            // ...
        } else {
            throw new BusinessException("è¯·å‹¿é‡å¤æ“ä½œ");
        }
    } finally {
        // é‡Šæ”¾é”
        redisLock.unlock(lockKey, requestId);
    }
}
```

#### æ–¹æ¡ˆ3ï¼šRedissonï¼ˆç”Ÿäº§æ¨èï¼‰

```java
@Autowired
private RedissonClient redissonClient;

public void doSomething() {
    RLock lock = redissonClient.getLock("myLock");

    try {
        // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…3ç§’ï¼Œ10ç§’åè‡ªåŠ¨é‡Šæ”¾
        if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
            // ä¸šåŠ¡é€»è¾‘
            // ...
        }
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
    } finally {
        // é‡Šæ”¾é”ï¼ˆä¼šæ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼‰
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

**Redissonä¼˜ç‚¹ï¼š**
- âœ… è‡ªåŠ¨ç»­æœŸï¼ˆçœ‹é—¨ç‹—ï¼‰
- âœ… å¯é‡å…¥é”
- âœ… å…¬å¹³é”/éå…¬å¹³é”
- âœ… è¯»å†™é”
- âœ… çº¢é”ï¼ˆRedLockï¼‰

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€åŸºæœ¬å®ç°ã€‘
Redis SETNX + Luaè„šæœ¬é‡Šæ”¾é”

ã€åŠ é”ã€‘
SET lock:key requestId EX 10 NX
- NXï¼šä¸å­˜åœ¨æ‰è®¾ç½®
- EXï¼šè¿‡æœŸæ—¶é—´
- requestIdï¼šå”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰

ã€è§£é”ã€‘
Luaè„šæœ¬ï¼š
if redis.call('get', KEYS[1]) == ARGV[1] then
    return redis.call('del', KEYS[1])
end

ã€é˜²æ­»é”ã€‘
1. è®¾ç½®è¿‡æœŸæ—¶é—´
2. çœ‹é—¨ç‹—è‡ªåŠ¨ç»­æœŸ

ã€é«˜å¯ç”¨ã€‘
Redisson + RedLock
- å¤šä¸ªRediså®ä¾‹
- è¶…è¿‡åŠæ•°æˆåŠŸæ‰ç®—åŠ é”æˆåŠŸ

ã€ç”Ÿäº§æ¨èã€‘
Redissonï¼ŒåŠŸèƒ½å®Œå–„
```

---

å®Œæˆï¼æ‰€æœ‰é«˜é¢‘ç³»ç»Ÿè®¾è®¡æ¡ˆä¾‹å·²è¡¥å……å®Œæ¯•ï¼
