# 操作系统-jk复习版
```
📦 计算机全栈内存与并发体系 (Full-Stack Memory & Concurrency)
 ┃
 ┣━━ 🖥️ 1. 硬件基础 (Physical Hardware)
 ┃    ┣━━ [用户提问] 总线的作用是什么？
 ┃    ┗━━ 总线 (Bus): 连接 CPU、内存和外设的通道，负责传输地址、数据和控制信号。
 ┃
 ┣━━ 🗺️ 2. 地址与空间 (Address & Space)
 ┃    ┣━━ 虚拟地址 (Virtual Address)
 ┃    ┃    ┣━━ [核心知识] 来源：由编译器/链接器生成，指令中写死的地址（相对偏移）。
 ┃    ┃    ┗━━ [用户误解与修正] ❌ 误以为地址是运行时随机找的 -> ✅ 修正：编译时已确定相对结构，CPU 硬件自动按规则切分（索引+偏移）。
 ┃    ┣━━ 虚拟内存 (Virtual Memory)
 ┃    ┃    ┗━━ 定义：程序看到的巨大连续空间，实际上是碎片化的物理页 + 磁盘交换区的组合。
 ┃    ┗━━ 物理内存 (Physical RAM)
 ┃         ┗━━ 实际插在主板上的内存条，通常比虚拟空间小得多。
 ┃
 ┣━━ 📒 3. 寻址系统 (The Mapping System) —— 负责"找路"
 ┃    ┣━━ 页表 (Page Tables)
 ┃    ┃    ┣━━ [用户误解与修正] ❌ 误以为页表存在 CPU 里 -> ✅ 修正：页表存在 **内存(RAM)** 中，CPU 里只存基址指针 (CR3)。
 ┃    ┃    ┣━━ 结构：多级页表，按需分配。
 ┃    ┃    ┗━━ 页表项 (PTE)：
 ┃    ┃         ┣━━ Present=1: 存物理页帧号 (PFN)。
 ┃    ┃         ┗━━ Present=0: [用户提问] 存磁盘扇区位置 (Swap Offset)。
 ┃    ┣━━ TLB (快表)
 ┃    ┃    ┣━━ 定义：CPU 内部的**地址翻译缓存**。
 ┃    ┃    ┣━━ [用户误解与修正] ❌ 误以为 L1/L2 缓存就是 TLB -> ✅ 修正：TLB 是专用的地址地图，L1/L2 是通用的数据仓库。
 ┃    ┃    ┗━━ 机制：存储 (VPN -> PFN) + ASID (进程ID)，跳过查表的 4 次内存访问。
 ┃    ┗━━ 寻址流程
 ┃         ┗━━ CPU 产出虚拟地址 -> 查 TLB (Miss则查页表) -> 拿到物理地址 -> **转入数据缓存系统**。
 ┃
 ┣━━ 🚚 4. 数据缓存系统 (The Logistics System) —— 负责"运货"
 ┃    ┣━━ [用户提问] 既然有了物理地址，为什么不直接读内存？
 ┃    ┃    ┗━━ 原因：速度鸿沟。CPU (纳秒级) vs 内存 (百纳秒级)。
 ┃    ┣━━ 缓存层级 (L1/L2/L3)
 ┃    ┃    ┣━━ 作用：存储**真实数据** (变量、代码)。
 ┃    ┃    ┗━━ 命中原理：
 ┃    ┃         ┣━━ 时间局部性：刚访问过的变量 (如累加器) 马上再用。
 ┃    ┃         ┗━━ 空间局部性：[用户提问] 什么时候频繁工作？ -> 遍历数组时，利用 Cache Line 预读机制，一次搬运 64 字节。
 ┃
 ┣━━ ⚔️ 5. 并发与底层一致性 (Concurrency & Coherence) —— 负责"防打架"
 ┃    ┣━━ 📏 Cache Line (缓存行)
 ┃    ┃    ┣━━ 定义：数据搬运和管理的最小单位 (通常 64 字节)。
 ┃    ┃    ┗━━ 地位：多核 CPU 争抢资源的**最小战场**。
 ┃    ┣━━ 🚫 伪共享 (False Sharing)
 ┃    ┃    ┣━━ [用户提问] 什么是缓存行失效？
 ┃    ┃    ┃    ┗━━ 现象：核心 A 修改数据，导致核心 B 持有的同一行数据被迫作废 (Invalid) 并重读。
 ┃    ┃    ┣━━ 成因：两个不相干变量 (A, B) 挤在同一个 Cache Line。
 ┃    ┃    ┗━━ [用户直觉解法] ✅ Padding (填充)：强制 A 在 Line 0, B 在 Line 1，物理隔离，互不干扰。
 ┃    ┣━━ 🚧 内存屏障 (Memory Barrier)
 ┃    ┃    ┗━━ 作用：禁止 CPU 乱序执行，解决多核下的"可见性"问题。
 ┃    ┗━━ 🔓 无锁编程 (Lock-Free)
 ┃         ┗━━ 本质：利用原子指令 (CAS) 精细控制 Cache Line 状态，配合内存屏障，替代互斥锁。
 ┃
 ┗━━ 📦 6. 兜底机制 (Swapping & Loading)
      ┣━━ 按需加载 (Lazy Loading)
      ┃    ┗━━ [用户误解与修正] ❌ 误以为程序启动即加载 -> ✅ 修正：通过**缺页异常 (Page Fault)**，用到才加载。
      ┗━━ 交换机制 (Swapping)
           ┣━━ 触发：内存不足时，将冷数据换出 (Swap Out)。
           ┗━━ [用户误解与修正] ❌ 误以为每个进程独立文件 -> ✅ 修正：共用一个巨大交换区，逻辑上隔离。
```