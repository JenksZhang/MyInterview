# C++é¢è¯•çŸ¥è¯†ç‚¹

> æŒ‰ç…§é‡è¦ç¨‹åº¦æ’åºï¼Œä¼˜å…ˆæŒæ¡â­â­â­â­â­å¿…è€ƒé¢˜

---

## å¤šæ€ä¸è™šå‡½æ•°

## ğŸ“Œ C++å¤šæ€æœºåˆ¶ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **è™šå‡½æ•°è¡¨(vtable)** | **è™šæŒ‡é’ˆ(vptr)** | **åŠ¨æ€ç»‘å®š** | **é™æ€å¤šæ€vsåŠ¨æ€å¤šæ€** | **é‡è½½vsé‡å†™** | **ç¼–è¯‘æ—¶vsè¿è¡Œæ—¶**

### âœ… æ ¸å¿ƒæ¦‚å¿µ

C++å¤šæ€åˆ†ä¸ºä¸¤ç§ï¼š

**1ï¸âƒ£ é™æ€å¤šæ€ï¼ˆç¼–è¯‘æ—¶å¤šæ€ï¼‰**
```cpp
// å‡½æ•°é‡è½½ - åŒåå‡½æ•°ï¼Œä¸åŒå‚æ•°
void print(int x);
void print(double x);
void print(string x);

// ç¼–è¯‘æ—¶æ ¹æ®å‚æ•°ç±»å‹ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°
print(10);      // è°ƒç”¨ print(int)
print(3.14);    // è°ƒç”¨ print(double)
```

**2ï¸âƒ£ åŠ¨æ€å¤šæ€ï¼ˆè¿è¡Œæ—¶å¤šæ€ï¼‰**
```cpp
class Base {
public:
    virtual void show() { cout << "Base"; }  // ğŸ”‘ virtualå…³é”®å­—
};

class Derived : public Base {
public:
    void show() override { cout << "Derived"; }  // ğŸ”‘ é‡å†™è™šå‡½æ•°
};

Base* ptr = new Derived();
ptr->show();  // è¾“å‡º"Derived" - è¿è¡Œæ—¶å†³å®š
```

### ğŸ’¡ è™šå‡½æ•°è¡¨æ·±å…¥å‰–æï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

#### ğŸ”¬ å•ç»§æ‰¿çš„è™šè¡¨ç»“æ„

```cpp
class Base {
public:
    int base_data = 10;
    virtual void func1() { cout << "Base::func1\n"; }
    virtual void func2() { cout << "Base::func2\n"; }
    void func3() { cout << "Base::func3\n"; }  // éè™šå‡½æ•°
};

class Derived : public Base {
public:
    int derived_data = 20;
    void func1() override { cout << "Derived::func1\n"; }  // é‡å†™
    virtual void func4() { cout << "Derived::func4\n"; }   // æ–°å¢è™šå‡½æ•°
};
```

**å†…å­˜å¸ƒå±€è¯¦è§£ï¼š**
```
Baseå¯¹è±¡å†…å­˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ vptr â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  8å­—èŠ‚ï¼ˆ64ä½ç³»ç»Ÿï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ base_data    â”‚         â”‚  4å­—èŠ‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
æ€»å¤§å°ï¼š16å­—èŠ‚ï¼ˆå¯¹é½ï¼‰    â”‚
                         â”‚
                         â–¼
              Baseçš„è™šå‡½æ•°è¡¨
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ offset_to_top: 0    â”‚  â† RTTIä¿¡æ¯
              â”‚ type_info for Base  â”‚  â† RTTIä¿¡æ¯
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚ &Base::func1        â”‚  â† vptræŒ‡å‘è¿™é‡Œ
              â”‚ &Base::func2        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Derivedå¯¹è±¡å†…å­˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ vptr â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  ç»§æ‰¿è‡ªBaseçš„vptr
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ base_data    â”‚         â”‚  ç»§æ‰¿çš„æˆå‘˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚ derived_data â”‚         â”‚  æ–°å¢çš„æˆå‘˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
æ€»å¤§å°ï¼š24å­—èŠ‚ï¼ˆå¯¹é½ï¼‰    â”‚
                         â”‚
                         â–¼
            Derivedçš„è™šå‡½æ•°è¡¨
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ offset_to_top: 0      â”‚
            â”‚ type_info for Derived â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚ &Derived::func1       â”‚  â† ğŸ”‘ è¦†ç›–Base::func1
            â”‚ &Base::func2          â”‚  â† ç»§æ‰¿Base::func2
            â”‚ &Derived::func4       â”‚  â† æ–°å¢è™šå‡½æ•°
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”‘ å…³é”®ç‚¹ï¼š**
1. è™šè¡¨æ˜¯ç±»çº§åˆ«çš„ï¼ˆæ‰€æœ‰Derivedå¯¹è±¡å…±äº«åŒä¸€ä¸ªè™šè¡¨ï¼‰
2. vptræ˜¯å¯¹è±¡çº§åˆ«çš„ï¼ˆæ¯ä¸ªå¯¹è±¡éƒ½æœ‰è‡ªå·±çš„vptrï¼‰
3. éè™šå‡½æ•°ä¸åœ¨è™šè¡¨ä¸­ï¼ˆå¦‚func3ï¼‰
4. æ´¾ç”Ÿç±»çš„è™šè¡¨ç»§æ‰¿åŸºç±»è™šè¡¨ï¼Œç„¶åè¦†ç›–/è¿½åŠ 

#### ğŸ”¬ å¤šç»§æ‰¿çš„è™šè¡¨ç»“æ„ï¼ˆâ­â­â­â­â­ é«˜é¢‘éš¾ç‚¹ï¼‰

```cpp
class Base1 {
public:
    int data1 = 10;
    virtual void func1() { cout << "Base1::func1\n"; }
    virtual void func2() { cout << "Base1::func2\n"; }
};

class Base2 {
public:
    int data2 = 20;
    virtual void func3() { cout << "Base2::func3\n"; }
    virtual void func4() { cout << "Base2::func4\n"; }
};

class Derived : public Base1, public Base2 {
public:
    int data3 = 30;
    void func1() override { cout << "Derived::func1\n"; }
    void func3() override { cout << "Derived::func3\n"; }
    virtual void func5() { cout << "Derived::func5\n"; }
};
```

**å¤šç»§æ‰¿å†…å­˜å¸ƒå±€ï¼š**
```
Derivedå¯¹è±¡å†…å­˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Base1éƒ¨åˆ†                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ vptr1 â”€â”€â”€â”€â”€â”€â”       â”‚     â”‚  æŒ‡å‘ç¬¬ä¸€ä¸ªè™šè¡¨
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚ â”‚ data1       â”‚       â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
â”‚ Base2éƒ¨åˆ†             â”‚     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚ â”‚ vptr2 â”€â”€â”€â”€â”€â”   â”‚   â”‚     â”‚  æŒ‡å‘ç¬¬äºŒä¸ªè™šè¡¨
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤   â”‚     â”‚
â”‚ â”‚ data2      â”‚   â”‚   â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
â”‚ data3            â”‚   â”‚     â”‚  Derivedè‡ªå·±çš„æˆå‘˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
                       â”‚     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼    â–¼
   vtable1              vtable2
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ offset: 0   â”‚     â”‚ offset: -16 â”‚  â† ğŸ”‘ åç§»é‡
   â”‚ type_info   â”‚     â”‚ type_info   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚&Derived::   â”‚     â”‚&Derived::   â”‚  â† ğŸ”‘ thunk
   â”‚  func1      â”‚     â”‚  func3      â”‚
   â”‚&Base1::     â”‚     â”‚&Base2::     â”‚
   â”‚  func2      â”‚     â”‚  func4      â”‚
   â”‚&Derived::   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚  func5      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”‘ thunkæŠ€æœ¯ï¼ˆå¤šç»§æ‰¿çš„å…³é”®ï¼‰ï¼š**
```cpp
Derived d;
Base2* p = &d;  // ğŸ”‘ æŒ‡é’ˆéœ€è¦è°ƒæ•´

// å†…å­˜åœ°å€ï¼š
// &d = 0x1000ï¼ˆDerivedå¯¹è±¡èµ·å§‹ï¼‰
// p  = 0x1010ï¼ˆBase2å­å¯¹è±¡ï¼Œåç§»16å­—èŠ‚ï¼‰

p->func3();  // è°ƒç”¨Derived::func3

// åº•å±‚æ‰§è¡Œï¼š
// 1. é€šè¿‡pï¼ˆ0x1010ï¼‰æ‰¾åˆ°vptr2
// 2. vptr2æŒ‡å‘vtable2
// 3. vtable2ä¸­func3ä½ç½®å­˜å‚¨çš„æ˜¯ä¸€ä¸ªthunk
// 4. thunkå…ˆå°†thisæŒ‡é’ˆè°ƒæ•´ï¼šthis -= 16ï¼ˆå›åˆ°Derivedèµ·å§‹ï¼‰
// 5. å†è·³è½¬åˆ°çœŸæ­£çš„Derived::func3
```

**thunkæ±‡ç¼–ä»£ç ç¤ºä¾‹ï¼š**
```asm
; thunk for Derived::func3
sub rdi, 16    ; è°ƒæ•´thisæŒ‡é’ˆï¼ˆrdiæ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³thisï¼‰
jmp Derived::func3  ; è·³è½¬åˆ°çœŸæ­£çš„å‡½æ•°
```

#### ğŸ”¬ è™šç»§æ‰¿çš„è™šè¡¨ç»“æ„ï¼ˆâ­â­â­â­â­ æœ€å¤æ‚ï¼‰

```cpp
class Animal {
public:
    int age = 1;
    virtual void eat() { cout << "Animal eat\n"; }
};

class Tiger : virtual public Animal {
public:
    int tiger_data = 10;
    void eat() override { cout << "Tiger eat\n"; }
};

class Lion : virtual public Animal {
public:
    int lion_data = 20;
    void eat() override { cout << "Lion eat\n"; }
};

class Liger : public Tiger, public Lion {
public:
    int liger_data = 30;
    void eat() override { cout << "Liger eat\n"; }
};
```

**è™šç»§æ‰¿å†…å­˜å¸ƒå±€ï¼š**
```
Ligerå¯¹è±¡å†…å­˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tigeréƒ¨åˆ†ï¼ˆä¸å«Animalï¼‰           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚ vptr_tiger â”€â”€â”€â”€â”   â”‚            â”‚  æŒ‡å‘Tigerçš„è™šè¡¨
â”‚ â”‚ vbptr_tiger â”€â”€â”€â”¼â”€â” â”‚            â”‚  è™šåŸºç±»æŒ‡é’ˆ
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚            â”‚
â”‚ â”‚ tiger_data     â”‚ â”‚ â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Lionéƒ¨åˆ†ï¼ˆä¸å«Animalï¼‰ â”‚ â”‚         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚            â”‚
â”‚ â”‚ vptr_lion â”€â”€â”â”‚   â”‚ â”‚            â”‚  æŒ‡å‘Lionçš„è™šè¡¨
â”‚ â”‚ vbptr_lion â”€â”¼â”¼â”€â”€â”€â”¼â”€â”¤            â”‚  è™šåŸºç±»æŒ‡é’ˆ
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚   â”‚ â”‚            â”‚
â”‚ â”‚ lion_data   â”‚â”‚   â”‚ â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚ â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ liger_data     â”‚   â”‚ â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚            â”‚
â”‚ Animaléƒ¨åˆ†ï¼ˆè™šåŸºç±»ï¼‰â”‚ â”‚            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚            â”‚
â”‚ â”‚ vptr_animal â”€â”€â”â”‚ â”‚ â”‚            â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”¤ â”‚ â”‚            â”‚
â”‚ â”‚ age           â”‚â”‚ â”‚ â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚ â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ â”‚ â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â–¼   â–¼   â–¼
è™šåŸºç±»è¡¨ï¼ˆVTT - Virtual Table Tableï¼‰

ğŸ”‘ å…³é”®ï¼š
1. vbptrï¼ˆè™šåŸºç±»æŒ‡é’ˆï¼‰æŒ‡å‘è™šåŸºç±»è¡¨
2. è™šåŸºç±»è¡¨å­˜å‚¨åˆ°è™šåŸºç±»çš„åç§»
3. Animaléƒ¨åˆ†åœ¨æœ€åï¼ˆè™šåŸºç±»ï¼‰
4. åªæœ‰ä¸€ä»½Animalæ•°æ®
```

#### ğŸ”¬ è™šå‡½æ•°è°ƒç”¨çš„æ±‡ç¼–çº§åˆ†æï¼ˆâ­â­â­â­â­ï¼‰

```cpp
class Base {
public:
    virtual void func() { cout << "Base\n"; }
};

class Derived : public Base {
public:
    void func() override { cout << "Derived\n"; }
};

int main() {
    Base* p = new Derived();
    p->func();  // è™šå‡½æ•°è°ƒç”¨
}
```

**å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼ˆx86-64ï¼‰ï¼š**
```asm
; p->func() çš„æ±‡ç¼–å®ç°

mov rax, [p]           ; 1. å–å¯¹è±¡åœ°å€åˆ°rax
mov rax, [rax]         ; 2. è¯»å–vptrï¼ˆå¯¹è±¡é¦–8å­—èŠ‚ï¼‰
mov rax, [rax]         ; 3. è¯»å–vtableç¬¬ä¸€é¡¹ï¼ˆfuncçš„åœ°å€ï¼‰
mov rdi, [p]           ; 4. å‡†å¤‡thiså‚æ•°ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰
call rax               ; 5. è°ƒç”¨å‡½æ•°

; ğŸ”‘ æ€»ç»“ï¼šä¸¤æ¬¡å†…å­˜è®¿é—®ï¼ˆè¯»vptr + è¯»å‡½æ•°åœ°å€ï¼‰
```

**ä¸éè™šå‡½æ•°å¯¹æ¯”ï¼š**
```cpp
class Base {
public:
    void func() { cout << "Base\n"; }  // éè™šå‡½æ•°
};

Base b;
b.func();  // éè™šå‡½æ•°è°ƒç”¨

; å¯¹åº”æ±‡ç¼–ï¼š
mov rdi, &b           ; å‡†å¤‡thiså‚æ•°
call Base::func       ; ç›´æ¥è°ƒç”¨ï¼ˆåœ°å€åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼‰

; ğŸ”‘ åªæœ‰ä¸€æ¬¡è°ƒç”¨ï¼Œåœ°å€ç¼–è¯‘æ—¶ç¡®å®š
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
```
è™šå‡½æ•°ï¼š
- 2æ¬¡å†…å­˜é—´æ¥è®¿é—®ï¼ˆcache misså¯èƒ½æ€§é«˜ï¼‰
- æ— æ³•å†…è”ï¼ˆåœ°å€è¿è¡Œæ—¶ç¡®å®šï¼‰
- çº¦5-10ä¸ªæ—¶é’Ÿå‘¨æœŸå¼€é”€

éè™šå‡½æ•°ï¼š
- å¯å†…è”ï¼ˆç¼–è¯‘å™¨ä¼˜åŒ–ï¼‰
- ç›´æ¥è°ƒç”¨ï¼Œ0-1ä¸ªæ—¶é’Ÿå‘¨æœŸ
- ä»£ç ä½“ç§¯å¯èƒ½æ›´å°ï¼ˆå†…è”åï¼‰
```

#### ğŸ”¬ vptrçš„åˆå§‹åŒ–æ—¶æœºï¼ˆâ­â­â­â­â­ é«˜é¢‘éš¾ç‚¹ï¼‰

```cpp
class Base {
public:
    Base() {
        cout << "Baseæ„é€ \n";
        func();  // ğŸ”‘ è°ƒç”¨è™šå‡½æ•°
    }
    virtual ~Base() {
        func();  // ğŸ”‘ ææ„ä¸­è°ƒç”¨è™šå‡½æ•°
    }
    virtual void func() { cout << "Base::func\n"; }
};

class Derived : public Base {
public:
    Derived() {
        cout << "Derivedæ„é€ \n";
        func();
    }
    ~Derived() {
        func();
    }
    void func() override { cout << "Derived::func\n"; }
};

int main() {
    Base* p = new Derived();
    delete p;
}

/* è¾“å‡ºï¼š
Baseæ„é€ 
Base::func        â† ğŸ”‘ æ„é€ ä¸­vptræŒ‡å‘Base
Derivedæ„é€ 
Derived::func     â† ğŸ”‘ æ„é€ å®ŒæˆåvptræŒ‡å‘Derived
Derived::func     â† ææ„å‰vpträ»æŒ‡å‘Derived
Base::func        â† ğŸ”‘ Derivedææ„åvptræ¢å¤æŒ‡å‘Base
*/
```

**vptrçš„ç”Ÿå‘½å‘¨æœŸï¼š**
```
åˆ›å»ºDerivedå¯¹è±¡ï¼š
1. åˆ†é…å†…å­˜
2. Baseæ„é€ å‡½æ•°æ‰§è¡Œå‰ï¼švptr = &Base_vtable
3. Baseæ„é€ å‡½æ•°ä¸­ï¼šè°ƒç”¨Base::funcï¼ˆé™æ€ç»‘å®šï¼‰
4. Derivedæ„é€ å‡½æ•°æ‰§è¡Œå‰ï¼švptr = &Derived_vtable
5. Derivedæ„é€ å‡½æ•°ä¸­ï¼šè°ƒç”¨Derived::func

é”€æ¯Derivedå¯¹è±¡ï¼š
1. Derivedææ„å‡½æ•°æ‰§è¡Œå‰ï¼švptr = &Derived_vtable
2. Derivedææ„å‡½æ•°æ‰§è¡Œåï¼švptr = &Base_vtable  â† ğŸ”‘ æ¢å¤
3. Baseææ„å‡½æ•°ä¸­ï¼šè°ƒç”¨Base::funcï¼ˆé™æ€ç»‘å®šï¼‰
4. é‡Šæ”¾å†…å­˜

ğŸ”‘ åŸå› ï¼šé˜²æ­¢ææ„ä¸­è°ƒç”¨çº¯è™šå‡½æ•°æˆ–å·²é”€æ¯çš„æ´¾ç”Ÿç±»å‡½æ•°
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ æ„é€ å‡½æ•°å¯ä»¥æ˜¯è™šå‡½æ•°å—ï¼Ÿï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

âŒ **ä¸å¯ä»¥**

**åŸå› ï¼š**
```
1. è™šå‡½æ•°è¡¨åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–
2. å¦‚æœæ„é€ å‡½æ•°æ˜¯è™šå‡½æ•°ï¼Œè°ƒç”¨æ—¶æ‰¾ä¸åˆ°è™šå‡½æ•°è¡¨
3. é€»è¾‘çŸ›ç›¾ï¼šè™šå‡½æ•°éœ€è¦vptrï¼Œvptråœ¨æ„é€ å‡½æ•°ä¸­æ‰åˆ›å»º

ã€é¡ºåºã€‘
å¯¹è±¡åˆ›å»º â†’ åˆ†é…å†…å­˜ â†’ è°ƒç”¨æ„é€ å‡½æ•° â†’ åˆå§‹åŒ–vptr â†’ vptræŒ‡å‘vtable
         â†‘
      å¦‚æœæ„é€ æ˜¯è™šå‡½æ•°ï¼Œè¿™é‡Œå°±æ‰¾ä¸åˆ°vtableäº†ï¼
```

#### 2ï¸âƒ£ ææ„å‡½æ•°å¯ä»¥æ˜¯è™šå‡½æ•°å—ï¼Ÿå¿…é¡»æ˜¯å—ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

âœ… **å¯ä»¥ï¼Œè€Œä¸”åŸºç±»ææ„å‡½æ•°å¿…é¡»æ˜¯è™šå‡½æ•°ï¼**

**ä¸ºä»€ä¹ˆå¿…é¡»ï¼š**
```cpp
class Base {
public:
    ~Base() { delete[] data; }  // âŒ éè™šææ„
    int* data;
};

class Derived : public Base {
public:
    ~Derived() { delete[] moreData; }  // å­ç±»ææ„
    int* moreData;
};

Base* ptr = new Derived();
delete ptr;  // âŒ åªè°ƒç”¨~Base()ï¼Œ~Derived()ä¸ä¼šè¢«è°ƒç”¨
             // ğŸ’£ å†…å­˜æ³„æ¼ï¼moreDataæ²¡é‡Šæ”¾
```

**æ­£ç¡®åšæ³•ï¼š**
```cpp
class Base {
public:
    virtual ~Base() { delete[] data; }  // âœ… è™šææ„
};

delete ptr;  // âœ… å…ˆè°ƒç”¨~Derived()ï¼Œå†è°ƒç”¨~Base()
```

ğŸ”‘ **å¾—åˆ†ç‚¹ï¼šèƒ½è¯´å‡ºå†…å­˜æ³„æ¼çš„å…·ä½“åŸå› **

#### 3ï¸âƒ£ çº¯è™šå‡½æ•°å¯ä»¥æœ‰å®ç°å—ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

âœ… **å¯ä»¥æœ‰å®ç°ï¼**

```cpp
class Abstract {
public:
    virtual void func() = 0;  // çº¯è™šå‡½æ•°å£°æ˜
};

// çº¯è™šå‡½æ•°ä¹Ÿå¯ä»¥æœ‰å®ç°
void Abstract::func() {
    cout << "çº¯è™šå‡½æ•°çš„é»˜è®¤å®ç°";
}

class Derived : public Abstract {
public:
    void func() override {
        Abstract::func();  // âœ… å¯ä»¥è°ƒç”¨åŸºç±»çš„çº¯è™šå‡½æ•°å®ç°
        cout << "æ´¾ç”Ÿç±»çš„å®ç°";
    }
};
```

**åº”ç”¨åœºæ™¯ï¼š**
- æä¾›é»˜è®¤å®ç°ï¼Œå­ç±»å¯é€‰æ‹©æ€§è°ƒç”¨
- å¼ºåˆ¶å­ç±»å¿…é¡»é‡å†™ï¼Œä½†æä¾›å…¬å…±é€»è¾‘

#### 4ï¸âƒ£ ææ„å‡½æ•°å¯ä»¥æ˜¯çº¯è™šå‡½æ•°å—ï¼Ÿï¼ˆâ­â­â­ï¼‰

âœ… **å¯ä»¥ï¼Œä½†å¿…é¡»æä¾›å®ç°ï¼**

```cpp
class Base {
public:
    virtual ~Base() = 0;  // çº¯è™šææ„
};

// âœ… å¿…é¡»æä¾›å®ç°ï¼Œå¦åˆ™é“¾æ¥é”™è¯¯
Base::~Base() {
    cout << "Baseææ„";
}

// åŸå› ï¼šå­ç±»ææ„æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨åŸºç±»ææ„
// å¦‚æœåŸºç±»ææ„æ²¡æœ‰å®ç°ï¼Œé“¾æ¥æ—¶ä¼šæ‰¾ä¸åˆ°ç¬¦å·
```

### ğŸ“Š é‡è½½ vs é‡å†™ vs éšè—

| ç‰¹æ€§ | é‡è½½(Overload) | é‡å†™(Override) | éšè—(Hide) |
|------|---------------|---------------|-----------|
| **å‘ç”Ÿä½ç½®** | åŒä¸€ä½œç”¨åŸŸ | åŸºç±»å’Œæ´¾ç”Ÿç±» | åŸºç±»å’Œæ´¾ç”Ÿç±» |
| **å‡½æ•°å** | ç›¸åŒ | ç›¸åŒ | ç›¸åŒ |
| **å‚æ•°åˆ—è¡¨** | ä¸åŒ | ç›¸åŒ | å¯åŒå¯ä¸åŒ |
| **virtual** | æ— å…³ | åŸºç±»å¿…é¡»æœ‰ | åŸºç±»æ— virtual |
| **ç»‘å®šæ—¶æœº** | ç¼–è¯‘æ—¶ | è¿è¡Œæ—¶ | ç¼–è¯‘æ—¶ |

```cpp
// é‡è½½
void func(int);
void func(double);  // âœ… é‡è½½

// é‡å†™
class Base {
    virtual void func(int);
};
class Derived : public Base {
    void func(int) override;  // âœ… é‡å†™
};

// éšè—
class Base {
    void func(int);  // éè™šå‡½æ•°
};
class Derived : public Base {
    void func(int);  // âš ï¸ éšè—åŸºç±»çš„funcï¼Œä¸æ˜¯é‡å†™
    void func(double);  // âš ï¸ åŒæ—¶éšè—åŸºç±»çš„func
};
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘ï¼ˆ30ç§’ç‰ˆæœ¬ï¼‰
C++å¤šæ€åˆ†ä¸ºé™æ€å¤šæ€å’ŒåŠ¨æ€å¤šæ€ï¼š

1. é™æ€å¤šæ€ï¼ˆç¼–è¯‘æ—¶ï¼‰
   é€šè¿‡å‡½æ•°é‡è½½å’Œæ¨¡æ¿å®ç°ï¼Œç¼–è¯‘æ—¶ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°

2. åŠ¨æ€å¤šæ€ï¼ˆè¿è¡Œæ—¶ï¼‰
   é€šè¿‡è™šå‡½æ•°å’Œç»§æ‰¿å®ç°ï¼Œè¿è¡Œæ—¶é€šè¿‡è™šå‡½æ•°è¡¨åŠ¨æ€ç»‘å®š

   å®ç°æœºåˆ¶ï¼š
   - æ¯ä¸ªåŒ…å«è™šå‡½æ•°çš„ç±»éƒ½æœ‰ä¸€ä¸ªè™šå‡½æ•°è¡¨(vtable)
   - æ¯ä¸ªå¯¹è±¡åŒ…å«ä¸€ä¸ªè™šæŒ‡é’ˆ(vptr)æŒ‡å‘vtable
   - è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œé€šè¿‡vptræ‰¾åˆ°vtableï¼Œå†æ‰¾åˆ°å‡½æ•°åœ°å€

ã€è¿½é—®-ä¸ºä»€ä¹ˆæ„é€ ä¸èƒ½æ˜¯è™šå‡½æ•°ã€‘
å› ä¸ºè™šå‡½æ•°è¡¨åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œå¦‚æœæ„é€ å‡½æ•°æœ¬èº«æ˜¯è™šå‡½æ•°ï¼Œ
è°ƒç”¨æ—¶æ‰¾ä¸åˆ°è™šå‡½æ•°è¡¨ï¼Œé€»è¾‘çŸ›ç›¾ã€‚

ã€è¿½é—®-ä¸ºä»€ä¹ˆææ„è¦æ˜¯è™šå‡½æ•°ã€‘
å¦‚æœåŸºç±»ææ„ä¸æ˜¯è™šå‡½æ•°ï¼Œé€šè¿‡åŸºç±»æŒ‡é’ˆåˆ é™¤æ´¾ç”Ÿç±»å¯¹è±¡æ—¶ï¼Œ
åªä¼šè°ƒç”¨åŸºç±»ææ„ï¼Œæ´¾ç”Ÿç±»ææ„ä¸ä¼šæ‰§è¡Œï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šè®¤ä¸ºæœ‰virtualå°±æ˜¯å¤šæ€
âœ… **æ­£ç¡®**ï¼šå¿…é¡»é€šè¿‡åŸºç±»æŒ‡é’ˆ/å¼•ç”¨è°ƒç”¨ï¼Œæ‰èƒ½ä½“ç°å¤šæ€

âŒ **é”™è¯¯2**ï¼šè®¤ä¸ºçº¯è™šå‡½æ•°ä¸èƒ½æœ‰å®ç°
âœ… **æ­£ç¡®**ï¼šçº¯è™šå‡½æ•°å¯ä»¥æœ‰å®ç°ï¼Œä½†ç±»ä»æ˜¯æŠ½è±¡ç±»

âŒ **é”™è¯¯3**ï¼šä»¥ä¸ºé‡å†™å’Œéšè—æ˜¯ä¸€å›äº‹
âœ… **æ­£ç¡®**ï¼šé‡å†™éœ€è¦virtualï¼Œéšè—ä¸éœ€è¦ï¼Œè¡Œä¸ºå®Œå…¨ä¸åŒ

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°vptråœ¨å¯¹è±¡å†…å­˜å¸ƒå±€ä¸­çš„ä½ç½®ï¼ˆé€šå¸¸åœ¨å¼€å¤´ï¼‰
- çŸ¥é“è™šå‡½æ•°è¡¨æ˜¯ç¼–è¯‘æ—¶ç¡®å®šçš„
- äº†è§£è™šå‡½æ•°çš„æ€§èƒ½å¼€é”€ï¼ˆä¸€æ¬¡é—´æ¥è°ƒç”¨ï¼‰
- æåˆ°finalå…³é”®å­—ï¼ˆC++11ï¼Œé˜»æ­¢ç»§æ‰¿/é‡å†™ï¼‰

---

## ğŸ“Œ æ™ºèƒ½æŒ‡é’ˆï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **RAII** | **å¼•ç”¨è®¡æ•°** | **unique_ptr** | **shared_ptr** | **weak_ptr** | **å¾ªç¯å¼•ç”¨** | **è‡ªåŠ¨é‡Šæ”¾**

### âœ… ä¸‰ç§æ™ºèƒ½æŒ‡é’ˆå¯¹æ¯”

| æ™ºèƒ½æŒ‡é’ˆ | æ‰€æœ‰æƒ | è®¡æ•° | ä½¿ç”¨åœºæ™¯ | å¤åˆ¶ |
|---------|--------|------|---------|------|
| **unique_ptr** | ç‹¬å  | æ—  | æ˜ç¡®å”¯ä¸€æ‰€æœ‰æƒ | âŒ ä¸å¯å¤åˆ¶ï¼Œå¯ç§»åŠ¨ |
| **shared_ptr** | å…±äº« | å¼•ç”¨è®¡æ•° | å¤šä¸ªæ‰€æœ‰è€… | âœ… å¯å¤åˆ¶ |
| **weak_ptr** | ä¸æ‹¥æœ‰ | å¼±å¼•ç”¨ | è§£å†³å¾ªç¯å¼•ç”¨ | âœ… å¯å¤åˆ¶ |

### ğŸ’» ä»£ç ç¤ºä¾‹

**1ï¸âƒ£ unique_ptr - ç‹¬å æ‰€æœ‰æƒ**
```cpp
// âœ… åˆ›å»º
unique_ptr<int> p1(new int(10));
auto p2 = make_unique<int>(20);  // ğŸŒŸ æ¨èæ–¹å¼ï¼ˆC++14ï¼‰

// âŒ ä¸èƒ½å¤åˆ¶
unique_ptr<int> p3 = p1;  // ç¼–è¯‘é”™è¯¯

// âœ… å¯ä»¥ç§»åŠ¨
unique_ptr<int> p4 = std::move(p1);  // p1å˜ä¸ºnullptr
```

**2ï¸âƒ£ shared_ptr - å…±äº«æ‰€æœ‰æƒ**
```cpp
// âœ… åˆ›å»º
shared_ptr<int> p1(new int(10));
auto p2 = make_shared<int>(20);  // ğŸŒŸ æ¨èï¼ˆæ€§èƒ½æ›´å¥½ï¼Œä¸€æ¬¡åˆ†é…ï¼‰

// âœ… å¯ä»¥å¤åˆ¶
shared_ptr<int> p3 = p1;  // å¼•ç”¨è®¡æ•°+1
cout << p1.use_count();   // è¾“å‡ºï¼š2

// ä½œç”¨åŸŸç»“æŸï¼Œè‡ªåŠ¨é‡Šæ”¾
{
    shared_ptr<int> p4 = p1;  // å¼•ç”¨è®¡æ•° = 3
}  // p4ææ„ï¼Œå¼•ç”¨è®¡æ•° = 2
```

**3ï¸âƒ£ weak_ptr - è§£å†³å¾ªç¯å¼•ç”¨**
```cpp
class B;
class A {
public:
    shared_ptr<B> ptrB;  // âŒ å¦‚æœBä¹Ÿæœ‰shared_ptr<A>ï¼Œä¼šå¾ªç¯å¼•ç”¨
    ~A() { cout << "Aææ„"; }
};

class B {
public:
    weak_ptr<A> ptrA;    // âœ… ä½¿ç”¨weak_ptræ‰“ç ´å¾ªç¯
    ~B() { cout << "Bææ„"; }
};

// ä½¿ç”¨
shared_ptr<A> a(new A);
shared_ptr<B> b(new B);
a->ptrB = b;  // AæŒæœ‰Bçš„shared_ptr
b->ptrA = a;  // BæŒæœ‰Açš„weak_ptrï¼ˆä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼‰

// aå’Œbç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œéƒ½èƒ½æ­£å¸¸ææ„
```

### ğŸ’¡ å®ç°åŸç†ï¼ˆâ­â­â­â­â­ é«˜é¢‘è¿½é—®ï¼‰

**shared_ptrå†…éƒ¨ç»“æ„ï¼š**
```cpp
template<typename T>
class shared_ptr {
private:
    T* ptr;                    // åŸå§‹æŒ‡é’ˆ
    ControlBlock* control;     // æ§åˆ¶å—
};

struct ControlBlock {
    int shared_count;   // å¼ºå¼•ç”¨è®¡æ•°ï¼ˆshared_ptræ•°é‡ï¼‰
    int weak_count;     // å¼±å¼•ç”¨è®¡æ•°ï¼ˆweak_ptræ•°é‡ï¼‰

    // ğŸ”‘ å…³é”®ï¼šä¸¤ä¸ªè®¡æ•°éƒ½ä¸º0æ—¶ï¼Œæ‰åˆ é™¤æ§åˆ¶å—
};
```

**å¼•ç”¨è®¡æ•°æœºåˆ¶ï¼š**
```
åˆå§‹ï¼šshared_count=1, weak_count=0
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ object  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†‘
     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
     â”‚  ptr    â”‚
     â”‚ control â”‚â”€â”€â†’ [shared:1, weak:0]
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     shared_ptr

å¤åˆ¶ï¼šshared_count=2, weak_count=0
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ object  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘     â†‘
       â”‚     â””â”€â”€â”€â”€â”
     p1â”‚         p2
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ ä¸ºä»€ä¹ˆè¦ç”¨make_sharedè€Œä¸æ˜¯newï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
// âŒ æ–¹å¼1ï¼šä¸¤æ¬¡å†…å­˜åˆ†é…
shared_ptr<int> p1(new int(10));
// åˆ†é…1ï¼šnew int(10) - å¯¹è±¡å†…å­˜
// åˆ†é…2ï¼šæ§åˆ¶å—å†…å­˜

// âœ… æ–¹å¼2ï¼šä¸€æ¬¡å†…å­˜åˆ†é…
auto p2 = make_shared<int>(10);
// ğŸ”‘ å¯¹è±¡å’Œæ§åˆ¶å—ä¸€èµ·åˆ†é…ï¼Œæ€§èƒ½æ›´å¥½
```

**å…¶ä»–ä¼˜ç‚¹ï¼š**
- å¼‚å¸¸å®‰å…¨
  ```cpp
  func(shared_ptr<int>(new int), may_throw());
  // âŒ å¦‚æœmay_throw()å…ˆæ‰§è¡Œå¹¶æŠ›å¼‚å¸¸ï¼Œnew intä¼šæ³„æ¼

  func(make_shared<int>(10), may_throw());
  // âœ… å®‰å…¨ï¼Œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
  ```

#### 2ï¸âƒ£ å¾ªç¯å¼•ç”¨æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

**é—®é¢˜åœºæ™¯ï¼š**
```cpp
class Node {
public:
    shared_ptr<Node> next;
    shared_ptr<Node> prev;  // âŒ åŒå‘é“¾è¡¨çš„å¾ªç¯å¼•ç”¨
};

shared_ptr<Node> n1(new Node);
shared_ptr<Node> n2(new Node);
n1->next = n2;  // n2çš„å¼•ç”¨è®¡æ•° = 2
n2->prev = n1;  // n1çš„å¼•ç”¨è®¡æ•° = 2

// n1å’Œn2ç¦»å¼€ä½œç”¨åŸŸ
// n1çš„å¼•ç”¨è®¡æ•°ï¼š2 â†’ 1ï¼ˆä»>0ï¼Œä¸é‡Šæ”¾ï¼‰
// n2çš„å¼•ç”¨è®¡æ•°ï¼š2 â†’ 1ï¼ˆä»>0ï¼Œä¸é‡Šæ”¾ï¼‰
// ğŸ’£ å†…å­˜æ³„æ¼ï¼
```

**è§£å†³æ–¹æ¡ˆï¼š**
```cpp
class Node {
public:
    shared_ptr<Node> next;
    weak_ptr<Node> prev;    // âœ… ç”¨weak_ptræ‰“ç ´å¾ªç¯
};

// ç°åœ¨n1å’Œn2èƒ½æ­£å¸¸é‡Šæ”¾
```

#### 3ï¸âƒ£ weak_ptrå¦‚ä½•ä½¿ç”¨ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
shared_ptr<int> sp = make_shared<int>(10);
weak_ptr<int> wp = sp;  // åˆ›å»ºweak_ptr

// âŒ ä¸èƒ½ç›´æ¥è®¿é—®
// *wp;  // ç¼–è¯‘é”™è¯¯

// âœ… å¿…é¡»å…ˆè½¬æ¢ä¸ºshared_ptr
if (auto sp2 = wp.lock()) {  // ğŸ”‘ lock()è¿”å›shared_ptr
    cout << *sp2;  // å®‰å…¨è®¿é—®
} else {
    cout << "å¯¹è±¡å·²é‡Šæ”¾";
}

// æ£€æŸ¥å¯¹è±¡æ˜¯å¦è¿˜å­˜åœ¨
if (wp.expired()) {  // ç­‰ä»·äº use_count() == 0
    cout << "å¯¹è±¡å·²é‡Šæ”¾";
}
```

#### 4ï¸âƒ£ å¤šçº¿ç¨‹ä¸‹shared_ptrå®‰å…¨å—ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

**éƒ¨åˆ†å®‰å…¨ï¼š**
```cpp
// âœ… å¼•ç”¨è®¡æ•°çš„å¢å‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆåŸå­æ“ä½œï¼‰
shared_ptr<int> p1 = make_shared<int>(10);
thread t1([p1]{ auto p2 = p1; });  // å®‰å…¨
thread t2([p1]{ auto p3 = p1; });  // å®‰å…¨

// âŒ å¯¹è±¡çš„è¯»å†™ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
shared_ptr<int> p = make_shared<int>(0);
thread t1([&p]{ (*p)++; });  // âŒ æ•°æ®ç«äº‰
thread t2([&p]{ (*p)++; });  // âŒ æ•°æ®ç«äº‰
// éœ€è¦é¢å¤–åŠ é”

// âŒ åŒä¸€ä¸ªshared_ptrè¢«å¤šä¸ªçº¿ç¨‹ä¿®æ”¹ä¸å®‰å…¨
shared_ptr<int> p;
thread t1([&p]{ p = make_shared<int>(1); });  // âŒ ç«äº‰
thread t2([&p]{ p = make_shared<int>(2); });  // âŒ ç«äº‰
```

ğŸ”‘ **å¾—åˆ†ç‚¹ï¼šèƒ½åŒºåˆ†å¼•ç”¨è®¡æ•°å®‰å…¨ vs å¯¹è±¡æ•°æ®å®‰å…¨**

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
C++11æä¾›ä¸‰ç§æ™ºèƒ½æŒ‡é’ˆï¼Œéƒ½åŸºäºRAIIæ€æƒ³ï¼š

1. unique_ptrï¼šç‹¬å æ‰€æœ‰æƒï¼Œä¸å¯å¤åˆ¶ï¼Œåªèƒ½ç§»åŠ¨
   é€‚ç”¨äºæ˜ç¡®å”¯ä¸€æ‰€æœ‰æƒçš„åœºæ™¯

2. shared_ptrï¼šå…±äº«æ‰€æœ‰æƒï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°
   å¤šä¸ªæŒ‡é’ˆå¯ä»¥å…±äº«åŒä¸€ä¸ªå¯¹è±¡
   å¼•ç”¨è®¡æ•°ä¸º0æ—¶è‡ªåŠ¨é‡Šæ”¾

3. weak_ptrï¼šä¸æ‹¥æœ‰å¯¹è±¡ï¼Œé…åˆshared_pträ½¿ç”¨
   è§£å†³shared_ptrçš„å¾ªç¯å¼•ç”¨é—®é¢˜

ã€è¿½é—®-ä¸ºä»€ä¹ˆç”¨make_sharedã€‘
make_sharedä¸€æ¬¡åˆ†é…å¯¹è±¡å’Œæ§åˆ¶å—ï¼Œè€Œnewéœ€è¦ä¸¤æ¬¡åˆ†é…ï¼Œ
æ€§èƒ½æ›´å¥½ä¸”å¼‚å¸¸å®‰å…¨ã€‚

ã€è¿½é—®-å¾ªç¯å¼•ç”¨ã€‘
åŒå‘é“¾è¡¨ã€çˆ¶å­èŠ‚ç‚¹äº’ç›¸æŒæœ‰æ—¶ï¼Œä¼šå‡ºç°å¾ªç¯å¼•ç”¨å¯¼è‡´å†…å­˜æ³„æ¼ã€‚
è§£å†³æ–¹æ³•æ˜¯ä¸€æ–¹ç”¨shared_ptrï¼Œå¦ä¸€æ–¹ç”¨weak_ptrã€‚

ã€è¿½é—®-çº¿ç¨‹å®‰å…¨ã€‘
å¼•ç”¨è®¡æ•°çš„å¢å‡æ˜¯åŸå­æ“ä½œï¼Œçº¿ç¨‹å®‰å…¨ã€‚
ä½†å¯¹è±¡æœ¬èº«çš„è¯»å†™ä¸å®‰å…¨ï¼Œéœ€è¦é¢å¤–åŒæ­¥ã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸ºæ™ºèƒ½æŒ‡é’ˆå®Œå…¨ä¸ä¼šå†…å­˜æ³„æ¼
âœ… **æ­£ç¡®**ï¼šå¾ªç¯å¼•ç”¨ä»ä¼šæ³„æ¼ï¼Œéœ€è¦weak_ptr

âŒ **é”™è¯¯2**ï¼šä»¥ä¸ºshared_ptrçº¿ç¨‹å®Œå…¨å®‰å…¨
âœ… **æ­£ç¡®**ï¼šåªæœ‰å¼•ç”¨è®¡æ•°å®‰å…¨ï¼Œå¯¹è±¡æ•°æ®ä¸å®‰å…¨

âŒ **é”™è¯¯3**ï¼šunique_pträ¸èƒ½ä½œä¸ºå‡½æ•°è¿”å›å€¼
âœ… **æ­£ç¡®**ï¼šå¯ä»¥è¿”å›ï¼Œä¼šè§¦å‘ç§»åŠ¨è¯­ä¹‰

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°shared_ptrçš„æ§åˆ¶å—åŒ…å«è‡ªå®šä¹‰åˆ é™¤å™¨
- çŸ¥é“enable_shared_from_thisçš„ç”¨æ³•
- äº†è§£make_uniqueï¼ˆC++14ï¼‰å’Œmake_sharedçš„åŒºåˆ«
- æåˆ°unique_ptré›¶å¼€é”€ï¼ˆç›¸æ¯”åŸå§‹æŒ‡é’ˆï¼‰

---

## ğŸ“Œ newå’Œmallocçš„åŒºåˆ«ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **æ„é€ å‡½æ•°** | **ææ„å‡½æ•°** | **operator new** | **ç±»å‹å®‰å…¨** | **å¼‚å¸¸å¤„ç†** | **é‡è½½** | **è‡ªç”±å­˜å‚¨åŒºvså †**

### âœ… æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”

| ç‰¹æ€§ | new/delete | malloc/free |
|------|-----------|-------------|
| **æœ¬è´¨** | C++å…³é”®å­— | Cæ ‡å‡†åº“å‡½æ•° |
| **ç±»å‹** | ç±»å‹å®‰å…¨ï¼Œè‡ªåŠ¨è®¡ç®—å¤§å° | éœ€æ‰‹åŠ¨æŒ‡å®šå­—èŠ‚æ•° |
| **æ„é€ /ææ„** | âœ… è°ƒç”¨ | âŒ ä¸è°ƒç”¨ |
| **å¤±è´¥å¤„ç†** | æŠ›å‡ºstd::bad_allocå¼‚å¸¸ | è¿”å›NULL |
| **å†…å­˜æ¥æº** | è‡ªç”±å­˜å‚¨åŒº(free store) | å †(heap) |
| **å¯é‡è½½** | âœ… å¯é‡è½½operator new | âŒ ä¸å¯é‡è½½ |
| **è¿”å›ç±»å‹** | å¯¹è±¡ç±»å‹æŒ‡é’ˆ | void*ï¼ˆéœ€å¼ºè½¬ï¼‰ |

### ğŸ’» ä»£ç ç¤ºä¾‹

```cpp
// ============ malloc/free ============
// 1ï¸âƒ£ éœ€è¦æ‰‹åŠ¨è®¡ç®—å¤§å°
int* p1 = (int*)malloc(sizeof(int));  // éœ€è¦å¼ºåˆ¶è½¬æ¢
*p1 = 10;
free(p1);

// 2ï¸âƒ£ ä¸ä¼šè°ƒç”¨æ„é€ /ææ„
class Test {
public:
    Test() { cout << "æ„é€ "; }
    ~Test() { cout << "ææ„"; }
};

Test* p2 = (Test*)malloc(sizeof(Test));
free(p2);  // âŒ ä¸ä¼šè¾“å‡º"æ„é€ "å’Œ"ææ„"

// ============ new/delete ============
// 1ï¸âƒ£ è‡ªåŠ¨è®¡ç®—å¤§å°ï¼Œç±»å‹å®‰å…¨
int* p3 = new int(10);  // æ— éœ€sizeofï¼Œæ— éœ€å¼ºè½¬
delete p3;

// 2ï¸âƒ£ è°ƒç”¨æ„é€ /ææ„
Test* p4 = new Test();  // âœ… è¾“å‡º"æ„é€ "
delete p4;              // âœ… è¾“å‡º"ææ„"

// 3ï¸âƒ£ æ•°ç»„å½¢å¼
int* arr1 = new int[10];
delete[] arr1;  // ğŸ”‘ æ³¨æ„ï¼šæ•°ç»„å¿…é¡»ç”¨delete[]

Test* arr2 = new Test[3];  // è°ƒç”¨3æ¬¡æ„é€ å‡½æ•°
delete[] arr2;             // è°ƒç”¨3æ¬¡ææ„å‡½æ•°
```

### ğŸ’¡ åº•å±‚å®ç°ï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

**newçš„æ‰§è¡Œè¿‡ç¨‹ï¼š**
```cpp
Test* p = new Test(10);

// ç­‰ä»·äºï¼š
// 1ï¸âƒ£ è°ƒç”¨operator newåˆ†é…å†…å­˜
void* mem = operator new(sizeof(Test));

// 2ï¸âƒ£ åœ¨åˆ†é…çš„å†…å­˜ä¸Šè°ƒç”¨æ„é€ å‡½æ•°ï¼ˆplacement newï¼‰
Test* p = new(mem) Test(10);

// 3ï¸âƒ£ è¿”å›ç±»å‹åŒ–æŒ‡é’ˆ
return p;
```

**deleteçš„æ‰§è¡Œè¿‡ç¨‹ï¼š**
```cpp
delete p;

// ç­‰ä»·äºï¼š
// 1ï¸âƒ£ è°ƒç”¨ææ„å‡½æ•°
p->~Test();

// 2ï¸âƒ£ è°ƒç”¨operator deleteé‡Šæ”¾å†…å­˜
operator delete(p);
```

**mallocåº•å±‚ï¼š**
```cpp
void* malloc(size_t size) {
    // å®é™…åˆ†é… size + 4 å­—èŠ‚
    // å‰4å­—èŠ‚å­˜å‚¨åˆ†é…çš„å¤§å°

    [4å­—èŠ‚ï¼šå¤§å°ä¿¡æ¯][å®é™…æ•°æ®...]
                     â†‘
                  è¿”å›è¿™ä¸ªåœ°å€
}

void free(void* ptr) {
    // å‘å‰åç§»4å­—èŠ‚ï¼Œè¯»å–å¤§å°ä¿¡æ¯
    size_t size = *((size_t*)ptr - 1);
    // é‡Šæ”¾æ•´å—å†…å­˜
}
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ ä¸ºä»€ä¹ˆæ•°ç»„deleteè¦ç”¨delete[]ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
class Test {
public:
    ~Test() { delete[] data; }
    int* data = new int[100];
};

Test* arr = new Test[3];  // åˆ›å»º3ä¸ªå¯¹è±¡

// âŒ é”™è¯¯ï¼šåªè°ƒç”¨ä¸€æ¬¡ææ„
delete arr;
// åªæœ‰arr[0]çš„ææ„è¢«è°ƒç”¨
// arr[1]å’Œarr[2]çš„dataå†…å­˜æ³„æ¼ï¼

// âœ… æ­£ç¡®ï¼šè°ƒç”¨3æ¬¡ææ„
delete[] arr;
// arr[0]ã€arr[1]ã€arr[2]éƒ½æ­£ç¡®ææ„
```

**åŸç†ï¼š**
```
new[]åˆ†é…çš„å†…å­˜å¸ƒå±€ï¼š
[4å­—èŠ‚ï¼šæ•°ç»„å¤§å°] [å¯¹è±¡1] [å¯¹è±¡2] [å¯¹è±¡3]
                  â†‘
               è¿”å›åœ°å€

delete[]: è¯»å–å‰4å­—èŠ‚ï¼ŒçŸ¥é“æœ‰3ä¸ªå¯¹è±¡ï¼Œè°ƒç”¨3æ¬¡ææ„
delete:   ä¸çŸ¥é“æ•°ç»„å¤§å°ï¼Œåªè°ƒç”¨1æ¬¡ææ„
```

#### 2ï¸âƒ£ å¯ä»¥é‡è½½newå’Œdeleteå—ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

âœ… **å¯ä»¥ï¼æœ‰ä¸¤ç§é‡è½½æ–¹å¼**

**æ–¹å¼1ï¼šå…¨å±€é‡è½½**
```cpp
// é‡è½½å…¨å±€operator new
void* operator new(size_t size) {
    cout << "è‡ªå®šä¹‰newï¼Œåˆ†é… " << size << " å­—èŠ‚\n";
    void* p = malloc(size);
    if (!p) throw std::bad_alloc();
    return p;
}

void operator delete(void* p) noexcept {
    cout << "è‡ªå®šä¹‰delete\n";
    free(p);
}

// ä½¿ç”¨
int* p = new int;  // è°ƒç”¨è‡ªå®šä¹‰operator new
delete p;          // è°ƒç”¨è‡ªå®šä¹‰operator delete
```

**æ–¹å¼2ï¼šç±»å†…é‡è½½**
```cpp
class Test {
public:
    // ğŸ”‘ å¿…é¡»æ˜¯staticï¼ˆå³ä½¿ä¸å†™ä¹Ÿæ˜¯staticï¼‰
    static void* operator new(size_t size) {
        cout << "Testçš„operator new\n";
        return malloc(size);
    }

    static void operator delete(void* p) {
        cout << "Testçš„operator delete\n";
        free(p);
    }
};
```

**åº”ç”¨åœºæ™¯ï¼š**
- å†…å­˜æ± ï¼šè‡ªå®šä¹‰å†…å­˜åˆ†é…ç­–ç•¥
- è°ƒè¯•ï¼šè¿½è¸ªå†…å­˜åˆ†é…
- å¯¹é½ï¼šç‰¹å®šçš„å†…å­˜å¯¹é½éœ€æ±‚

#### 3ï¸âƒ£ placement newæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆâ­â­â­â­ï¼‰

**åœ¨å·²åˆ†é…çš„å†…å­˜ä¸Šæ„é€ å¯¹è±¡ï¼š**
```cpp
// 1ï¸âƒ£ å…ˆåˆ†é…å†…å­˜
char buffer[sizeof(Test)];

// 2ï¸âƒ£ åœ¨æŒ‡å®šå†…å­˜ä¸Šæ„é€ å¯¹è±¡
Test* p = new(buffer) Test(10);  // placement new
// ğŸ”‘ ä¸åˆ†é…å†…å­˜ï¼Œåªè°ƒç”¨æ„é€ å‡½æ•°

// 3ï¸âƒ£ ä½¿ç”¨
p->func();

// 4ï¸âƒ£ æ‰‹åŠ¨ææ„ï¼ˆä¸èƒ½ç”¨deleteï¼Œå› ä¸ºå†…å­˜ä¸æ˜¯åŠ¨æ€åˆ†é…çš„ï¼‰
p->~Test();
```

**åº”ç”¨åœºæ™¯ï¼š**
- å†…å­˜æ± ç®¡ç†
- å…±äº«å†…å­˜ä¸­æ„é€ å¯¹è±¡
- é¿å…é‡å¤åˆ†é…é‡Šæ”¾

#### 4ï¸âƒ£ freeå¦‚ä½•çŸ¥é“è¦é‡Šæ”¾å¤šå°‘å†…å­˜ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// mallocå®é™…åˆ†é…çš„å†…å­˜å¸ƒå±€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4å­—èŠ‚ï¼šsize â”‚   ç”¨æˆ·æ•°æ® (sizeå­—èŠ‚)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†‘
         è¿”å›åœ°å€

// freeå®ç°ä¼ªä»£ç 
void free(void* ptr) {
    if (!ptr) return;

    // å‘å‰4å­—èŠ‚è¯»å–å¤§å°
    size_t* p = (size_t*)ptr - 1;
    size_t size = *p;

    // é‡Šæ”¾æ•´å—ï¼ˆåŒ…æ‹¬å‰4å­—èŠ‚ï¼‰
    real_free(p, size + 4);
}
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
newå’Œmallocä¸»è¦æœ‰ä»¥ä¸‹åŒºåˆ«ï¼š

1. æœ¬è´¨ä¸åŒ
   - newæ˜¯C++å…³é”®å­—ï¼Œmallocæ˜¯Cæ ‡å‡†åº“å‡½æ•°

2. æ„é€ å’Œææ„
   - newä¼šè°ƒç”¨æ„é€ å‡½æ•°å’Œææ„å‡½æ•°
   - mallocåªåˆ†é…å†…å­˜ï¼Œä¸è°ƒç”¨æ„é€ /ææ„

3. ç±»å‹å®‰å…¨
   - newè‡ªåŠ¨è®¡ç®—å¤§å°ï¼Œè¿”å›æ­£ç¡®ç±»å‹æŒ‡é’ˆ
   - mallocéœ€è¦æ‰‹åŠ¨è®¡ç®—å¤§å°ï¼Œè¿”å›void*éœ€è¦å¼ºè½¬

4. å¤±è´¥å¤„ç†
   - newå¤±è´¥æŠ›å‡ºbad_allocå¼‚å¸¸
   - mallocå¤±è´¥è¿”å›NULL

5. åº•å±‚å®ç°
   - newåº•å±‚è°ƒç”¨operator newï¼ˆå¯é‡è½½ï¼‰ï¼Œå†è°ƒç”¨æ„é€ å‡½æ•°
   - mallocç›´æ¥å‘ç³»ç»Ÿç”³è¯·å†…å­˜

ã€è¿½é—®-ä¸ºä»€ä¹ˆæ•°ç»„è¦delete[]ã€‘
å› ä¸ºnew[]ä¼šåœ¨å†…å­˜å‰4å­—èŠ‚è®°å½•æ•°ç»„å¤§å°ï¼Œ
delete[]æ ¹æ®è¿™ä¸ªä¿¡æ¯è°ƒç”¨å¤šæ¬¡ææ„ï¼Œ
æ™®é€šdeleteåªè°ƒç”¨ä¸€æ¬¡ææ„ï¼Œå¯¼è‡´å…¶ä»–å¯¹è±¡æ³„æ¼ã€‚

ã€è¿½é—®-å¯ä»¥æ··ç”¨å—ã€‘
ä¸å¯ä»¥ã€‚newå’Œdeleteé…å¯¹ï¼Œmallocå’Œfreeé…å¯¹ã€‚
æ··ç”¨ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸ºnewå’Œmallocå¯ä»¥æ··ç”¨
âœ… **æ­£ç¡®**ï¼šå¿…é¡»é…å¯¹ä½¿ç”¨ï¼Œnewâ†”deleteï¼Œmallocâ†”free

âŒ **é”™è¯¯2**ï¼šnewå¤±è´¥è¿”å›NULL
âœ… **æ­£ç¡®**ï¼šnewå¤±è´¥æŠ›å¼‚å¸¸ï¼Œnew(nothrow)æ‰è¿”å›NULL

âŒ **é”™è¯¯3**ï¼šdelete[]å’Œdeleteå¯ä»¥äº’æ¢
âœ… **æ­£ç¡®**ï¼šæ•°ç»„å¿…é¡»ç”¨delete[]ï¼Œå¦åˆ™åªææ„ç¬¬ä¸€ä¸ªå…ƒç´ 

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°new_handlerï¼ˆå†…å­˜ä¸è¶³æ—¶çš„å›è°ƒï¼‰
- çŸ¥é“nothrowç‰ˆæœ¬ï¼š`new(nothrow) int`
- äº†è§£aligned_allocï¼ˆC++17å¯¹é½åˆ†é…ï¼‰
- æåˆ°è‡ªç”±å­˜å‚¨åŒºå’Œå †çš„åŒºåˆ«ï¼ˆæ¦‚å¿µä¸Šï¼‰

---

## ğŸ“Œ constå…³é”®å­—ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **constæŒ‡é’ˆ** | **æŒ‡å‘constçš„æŒ‡é’ˆ** | **constæˆå‘˜å‡½æ•°** | **ç¼–è¯‘æ—¶æ£€æŸ¥** | **é¡¶å±‚const** | **åº•å±‚const**

### âœ… constçš„äº”ç§ç”¨æ³•

#### 1ï¸âƒ£ ä¿®é¥°å˜é‡
```cpp
const int a = 10;
a = 20;  // âŒ ç¼–è¯‘é”™è¯¯ï¼šä¸èƒ½ä¿®æ”¹constå˜é‡
```

#### 2ï¸âƒ£ ä¿®é¥°æŒ‡é’ˆï¼ˆé‡ç‚¹ï¼ï¼‰
```cpp
// ğŸ”‘ çœ‹conståœ¨*çš„å“ªä¸€è¾¹

// â‘  æŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆï¼ˆpointer to constï¼‰
const int* p1 = &a;
int const* p1 = &a;  // ç­‰ä»·
// ä¸èƒ½ä¿®æ”¹*p1ï¼Œä½†å¯ä»¥ä¿®æ”¹p1æœ¬èº«
*p1 = 20;  // âŒ é”™è¯¯
p1 = &b;   // âœ… æ­£ç¡®

// â‘¡ å¸¸é‡æŒ‡é’ˆï¼ˆconst pointerï¼‰
int* const p2 = &a;
// ä¸èƒ½ä¿®æ”¹p2ï¼Œä½†å¯ä»¥ä¿®æ”¹*p2
*p2 = 20;  // âœ… æ­£ç¡®
p2 = &b;   // âŒ é”™è¯¯

// â‘¢ æŒ‡å‘å¸¸é‡çš„å¸¸é‡æŒ‡é’ˆ
const int* const p3 = &a;
// p3å’Œ*p3éƒ½ä¸èƒ½ä¿®æ”¹
*p3 = 20;  // âŒ é”™è¯¯
p3 = &b;   // âŒ é”™è¯¯

// ğŸ¯ è®°å¿†æŠ€å·§ï¼š
// conståœ¨*å·¦è¾¹ â†’ ä¸èƒ½æ”¹å†…å®¹ï¼ˆ*pï¼‰
// conståœ¨*å³è¾¹ â†’ ä¸èƒ½æ”¹æŒ‡é’ˆï¼ˆpï¼‰
```

#### 3ï¸âƒ£ ä¿®é¥°å¼•ç”¨
```cpp
const int& ref = a;
ref = 20;  // âŒ é”™è¯¯ï¼šä¸èƒ½ä¿®æ”¹constå¼•ç”¨

// ğŸŒŸ constå¼•ç”¨å¯ä»¥ç»‘å®šåˆ°ä¸´æ—¶å¯¹è±¡
const int& r1 = 10;  // âœ… æ­£ç¡®
int& r2 = 10;        // âŒ é”™è¯¯
```

#### 4ï¸âƒ£ ä¿®é¥°æˆå‘˜å‡½æ•°ï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰
```cpp
class Test {
    int value;
public:
    // constæˆå‘˜å‡½æ•°ï¼šä¸èƒ½ä¿®æ”¹æˆå‘˜å˜é‡
    int getValue() const {
        return value;  // âœ… åªè¯»
        // value = 10;  // âŒ ç¼–è¯‘é”™è¯¯
    }

    void setValue(int v) const {
        value = v;  // âŒ ç¼–è¯‘é”™è¯¯
    }
};

const Test t;
t.getValue();   // âœ… constå¯¹è±¡åªèƒ½è°ƒç”¨constæˆå‘˜å‡½æ•°
t.setValue(10); // âŒ é”™è¯¯
```

#### 5ï¸âƒ£ ä¿®é¥°è¿”å›å€¼
```cpp
// è¿”å›constå¼•ç”¨ï¼ˆé¿å…æ‹·è´ï¼‰
const string& getName() const {
    return name;
}

// è¿”å›constæŒ‡é’ˆ
const int* getData() const {
    return data;
}
```

### ğŸ’¡ constæˆå‘˜å‡½æ•°æ·±å…¥ç†è§£ï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

**thisæŒ‡é’ˆçš„constæ€§**
```cpp
class Test {
    int value;
public:
    // éconstæˆå‘˜å‡½æ•°
    void func() {
        // thisç±»å‹: Test* const
        // æŒ‡é’ˆæœ¬èº«æ˜¯constï¼ŒæŒ‡å‘çš„å†…å®¹å¯ä¿®æ”¹
        this->value = 10;  // âœ…
    }

    // constæˆå‘˜å‡½æ•°
    void func() const {
        // thisç±»å‹: const Test* const
        // æŒ‡é’ˆå’Œå†…å®¹éƒ½æ˜¯const
        this->value = 10;  // âŒ é”™è¯¯
    }
};
```

**mutableå…³é”®å­—**
```cpp
class Test {
    mutable int cache;  // ğŸ”‘ mutableä¿®é¥°
    int value;
public:
    void updateCache() const {
        cache = 100;  // âœ… constå‡½æ•°ä¸­å¯ä»¥ä¿®æ”¹mutableæˆå‘˜
        value = 10;   // âŒ ä¸èƒ½ä¿®æ”¹æ™®é€šæˆå‘˜
    }
};

// åº”ç”¨ï¼šç¼“å­˜ã€è®¡æ•°å™¨ç­‰è¾…åŠ©æ•°æ®
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ constå¯¹è±¡è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
class Test {
public:
    void func() {
        cout << "éconstç‰ˆæœ¬";
    }

    void func() const {
        cout << "constç‰ˆæœ¬";
    }
};

Test t1;
t1.func();  // è°ƒç”¨ï¼šéconstç‰ˆæœ¬

const Test t2;
t2.func();  // è°ƒç”¨ï¼šconstç‰ˆæœ¬

// ğŸ”‘ è§„åˆ™ï¼š
// - constå¯¹è±¡ï¼šåªèƒ½è°ƒç”¨constå‡½æ•°
// - éconstå¯¹è±¡ï¼šä¼˜å…ˆè°ƒç”¨éconstå‡½æ•°ï¼Œæ²¡æœ‰åˆ™è°ƒç”¨constå‡½æ•°
```

#### 2ï¸âƒ£ const_castæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// const_cast: ç§»é™¤constå±æ€§ï¼ˆå±é™©ï¼æ…ç”¨ï¼‰

const int a = 10;
const int* p = &a;

// ç§»é™¤const
int* p2 = const_cast<int*>(p);
*p2 = 20;  // âš ï¸ æœªå®šä¹‰è¡Œä¸ºï¼

// âœ… å®‰å…¨çš„ä½¿ç”¨åœºæ™¯ï¼š
void func(const char* str) {
    // å¦‚æœç¡®å®šstræŒ‡å‘éconstå†…å­˜
    char* p = const_cast<char*>(str);
    p[0] = 'A';  // ä¿®æ”¹
}

char buffer[] = "hello";
func(buffer);  // âœ… å®‰å…¨ï¼Œbufferæœ¬èº«éconst
```

#### 3ï¸âƒ£ constå’Œ#defineçš„åŒºåˆ«ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

| ç‰¹æ€§ | const | #define |
|------|-------|---------|
| **ç±»å‹æ£€æŸ¥** | âœ… æœ‰ç±»å‹ | âŒ æ–‡æœ¬æ›¿æ¢ |
| **ä½œç”¨åŸŸ** | âœ… éµå®ˆä½œç”¨åŸŸ | âŒ å…¨å±€æ›¿æ¢ |
| **è°ƒè¯•** | âœ… æœ‰ç¬¦å·è¡¨ | âŒ éš¾è°ƒè¯• |
| **å†…å­˜** | âœ… æœ‰å†…å­˜åœ°å€ | âŒ æ— åœ°å€ |
| **æ—¶æœº** | ç¼–è¯‘æ—¶ | é¢„å¤„ç†æ—¶ |

```cpp
// const: ç±»å‹å®‰å…¨
const int MAX = 100;
int arr[MAX];  // âœ… æ­£ç¡®

// #define: å®¹æ˜“å‡ºé”™
#define MAX 100
#define MIN MAX - 1  // å±é™©
int x = 10 * MIN;  // å®é™…æ˜¯: 10 * 100 - 1 = 999ï¼ˆè€Œä¸æ˜¯90ï¼‰

// è§£å†³ï¼šå¿…é¡»åŠ æ‹¬å·
#define MIN (MAX - 1)
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
constä¸»è¦æœ‰ä»¥ä¸‹ç”¨æ³•ï¼š

1. ä¿®é¥°å˜é‡ï¼šå®šä¹‰å¸¸é‡ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
2. ä¿®é¥°æŒ‡é’ˆï¼š
   - const int* p: ä¸èƒ½æ”¹*pï¼ˆæŒ‡å‘çš„å†…å®¹ï¼‰
   - int* const p: ä¸èƒ½æ”¹pï¼ˆæŒ‡é’ˆæœ¬èº«ï¼‰
3. ä¿®é¥°æˆå‘˜å‡½æ•°ï¼šä¸èƒ½ä¿®æ”¹æˆå‘˜å˜é‡ï¼Œconstå¯¹è±¡åªèƒ½è°ƒç”¨constå‡½æ•°
4. ä¿®é¥°å¼•ç”¨ï¼šå¸¸å¼•ç”¨ï¼Œå¯ä»¥ç»‘å®šä¸´æ—¶å¯¹è±¡

ã€è¿½é—®-constæˆå‘˜å‡½æ•°ã€‘
constæˆå‘˜å‡½æ•°ä¸­ï¼ŒthisæŒ‡é’ˆç±»å‹æ˜¯const Test* constï¼Œ
ä¸èƒ½ä¿®æ”¹æˆå‘˜å˜é‡ã€‚ä½†mutableä¿®é¥°çš„æˆå‘˜é™¤å¤–ã€‚

ã€è¿½é—®-constå’Œ#defineåŒºåˆ«ã€‘
constæœ‰ç±»å‹æ£€æŸ¥ï¼Œéµå®ˆä½œç”¨åŸŸï¼Œæœ‰ç¬¦å·è¡¨ä¾¿äºè°ƒè¯•ã€‚
#defineæ˜¯é¢„å¤„ç†é˜¶æ®µçš„æ–‡æœ¬æ›¿æ¢ï¼Œæ— ç±»å‹æ£€æŸ¥ï¼Œå®¹æ˜“å‡ºé”™ã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸ºconstå˜é‡å®Œå…¨ä¸å¯æ”¹
âœ… **æ­£ç¡®**ï¼šå¯ä»¥é€šè¿‡const_castæˆ–æŒ‡é’ˆä¿®æ”¹ï¼ˆæœªå®šä¹‰è¡Œä¸ºï¼‰

âŒ **é”™è¯¯2**ï¼šconstæˆå‘˜å‡½æ•°ä¸èƒ½ä¿®æ”¹ä»»ä½•ä¸œè¥¿
âœ… **æ­£ç¡®**ï¼šå¯ä»¥ä¿®æ”¹mutableæˆå‘˜ï¼Œå¯ä»¥ä¿®æ”¹å…¨å±€å˜é‡

âŒ **é”™è¯¯3**ï¼šæ··æ·†é¡¶å±‚constå’Œåº•å±‚const
âœ… **æ­£ç¡®**ï¼šé¡¶å±‚constä¿®é¥°æŒ‡é’ˆæœ¬èº«ï¼Œåº•å±‚constä¿®é¥°æŒ‡å‘çš„å¯¹è±¡

---

## STLå®¹å™¨

## ğŸ“Œ vectoråº•å±‚å®ç°ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **åŠ¨æ€æ•°ç»„** | **è¿ç»­å†…å­˜** | **capacity** | **size** | **æ‰©å®¹æœºåˆ¶** | **æˆå€å¢é•¿** | **è¿­ä»£å™¨å¤±æ•ˆ** | **å‡æ‘ŠO(1)**

### âœ… æ ¸å¿ƒç»“æ„

```cpp
template<typename T>
class vector {
private:
    T* _start;      // æ•°ç»„èµ·å§‹ä½ç½®
    T* _finish;     // å½“å‰ä½¿ç”¨çš„æœ«å°¾
    T* _end;        // åˆ†é…çš„å†…å­˜æœ«å°¾

public:
    size_t size() const { return _finish - _start; }
    size_t capacity() const { return _end - _start; }
};

// å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  elem1 â”‚  elem2 â”‚  elem3 â”‚  (ç©º)  â”‚  (ç©º)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†‘                          â†‘                 â†‘
_start                  _finish            _end
|<------- size -------->|
|<----------- capacity ------------->|
```

### ğŸ’¡ æ‰©å®¹æœºåˆ¶ï¼ˆâ­â­â­â­â­ é«˜é¢‘è¿½é—®ï¼‰

**ä¸ºä»€ä¹ˆæˆå€æ‰©å®¹ï¼Ÿ**

```cpp
// å‡è®¾æ‰©å®¹å› å­ä¸ºmï¼Œéœ€è¦æ’å…¥nä¸ªå…ƒç´ 

// ç¬¬1æ¬¡æ‰©å®¹ï¼šå¤åˆ¶ m^0 = 1 ä¸ªå…ƒç´ 
// ç¬¬2æ¬¡æ‰©å®¹ï¼šå¤åˆ¶ m^1 = m ä¸ªå…ƒç´ 
// ç¬¬3æ¬¡æ‰©å®¹ï¼šå¤åˆ¶ m^2 ä¸ªå…ƒç´ 
// ...
// ç¬¬kæ¬¡æ‰©å®¹ï¼šå¤åˆ¶ m^(k-1) ä¸ªå…ƒç´ 

// æ€»å¤åˆ¶æ¬¡æ•° = 1 + m + m^2 + ... + m^(k-1)
//           = (m^k - 1) / (m - 1)  ï¼ˆç­‰æ¯”æ•°åˆ—æ±‚å’Œï¼‰
//           â‰ˆ n (å› ä¸º m^k â‰ˆ n)

// å¹³å‡æ¯æ¬¡æ’å…¥å¤åˆ¶æ¬¡æ•° = n / n = O(1) âœ… å‡æ‘Šå¸¸æ•°æ—¶é—´ï¼
```

**å¦‚æœå›ºå®šå¢é•¿å‘¢ï¼Ÿ**
```cpp
// å‡è®¾æ¯æ¬¡+100ï¼Œæ’å…¥10000ä¸ªå…ƒç´ 

// æ‰©å®¹100æ¬¡ï¼Œæ¯æ¬¡å¤åˆ¶100ã€200ã€300...10000ä¸ªå…ƒç´ 
// æ€»å¤åˆ¶æ¬¡æ•° = 100 + 200 + ... + 10000
//           = 100 * (1 + 2 + ... + 100)
//           = 100 * 5050 = 505000

// å¹³å‡æ¯æ¬¡æ’å…¥ = 505000 / 10000 = 50.5æ¬¡å¤åˆ¶ âŒ O(n)!
```

ğŸ”‘ **ç»“è®ºï¼šæˆå€å¢é•¿ â†’ å‡æ‘ŠO(1)ï¼Œå›ºå®šå¢é•¿ â†’ å‡æ‘ŠO(n)**

### ğŸ’» ä»£ç å®ç°

**push_backå®ç°ï¼š**
```cpp
void push_back(const T& value) {
    if (_finish == _end) {  // ğŸ”‘ å®¹é‡ä¸è¶³ï¼Œéœ€è¦æ‰©å®¹
        // è®¡ç®—æ–°å®¹é‡ï¼ˆé€šå¸¸æ˜¯2å€ï¼‰
        size_t oldCap = capacity();
        size_t newCap = (oldCap == 0) ? 1 : oldCap * 2;

        // åˆ†é…æ–°å†…å­˜
        T* newStart = new T[newCap];

        // æ‹·è´æ—§æ•°æ®
        for (size_t i = 0; i < size(); ++i) {
            newStart[i] = _start[i];
        }

        // é‡Šæ”¾æ—§å†…å­˜
        delete[] _start;

        // æ›´æ–°æŒ‡é’ˆ
        _start = newStart;
        _finish = _start + oldSize;
        _end = _start + newCap;
    }

    // åœ¨æœ«å°¾æ„é€ æ–°å…ƒç´ 
    *_finish = value;
    ++_finish;
}
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ è¿­ä»£å™¨å¤±æ•ˆçš„æƒ…å†µï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
vector<int> v = {1, 2, 3, 4, 5};

// âŒ æƒ…å†µ1ï¼šæ’å…¥å¯¼è‡´æ‰©å®¹
auto it = v.begin();
v.push_back(6);  // å¯èƒ½æ‰©å®¹ï¼Œé‡æ–°åˆ†é…å†…å­˜
*it;  // âŒ itå¤±æ•ˆï¼æŒ‡å‘æ—§å†…å­˜

// âŒ æƒ…å†µ2ï¼šåˆ é™¤å…ƒç´ 
auto it2 = v.begin() + 2;  // æŒ‡å‘3
v.erase(it2);  // åˆ é™¤3
*it2;  // âŒ it2å¤±æ•ˆï¼

// âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨eraseçš„è¿”å›å€¼
for (auto it = v.begin(); it != v.end(); ) {
    if (*it == 3) {
        it = v.erase(it);  // eraseè¿”å›ä¸‹ä¸€ä¸ªæœ‰æ•ˆè¿­ä»£å™¨
    } else {
        ++it;
    }
}

// âŒ æƒ…å†µ3ï¼šswap
vector<int> v2;
auto it3 = v.begin();
v.swap(v2);
*it3;  // âŒ it3å¤±æ•ˆ
```

**æ€»ç»“ï¼š**
- æ’å…¥ï¼šå¯èƒ½å…¨éƒ¨å¤±æ•ˆï¼ˆæ‰©å®¹æ—¶ï¼‰
- åˆ é™¤ï¼šåˆ é™¤ç‚¹ä¹‹åå…¨éƒ¨å¤±æ•ˆ
- swapï¼šå…¨éƒ¨å¤±æ•ˆ

#### 2ï¸âƒ£ reserveå’Œresizeçš„åŒºåˆ«ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
vector<int> v;

// reserve: åªæ”¹capacityï¼Œä¸æ”¹size
v.reserve(100);
cout << v.size();      // 0
cout << v.capacity();  // 100
v[0] = 10;  // âŒ è¶Šç•Œï¼sizeè¿˜æ˜¯0

// resize: åŒæ—¶æ”¹sizeå’Œcapacity
v.resize(100);
cout << v.size();      // 100
cout << v.capacity();  // â‰¥100
v[0] = 10;  // âœ… æ­£ç¡®

// resizeè¿˜ä¼šåˆå§‹åŒ–å…ƒç´ 
v.resize(100, 42);  // æ‰€æœ‰å…ƒç´ åˆå§‹åŒ–ä¸º42
```

**ä½¿ç”¨åœºæ™¯ï¼š**
```cpp
// é¢„çŸ¥å¤§å°ï¼Œé¿å…å¤šæ¬¡æ‰©å®¹
vector<int> v;
v.reserve(10000);  // ğŸŒŸ ä¸€æ¬¡æ€§åˆ†é…ï¼Œé¿å…å¤šæ¬¡æ‰©å®¹
for (int i = 0; i < 10000; ++i) {
    v.push_back(i);  // ä¸ä¼šæ‰©å®¹
}
```

#### 3ï¸âƒ£ vector<bool>ä¸ºä»€ä¹ˆç‰¹æ®Šï¼Ÿï¼ˆâ­â­â­ï¼‰

```cpp
vector<bool> v = {true, false, true};

// âŒ vector<bool>ä¸æ˜¯çœŸæ­£çš„vector
bool* p = &v[0];  // ç¼–è¯‘é”™è¯¯ï¼

// åŸå› ï¼švector<bool>çš„ç‰¹åŒ–ç‰ˆæœ¬
// å†…éƒ¨ç”¨bitä½å­˜å‚¨ï¼Œæ¯ä¸ªboolåªå 1bitï¼Œè€Œä¸æ˜¯1byte
// 8ä¸ªboolå…±äº«1ä¸ªbyte

// é—®é¢˜ï¼š
auto x = v[0];  // xä¸æ˜¯bool&ï¼Œæ˜¯ä»£ç†ç±»
x = false;      // ä¸ä¼šä¿®æ”¹v[0]ï¼

// è§£å†³ï¼šä¸è¦ç”¨vector<bool>ï¼Œç”¨deque<bool>æˆ–bitset
```

#### 4ï¸âƒ£ å¦‚ä½•é‡Šæ”¾vectorçš„å†…å­˜ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
vector<int> v(10000);
v.clear();  // âŒ åªæ¸…ç©ºå…ƒç´ ï¼Œä¸é‡Šæ”¾å†…å­˜
cout << v.capacity();  // ä»ç„¶æ˜¯10000

// âœ… æ–¹æ³•1ï¼šswapæŠ€å·§
vector<int>().swap(v);  // ç”¨ç©ºvectoräº¤æ¢
cout << v.capacity();  // 0

// âœ… æ–¹æ³•2ï¼šshrink_to_fit (C++11)
v.shrink_to_fit();  // è¯·æ±‚é‡Šæ”¾å¤šä½™å†…å­˜ï¼ˆä¸ä¿è¯ï¼‰

// âœ… æ–¹æ³•3ï¼šç§»åŠ¨åˆ°å±€éƒ¨ä½œç”¨åŸŸ
{
    vector<int> temp(std::move(v));
}  // tempç¦»å¼€ä½œç”¨åŸŸï¼Œé‡Šæ”¾å†…å­˜
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
vectoræ˜¯åŠ¨æ€æ•°ç»„ï¼Œåº•å±‚æ˜¯ä¸€å—è¿ç»­å†…å­˜ã€‚

æ ¸å¿ƒæˆå‘˜ï¼š
- _start: æ•°ç»„èµ·å§‹ä½ç½®
- _finish: å½“å‰ä½¿ç”¨çš„æœ«å°¾
- _end: åˆ†é…çš„å†…å­˜æœ«å°¾

æ‰©å®¹æœºåˆ¶ï¼š
- å½“size==capacityæ—¶ï¼Œåˆ†é…æ–°å†…å­˜ï¼ˆé€šå¸¸2å€ï¼‰
- æ‹·è´æ‰€æœ‰å…ƒç´ åˆ°æ–°å†…å­˜
- é‡Šæ”¾æ—§å†…å­˜
- å‡æ‘Šæ—¶é—´å¤æ‚åº¦O(1)

ã€è¿½é—®-ä¸ºä»€ä¹ˆæˆå€æ‰©å®¹ã€‘
æˆå€æ‰©å®¹ä¿è¯å‡æ‘ŠO(1)æ’å…¥ã€‚
å¦‚æœå›ºå®šå¢é•¿ï¼ˆå¦‚æ¯æ¬¡+100ï¼‰ï¼Œå‡æ‘Šå¤æ‚åº¦æ˜¯O(n)ã€‚

ã€è¿½é—®-è¿­ä»£å™¨å¤±æ•ˆã€‘
ä¸‰ç§æƒ…å†µï¼š
1. æ’å…¥å¯èƒ½æ‰©å®¹ï¼Œå…¨éƒ¨å¤±æ•ˆ
2. åˆ é™¤ï¼Œåˆ é™¤ç‚¹ä¹‹åå¤±æ•ˆ
3. swapï¼Œå…¨éƒ¨å¤±æ•ˆ

è§£å†³ï¼šä½¿ç”¨eraseè¿”å›å€¼ï¼Œæˆ–é‡æ–°è·å–è¿­ä»£å™¨ã€‚

ã€è¿½é—®-å¦‚ä½•å‡å°‘æ‰©å®¹ã€‘
é¢„å…ˆreserveè¶³å¤Ÿå¤§å°ï¼Œé¿å…å¤šæ¬¡æ‰©å®¹å’Œæ‹·è´ã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šclear()ä¼šé‡Šæ”¾å†…å­˜
âœ… **æ­£ç¡®**ï¼šclear()åªæ¸…ç©ºå…ƒç´ ï¼Œcapacityä¸å˜

âŒ **é”™è¯¯2**ï¼šreserve(n)åå¯ä»¥ç›´æ¥ç”¨ä¸‹æ ‡è®¿é—®
âœ… **æ­£ç¡®**ï¼šreserveä¸æ”¹sizeï¼Œè¦ç”¨push_backæˆ–resize

âŒ **é”™è¯¯3**ï¼šè¿­ä»£å™¨æ°¸è¿œæœ‰æ•ˆ
âœ… **æ­£ç¡®**ï¼šæ’å…¥ã€åˆ é™¤ã€æ‰©å®¹éƒ½å¯èƒ½å¯¼è‡´å¤±æ•ˆ

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°emplace_backæ¯”push_backæ€§èƒ½æ›´å¥½ï¼ˆå‡å°‘æ‹·è´ï¼‰
- çŸ¥é“vectorçš„å†…å­˜ä¸ä¼šè‡ªåŠ¨æ”¶ç¼©
- äº†è§£vectorçš„å¼‚å¸¸å®‰å…¨æ€§ï¼ˆå¼ºå¼‚å¸¸ä¿è¯ï¼‰
- æåˆ°å°å¯¹è±¡ä¼˜åŒ–(SSO)åœ¨æŸäº›å®ç°ä¸­çš„åº”ç”¨

---

## ğŸ“Œ çº¢é»‘æ ‘ï¼ˆâ­â­â­â­ é«˜é¢‘ï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **å¹³è¡¡äºŒå‰æœç´¢æ ‘** | **5æ¡æ€§è´¨** | **O(logn)** | **å˜è‰²** | **æ—‹è½¬** | **map/setåº•å±‚** | **é»‘é«˜**

### âœ… çº¢é»‘æ ‘5æ¡æ€§è´¨

```cpp
1ï¸âƒ£ èŠ‚ç‚¹æ˜¯çº¢è‰²æˆ–é»‘è‰²
2ï¸âƒ£ æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²
3ï¸âƒ£ å¶å­èŠ‚ç‚¹(NULL)æ˜¯é»‘è‰²
4ï¸âƒ£ çº¢è‰²èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²ï¼ˆä¸èƒ½æœ‰è¿ç»­çš„çº¢èŠ‚ç‚¹ï¼‰
5ï¸âƒ£ ä»ä»»ä¸€èŠ‚ç‚¹åˆ°å¶å­çš„æ‰€æœ‰è·¯å¾„åŒ…å«ç›¸åŒæ•°é‡çš„é»‘èŠ‚ç‚¹ï¼ˆé»‘é«˜ï¼‰

ğŸ”‘ æ ¸å¿ƒï¼šä¿è¯æœ€é•¿è·¯å¾„ â‰¤ 2 Ã— æœ€çŸ­è·¯å¾„
```

**ç¤ºä¾‹ï¼š**
```
           (10é»‘)
          /      \
      (5çº¢)      (15çº¢)
      /  \        /   \
  (3é»‘)(7é»‘) (12é»‘)(18é»‘)

è·¯å¾„1: 10â†’5â†’3â†’NULLï¼Œé»‘èŠ‚ç‚¹æ•°=3
è·¯å¾„2: 10â†’15â†’12â†’NULLï¼Œé»‘èŠ‚ç‚¹æ•°=3
è·¯å¾„3: 10â†’5â†’7â†’NULLï¼Œé»‘èŠ‚ç‚¹æ•°=3
âœ… æ‰€æœ‰è·¯å¾„é»‘èŠ‚ç‚¹æ•°ç›¸åŒ
```

### ğŸ’¡ ä¸ºä»€ä¹ˆç”¨çº¢é»‘æ ‘ï¼Ÿï¼ˆâ­â­â­â­â­ é«˜é¢‘è¿½é—®ï¼‰

**çº¢é»‘æ ‘ vs AVLæ ‘ï¼š**

| ç‰¹æ€§ | çº¢é»‘æ ‘ | AVLæ ‘ |
|------|-------|-------|
| **å¹³è¡¡æ€§** | è¿‘ä¼¼å¹³è¡¡ | ä¸¥æ ¼å¹³è¡¡ |
| **é«˜åº¦** | â‰¤ 2log(n+1) | â‰¤ 1.44log(n+2) |
| **æ’å…¥** | æœ€å¤š3æ¬¡æ—‹è½¬ | å¯èƒ½å¤šæ¬¡æ—‹è½¬ |
| **åˆ é™¤** | æœ€å¤š3æ¬¡æ—‹è½¬ | å¯èƒ½å¤šæ¬¡æ—‹è½¬ |
| **æŸ¥æ‰¾** | ç¨æ…¢ | æ›´å¿« |
| **é€‚ç”¨** | æ’å…¥åˆ é™¤å¤š | æŸ¥è¯¢å¤š |

```cpp
// AVL: ä¸¥æ ¼å¹³è¡¡ï¼Œå·¦å³å­æ ‘é«˜åº¦å·®â‰¤1
      10
     /  \
    5    15    // é«˜åº¦å·® = |1-1| = 0 âœ…
   /
  3

// çº¢é»‘æ ‘: è¿‘ä¼¼å¹³è¡¡ï¼Œæœ€é•¿â‰¤2Ã—æœ€çŸ­
      10(é»‘)
     /      \
   5(çº¢)   15(é»‘)  // å¯ä»¥æœ‰é«˜åº¦å·®ï¼Œä½†æ€»ä½“å¹³è¡¡
  /  \
3(é»‘) 7(é»‘)
```

ğŸ”‘ **ç»“è®ºï¼š**
- **æŸ¥è¯¢ä¸ºä¸»**ï¼šAVLæ ‘æ›´ä¼˜ï¼ˆæ›´å¹³è¡¡ï¼‰
- **æ’åˆ ä¸ºä¸»**ï¼šçº¢é»‘æ ‘æ›´ä¼˜ï¼ˆæ—‹è½¬å°‘ï¼‰
- **STLçš„é€‰æ‹©**ï¼šmap/setç”¨çº¢é»‘æ ‘ï¼ˆæ’åˆ æŸ¥ç»¼åˆè€ƒè™‘ï¼‰

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ æ’å…¥èŠ‚ç‚¹ä»€ä¹ˆé¢œè‰²ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

ğŸ”´ **æ–°æ’å…¥èŠ‚ç‚¹ä¸€å®šæ˜¯çº¢è‰²ï¼**

**åŸå› ï¼š**
```
å¦‚æœæ’å…¥é»‘è‰²ï¼š
âŒ ç ´åæ€§è´¨5ï¼ˆæ‰€æœ‰è·¯å¾„é»‘èŠ‚ç‚¹æ•°ç›¸åŒï¼‰
   ä¿®å¤æˆæœ¬é«˜ï¼Œéœ€è¦è°ƒæ•´æ•´æ£µæ ‘

å¦‚æœæ’å…¥çº¢è‰²ï¼š
âœ… åªå¯èƒ½ç ´åæ€§è´¨4ï¼ˆçº¢è‰²èŠ‚ç‚¹å­èŠ‚ç‚¹æ˜¯é»‘è‰²ï¼‰
   ä¿®å¤æˆæœ¬ä½ï¼Œæœ€å¤š3æ¬¡æ—‹è½¬
```

**æ’å…¥åçš„ä¿®å¤ï¼š**
```cpp
// Case 1: å”å”èŠ‚ç‚¹æ˜¯çº¢è‰²
// è§£å†³ï¼šçˆ¶äº²å’Œå”å”å˜é»‘ï¼Œçˆ·çˆ·å˜çº¢ï¼Œç»§ç»­å‘ä¸Šè°ƒæ•´
      G(é»‘)                  G(çº¢)
     /    \      â†’         /    \
  P(çº¢)   U(çº¢)         P(é»‘)   U(é»‘)
   /                     /
 N(çº¢)                 N(çº¢)

// Case 2: å”å”æ˜¯é»‘è‰²ï¼ŒNæ˜¯å³å­©å­
// è§£å†³ï¼šå·¦æ—‹ï¼Œè½¬æ¢ä¸ºCase3
    G(é»‘)              G(é»‘)
   /    \             /    \
 P(çº¢)  U(é»‘)  â†’   N(çº¢)  U(é»‘)
    \               /
   N(çº¢)         P(çº¢)

// Case 3: å”å”æ˜¯é»‘è‰²ï¼ŒNæ˜¯å·¦å­©å­
// è§£å†³ï¼šå³æ—‹+å˜è‰²
    G(é»‘)              P(é»‘)
   /    \      â†’      /    \
 P(çº¢)  U(é»‘)       N(çº¢)  G(çº¢)
 /                           \
N(çº¢)                        U(é»‘)
```

#### 2ï¸âƒ£ æœ€å¤šæ—‹è½¬å‡ æ¬¡ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

- **æ’å…¥**ï¼šæœ€å¤š2æ¬¡æ—‹è½¬
- **åˆ é™¤**ï¼šæœ€å¤š3æ¬¡æ—‹è½¬

ğŸ”‘ **å¾—åˆ†ç‚¹ï¼šèƒ½è¯´å‡ºå…·ä½“æ¬¡æ•°**

#### 3ï¸âƒ£ ä¸ºä»€ä¹ˆä¸ç”¨Bæ ‘ï¼Ÿï¼ˆâ­â­â­ï¼‰

```
Bæ ‘ï¼šå¤šå‰å¹³è¡¡æ ‘ï¼ŒèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªkey
é€‚ç”¨åœºæ™¯ï¼šç£ç›˜å­˜å‚¨ï¼Œå‡å°‘IOæ¬¡æ•°

çº¢é»‘æ ‘ï¼šäºŒå‰æ ‘ï¼Œæ‰€æœ‰æ•°æ®åœ¨å†…å­˜
ä¼˜åŠ¿ï¼š
1. å†…å­˜ä¸­ï¼ŒäºŒå‰æ ‘å±€éƒ¨æ€§æ›´å¥½ï¼ˆç¼“å­˜å‹å¥½ï¼‰
2. å®ç°ç®€å•
3. å¸¸æ•°å› å­å°

ğŸ”‘ æ•°æ®åº“ç´¢å¼•ç”¨B+æ ‘ï¼ˆç£ç›˜ï¼‰ï¼ŒSTLç”¨çº¢é»‘æ ‘ï¼ˆå†…å­˜ï¼‰
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
çº¢é»‘æ ‘æ˜¯ä¸€ç§å¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼Œä¿è¯5æ¡æ€§è´¨ï¼š
1. èŠ‚ç‚¹çº¢æˆ–é»‘
2. æ ¹æ˜¯é»‘è‰²
3. å¶å­(NULL)æ˜¯é»‘è‰²
4. çº¢è‰²èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ˜¯é»‘è‰²
5. ä»»æ„èŠ‚ç‚¹åˆ°å¶å­çš„è·¯å¾„ï¼Œé»‘èŠ‚ç‚¹æ•°ç›¸åŒ

æ—¶é—´å¤æ‚åº¦ï¼šæŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤éƒ½æ˜¯O(logn)

ã€è¿½é—®-ä¸ºä»€ä¹ˆç”¨çº¢é»‘æ ‘ä¸ç”¨AVLã€‘
çº¢é»‘æ ‘æ˜¯è¿‘ä¼¼å¹³è¡¡ï¼Œæ’å…¥åˆ é™¤æœ€å¤šæ—‹è½¬3æ¬¡ã€‚
AVLæ˜¯ä¸¥æ ¼å¹³è¡¡ï¼Œå¯èƒ½å¤šæ¬¡æ—‹è½¬ã€‚
STLé€‰æ‹©çº¢é»‘æ ‘ï¼Œå› ä¸ºæ’åˆ æŸ¥ç»¼åˆæ€§èƒ½æ›´å¥½ã€‚

ã€è¿½é—®-æ–°èŠ‚ç‚¹ä»€ä¹ˆé¢œè‰²ã€‘
çº¢è‰²ã€‚å¦‚æœæ’å…¥é»‘è‰²ä¼šç ´åæ‰€æœ‰è·¯å¾„é»‘èŠ‚ç‚¹æ•°ç›¸åŒçš„æ€§è´¨ï¼Œ
ä¿®å¤ä»£ä»·å¤§ã€‚æ’å…¥çº¢è‰²åªå¯èƒ½ç ´åä¸èƒ½æœ‰è¿ç»­çº¢èŠ‚ç‚¹çš„æ€§è´¨ï¼Œ
é€šè¿‡å˜è‰²å’Œæ—‹è½¬ï¼ˆæœ€å¤š2æ¬¡ï¼‰å°±èƒ½ä¿®å¤ã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸ºçº¢é»‘æ ‘å®Œå…¨å¹³è¡¡
âœ… **æ­£ç¡®**ï¼šè¿‘ä¼¼å¹³è¡¡ï¼Œæœ€é•¿â‰¤2Ã—æœ€çŸ­

âŒ **é”™è¯¯2**ï¼šä»¥ä¸ºæ’å…¥åˆ é™¤æ€»æ˜¯è¦æ—‹è½¬
âœ… **æ­£ç¡®**ï¼šå¾ˆå¤šæƒ…å†µåªéœ€å˜è‰²ï¼Œä¸éœ€è¦æ—‹è½¬

âŒ **é”™è¯¯3**ï¼šæ··æ·†çº¢é»‘æ ‘å’ŒAVLæ ‘
âœ… **æ­£ç¡®**ï¼šçº¢é»‘æ ‘ç‰ºç‰²å¹³è¡¡æ€§æ¢å–æ’åˆ æ€§èƒ½

---

## ğŸ“Œ RTTIä¸ç±»å‹è½¬æ¢ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **RTTI** | **dynamic_cast** | **typeid** | **type_info** | **static_cast** | **const_cast** | **reinterpret_cast** | **å‘ä¸‹è½¬å‹**

### âœ… RTTIï¼ˆè¿è¡Œæ—¶ç±»å‹è¯†åˆ«ï¼‰

```cpp
class Base {
public:
    virtual ~Base() {}  // ğŸ”‘ å¿…é¡»æœ‰è™šå‡½æ•°æ‰èƒ½ä½¿ç”¨RTTI
};

class Derived : public Base {};

int main() {
    Base* p = new Derived();

    // typeid: è·å–ç±»å‹ä¿¡æ¯
    cout << typeid(*p).name();  // è¾“å‡ºï¼šDerivedï¼ˆå®é™…ç±»å‹ï¼‰
    cout << typeid(p).name();   // è¾“å‡ºï¼šBase*ï¼ˆæŒ‡é’ˆç±»å‹ï¼‰

    // æ¯”è¾ƒç±»å‹
    if (typeid(*p) == typeid(Derived)) {
        cout << "pæŒ‡å‘Derivedå¯¹è±¡\n";
    }
}
```

**type_infoåœ¨è™šè¡¨ä¸­çš„ä½ç½®ï¼š**
```
è™šå‡½æ•°è¡¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ offset_to_top: 0     â”‚
â”‚ &type_info(Derived)  â”‚  â† RTTIä¿¡æ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ &Derived::~Derived   â”‚  â† vptræŒ‡å‘è¿™é‡Œ
â”‚ &Derived::func1      â”‚
â”‚ &Derived::func2      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ’¡ å››ç§ç±»å‹è½¬æ¢ï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

#### 1ï¸âƒ£ static_castï¼ˆé™æ€è½¬æ¢ï¼‰

```cpp
// ğŸ”‘ ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œæ²¡æœ‰è¿è¡Œæ—¶å¼€é”€

// âœ… åŸºæœ¬ç±»å‹è½¬æ¢
double d = 3.14;
int i = static_cast<int>(d);  // 3

// âœ… å‘ä¸Šè½¬å‹ï¼ˆå®‰å…¨ï¼‰
Derived* d = new Derived();
Base* b = static_cast<Base*>(d);  // å®‰å…¨

// âš ï¸ å‘ä¸‹è½¬å‹ï¼ˆä¸å®‰å…¨ï¼‰
Base* b = new Base();
Derived* d = static_cast<Derived*>(b);  // ç¼–è¯‘é€šè¿‡ï¼Œè¿è¡Œæ—¶æœªå®šä¹‰è¡Œä¸º

// âœ… void*è½¬æ¢
void* vp = malloc(sizeof(int));
int* ip = static_cast<int*>(vp);

// âŒ ä¸èƒ½å»é™¤const
const int x = 10;
// int* p = static_cast<int*>(&x);  // ç¼–è¯‘é”™è¯¯
```

#### 2ï¸âƒ£ dynamic_castï¼ˆåŠ¨æ€è½¬æ¢ï¼‰â­â­â­â­â­

```cpp
// ğŸ”‘ è¿è¡Œæ—¶æ£€æŸ¥ï¼Œéœ€è¦RTTIæ”¯æŒï¼ˆç±»å¿…é¡»æœ‰è™šå‡½æ•°ï¼‰

class Base {
public:
    virtual ~Base() {}
};

class Derived : public Base {
public:
    void derivedFunc() { cout << "Derived\n"; }
};

// å‘ä¸‹è½¬å‹ï¼ˆdowncastï¼‰
Base* b = new Derived();

// âœ… å®‰å…¨çš„å‘ä¸‹è½¬å‹
Derived* d = dynamic_cast<Derived*>(b);
if (d != nullptr) {  // è½¬æ¢æˆåŠŸ
    d->derivedFunc();
} else {  // è½¬æ¢å¤±è´¥
    cout << "è½¬æ¢å¤±è´¥\n";
}

// å¤±è´¥ç¤ºä¾‹
Base* b2 = new Base();
Derived* d2 = dynamic_cast<Derived*>(b2);  // d2 == nullptr

// å¼•ç”¨ç‰ˆæœ¬
try {
    Derived& dr = dynamic_cast<Derived&>(*b);
} catch (std::bad_cast& e) {
    cout << "è½¬æ¢å¤±è´¥ï¼ŒæŠ›å¼‚å¸¸\n";  // å¼•ç”¨è½¬æ¢å¤±è´¥æŠ›å¼‚å¸¸
}
```

**dynamic_caståº•å±‚å®ç°ï¼š**
```cpp
// ä¼ªä»£ç 
template<typename Target, typename Source>
Target* dynamic_cast(Source* src) {
    if (src == nullptr) return nullptr;

    // 1. è·å–æºå¯¹è±¡çš„type_infoï¼ˆé€šè¿‡vptrè®¿é—®è™šè¡¨ï¼‰
    void** vtable = *(void***)src;
    type_info* src_type = (type_info*)(vtable[-1]);

    // 2. æ£€æŸ¥æ˜¯å¦å¯ä»¥è½¬æ¢åˆ°ç›®æ ‡ç±»å‹
    if (src_type->can_cast_to(typeid(Target))) {
        return static_cast<Target*>(src);
    }

    // 3. è½¬æ¢å¤±è´¥
    return nullptr;
}
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
```
static_cast:
- ç¼–è¯‘æ—¶æ£€æŸ¥
- é›¶è¿è¡Œæ—¶å¼€é”€
- ä¸å®‰å…¨ï¼ˆå‘ä¸‹è½¬å‹ï¼‰

dynamic_cast:
- è¿è¡Œæ—¶æ£€æŸ¥
- éœ€è¦æŸ¥è¯¢è™šè¡¨ä¸­çš„type_info
- çº¦10-50ä¸ªæ—¶é’Ÿå‘¨æœŸå¼€é”€
- å®‰å…¨ï¼ˆå¤±è´¥è¿”å›nullptrï¼‰
```

#### 3ï¸âƒ£ const_castï¼ˆå¸¸é‡è½¬æ¢ï¼‰

```cpp
// ğŸ”‘ å”¯ä¸€èƒ½å»é™¤constçš„è½¬æ¢

const int x = 10;
int* p = const_cast<int*>(&x);
*p = 20;  // âš ï¸ æœªå®šä¹‰è¡Œä¸ºï¼ˆxæœ¬èº«æ˜¯constï¼‰

// âœ… å®‰å…¨ä½¿ç”¨åœºæ™¯
void func(const char* str) {
    // æ˜ç¡®çŸ¥é“stræŒ‡å‘çš„å†…å­˜æ˜¯éconstçš„
    char* p = const_cast<char*>(str);
    p[0] = 'A';  // ä¿®æ”¹
}

char buffer[] = "hello";
func(buffer);  // å®‰å…¨

// âŒ ä¸å®‰å…¨
const char* literal = "hello";
func(literal);  // æœªå®šä¹‰è¡Œä¸ºï¼ˆå­—ç¬¦ä¸²å­—é¢é‡åœ¨åªè¯»åŒºï¼‰

// å»é™¤volatile
volatile int y = 10;
int* py = const_cast<int*>(&y);
```

#### 4ï¸âƒ£ reinterpret_castï¼ˆé‡æ–°è§£é‡Šè½¬æ¢ï¼‰

```cpp
// ğŸ”‘ æœ€å±é™©çš„è½¬æ¢ï¼Œç›´æ¥é‡æ–°è§£é‡Šå†…å­˜

// âœ… æŒ‡é’ˆç±»å‹è½¬æ¢
int x = 10;
int* p = &x;
char* cp = reinterpret_cast<char*>(p);  // æŠŠint*å½“char*ç”¨

// âœ… æŒ‡é’ˆå’Œæ•´æ•°äº’è½¬
uintptr_t addr = reinterpret_cast<uintptr_t>(p);
int* p2 = reinterpret_cast<int*>(addr);

// âš ï¸ å¸¸è§ç”¨æ³•ï¼šè®¿é—®å†…å­˜çš„å­—èŠ‚è¡¨ç¤º
float f = 3.14f;
uint32_t bits = *reinterpret_cast<uint32_t*>(&f);
// ä»¥æ•´æ•°å½¢å¼æŸ¥çœ‹æµ®ç‚¹æ•°çš„ä½æ¨¡å¼

// âŒ å±é™©ç¤ºä¾‹
int arr[10];
double* dp = reinterpret_cast<double*>(arr);  // ç±»å‹ä¸å…¼å®¹
*dp = 3.14;  // æœªå®šä¹‰è¡Œä¸º
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ ä»€ä¹ˆæ—¶å€™ç”¨å“ªç§castï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
// static_cast: æ˜ç¡®çš„ã€å®‰å…¨çš„ç±»å‹è½¬æ¢
double d = 3.14;
int i = static_cast<int>(d);  // âœ… åŸºæœ¬ç±»å‹è½¬æ¢

Derived* d = new Derived();
Base* b = static_cast<Base*>(d);  // âœ… å‘ä¸Šè½¬å‹ï¼ˆå®‰å…¨ï¼‰

// dynamic_cast: ä¸ç¡®å®šçš„å‘ä¸‹è½¬å‹
Base* b = getObject();
if (auto d = dynamic_cast<Derived*>(b)) {  // âœ… å®‰å…¨æ£€æŸ¥
    d->derivedFunc();
}

// const_cast: éœ€è¦å»é™¤constï¼ˆæ˜ç¡®çŸ¥é“å®‰å…¨ï¼‰
void legacyAPI(char* str);  // è€APIä¸æ¥å—const
const char* myStr = "test";
legacyAPI(const_cast<char*>(myStr));  // âš ï¸ è°¨æ…ä½¿ç”¨

// reinterpret_cast: åº•å±‚æ“ä½œï¼ˆåºåˆ—åŒ–ã€ç½‘ç»œç¼–ç¨‹ï¼‰
struct Packet {
    int type;
    int data;
};
Packet p = {1, 100};
char* bytes = reinterpret_cast<char*>(&p);  // è½¬ä¸ºå­—èŠ‚æµ
```

#### 2ï¸âƒ£ dynamic_castå¤±è´¥ä¸ºä»€ä¹ˆæŒ‡é’ˆè¿”å›nullptrï¼Œå¼•ç”¨æŠ›å¼‚å¸¸ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// åŸå› ï¼šå¼•ç”¨ä¸èƒ½ä¸º"ç©º"

// æŒ‡é’ˆç‰ˆæœ¬
Base* b = new Base();
Derived* d = dynamic_cast<Derived*>(b);
if (d == nullptr) {  // âœ… å¯ä»¥æ£€æŸ¥nullptr
    // å¤„ç†å¤±è´¥
}

// å¼•ç”¨ç‰ˆæœ¬
Base b;
try {
    Derived& dr = dynamic_cast<Derived&>(b);
    // å¼•ç”¨æ²¡æœ‰"ç©ºå¼•ç”¨"çš„æ¦‚å¿µ
    // å¤±è´¥åªèƒ½æŠ›å¼‚å¸¸
} catch (std::bad_cast&) {
    // å¤„ç†å¤±è´¥
}
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
C++æœ‰å››ç§ç±»å‹è½¬æ¢ï¼š

1. static_cast - ç¼–è¯‘æ—¶è½¬æ¢
   - åŸºæœ¬ç±»å‹è½¬æ¢
   - å‘ä¸Šè½¬å‹ï¼ˆå®‰å…¨ï¼‰
   - å‘ä¸‹è½¬å‹ï¼ˆä¸å®‰å…¨ï¼Œæ— è¿è¡Œæ—¶æ£€æŸ¥ï¼‰

2. dynamic_cast - è¿è¡Œæ—¶è½¬æ¢
   - éœ€è¦RTTIï¼ˆç±»æœ‰è™šå‡½æ•°ï¼‰
   - å®‰å…¨çš„å‘ä¸‹è½¬å‹ï¼ˆå¤±è´¥è¿”å›nullptr/æŠ›å¼‚å¸¸ï¼‰
   - æœ‰æ€§èƒ½å¼€é”€ï¼ˆæŸ¥è¯¢è™šè¡¨ï¼‰

3. const_cast - å»é™¤const/volatile
   - å”¯ä¸€èƒ½å»é™¤constçš„è½¬æ¢
   - è°¨æ…ä½¿ç”¨ï¼ˆä¿®æ”¹constå¯¹è±¡æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼‰

4. reinterpret_cast - é‡æ–°è§£é‡Š
   - æŒ‡é’ˆç±»å‹å¼ºåˆ¶è½¬æ¢
   - æŒ‡é’ˆä¸æ•´æ•°äº’è½¬
   - éå¸¸å±é™©ï¼Œåº•å±‚æ“ä½œæ‰ç”¨

ã€è¿½é—®-dynamic_caståŸç†ã€‘
é€šè¿‡è™šè¡¨ä¸­çš„type_infoä¿¡æ¯ï¼Œè¿è¡Œæ—¶æ£€æŸ¥å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œ
åˆ¤æ–­æ˜¯å¦å¯ä»¥å®‰å…¨è½¬æ¢ã€‚å¤±è´¥æ—¶æŒ‡é’ˆè¿”å›nullptrï¼Œå¼•ç”¨æŠ›bad_castã€‚

ã€è¿½é—®-ä¸ºä»€ä¹ˆä¸ç”¨Cé£æ ¼è½¬æ¢ã€‘
Cé£æ ¼è½¬æ¢(Type)valueä¼šå°è¯•å¤šç§è½¬æ¢æ–¹å¼ï¼Œä¸æ˜ç¡®ï¼Œéš¾ä»¥æœç´¢å’Œå®¡æŸ¥ã€‚
C++çš„å‘½åè½¬æ¢æ˜ç¡®æ„å›¾ï¼Œç¼–è¯‘å™¨æ£€æŸ¥æ›´ä¸¥æ ¼ã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸ºstatic_castå¯ä»¥å®‰å…¨å‘ä¸‹è½¬å‹
âœ… **æ­£ç¡®**ï¼šstatic_castä¸æ£€æŸ¥ï¼Œéœ€è¦ç”¨dynamic_cast

âŒ **é”™è¯¯2**ï¼šæ‰€æœ‰ç±»éƒ½èƒ½ç”¨dynamic_cast
âœ… **æ­£ç¡®**ï¼šç±»å¿…é¡»æœ‰è™šå‡½æ•°ï¼ˆéœ€è¦RTTIä¿¡æ¯ï¼‰

âŒ **é”™è¯¯3**ï¼šconst_castå¯ä»¥ä¿®æ”¹constå¯¹è±¡
âœ… **æ­£ç¡®**ï¼šåªèƒ½ä¿®æ”¹æœ¬èº«éconstä½†è¢«constå¼•ç”¨/æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°C++17çš„std::anyå’Œstd::variantï¼ˆç±»å‹å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆï¼‰
- çŸ¥é“dynamic_castçš„æ€§èƒ½å¼€é”€æ¥æºï¼ˆè™šè¡¨æŸ¥è¯¢ï¼‰
- äº†è§£RTTIå¯ä»¥é€šè¿‡ç¼–è¯‘é€‰é¡¹å…³é—­ï¼ˆ-fno-rttiï¼‰
- æåˆ°ä¾§å‘è½¬æ¢ï¼ˆcross-castï¼Œå¤šç»§æ‰¿ä¸­çš„ç±»å‹è½¬æ¢ï¼‰

---

## ğŸ“Œ å†…å­˜å¯¹é½ä¸å¯¹è±¡æ¨¡å‹ï¼ˆâ­â­â­â­ é«˜é¢‘ï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **å†…å­˜å¯¹é½** | **padding** | **sizeof** | **ç©ºç±»å¤§å°** | **è™šå‡½æ•°å¼€é”€** | **å¯¹è±¡æ¨¡å‹** | **#pragma pack**

### âœ… å†…å­˜å¯¹é½è§„åˆ™

```cpp
// å¯¹é½è§„åˆ™ï¼š
// 1. åŸºæœ¬ç±»å‹å¯¹é½å€¼ = sizeof(type)
// 2. ç»“æ„ä½“å¯¹é½å€¼ = max(æ‰€æœ‰æˆå‘˜çš„å¯¹é½å€¼)
// 3. æˆå‘˜åç§»å¿…é¡»æ˜¯å…¶å¯¹é½å€¼çš„å€æ•°

struct A {
    char c;   // 1å­—èŠ‚ï¼Œåç§»0
    int i;    // 4å­—èŠ‚ï¼Œåç§»4ï¼ˆå¯¹é½åˆ°4çš„å€æ•°ï¼‰
    char c2;  // 1å­—èŠ‚ï¼Œåç§»8
};
// æ€»å¤§å°ï¼š12å­—èŠ‚ï¼ˆå¯¹é½åˆ°4çš„å€æ•°ï¼‰

/*
å†…å­˜å¸ƒå±€ï¼š
[c][pad][pad][pad][i][i][i][i][c2][pad][pad][pad]
0  1    2    3    4  5  6  7  8   9    10   11
*/
```

**ä¼˜åŒ–æŠ€å·§ï¼š**
```cpp
// âŒ æµªè´¹å†…å­˜
struct Bad {
    char c1;   // åç§»0
    int i;     // åç§»4
    char c2;   // åç§»8
    int i2;    // åç§»12
};
// å¤§å°ï¼š16å­—èŠ‚

// âœ… ä¼˜åŒ–æ’åˆ—
struct Good {
    int i;     // åç§»0
    int i2;    // åç§»4
    char c1;   // åç§»8
    char c2;   // åç§»9
};
// å¤§å°ï¼š12å­—èŠ‚

// ğŸ”‘ åŸåˆ™ï¼šå¤§å­—æ®µæ”¾å‰é¢ï¼Œå°å­—æ®µæ”¾åé¢
```

### ğŸ’¡ ç©ºç±»ä¸è™šå‡½æ•°çš„å¤§å°ï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

```cpp
// ç©ºç±»
class Empty {};
cout << sizeof(Empty);  // 1å­—èŠ‚ï¼ˆä¿è¯æ¯ä¸ªå¯¹è±¡æœ‰å”¯ä¸€åœ°å€ï¼‰

// ç©ºç±»ç»§æ‰¿
class Derived : public Empty {
    int x;
};
cout << sizeof(Derived);  // 4å­—èŠ‚ï¼ˆç©ºåŸºç±»ä¼˜åŒ–EBOï¼‰

// æœ‰è™šå‡½æ•°çš„ç±»
class Base {
public:
    virtual void func() {}
};
cout << sizeof(Base);  // 8å­—èŠ‚ï¼ˆ64ä½ï¼švptrï¼‰

class Derived : public Base {
    int x;
};
cout << sizeof(Derived);  // 16å­—èŠ‚ï¼ˆvptr + int + paddingï¼‰
/*
[vptr:8å­—èŠ‚][x:4å­—èŠ‚][padding:4å­—èŠ‚]
*/

// å¤šä¸ªè™šå‡½æ•°
class Multi {
    virtual void func1() {}
    virtual void func2() {}
    virtual void func3() {}
};
cout << sizeof(Multi);  // 8å­—èŠ‚ï¼ˆåªæœ‰ä¸€ä¸ªvptrï¼‰

// å¤šç»§æ‰¿
class Base1 {
    virtual void f1() {}
};
class Base2 {
    virtual void f2() {}
};
class Derived : public Base1, public Base2 {};
cout << sizeof(Derived);  // 16å­—èŠ‚ï¼ˆä¸¤ä¸ªvptrï¼‰
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜å¯¹é½ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```
1. ç¡¬ä»¶é™åˆ¶
   æŸäº›CPUè¦æ±‚è®¿é—®åœ°å€å¿…é¡»å¯¹é½
   æœªå¯¹é½è®¿é—®å¯èƒ½å¯¼è‡´ï¼š
   - æ€§èƒ½ä¸‹é™ï¼ˆéœ€è¦å¤šæ¬¡å†…å­˜è®¿é—®ï¼‰
   - è§¦å‘ç¡¬ä»¶å¼‚å¸¸ï¼ˆæŸäº›æ¶æ„ï¼‰

2. æ€§èƒ½ä¼˜åŒ–
   CPUä»å†…å­˜è¯»å–æ•°æ®æ˜¯æŒ‰"å—"è¯»å–çš„ï¼ˆcache lineé€šå¸¸64å­—èŠ‚ï¼‰
   å¯¹é½çš„æ•°æ®å¯ä»¥ä¸€æ¬¡è¯»å–ï¼Œæœªå¯¹é½éœ€è¦å¤šæ¬¡

ç¤ºä¾‹ï¼š
// æœªå¯¹é½è®¿é—®intï¼ˆåœ°å€0x1001ï¼‰
[----cache line 1----][----cache line 2----]
...01][int:4å­—èŠ‚][...
éœ€è¦è¯»å–ä¸¤ä¸ªcache lineï¼Œæ‹¼æ¥æ•°æ®

// å¯¹é½è®¿é—®intï¼ˆåœ°å€0x1000ï¼‰
[----cache line 1----]
[int:4å­—èŠ‚][...
ä¸€æ¬¡cache lineè¯»å–å³å¯
```

#### 2ï¸âƒ£ å¦‚ä½•æ‰‹åŠ¨æ§åˆ¶å¯¹é½ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// #pragma pack: æ”¹å˜é»˜è®¤å¯¹é½
#pragma pack(1)  // 1å­—èŠ‚å¯¹é½ï¼ˆç´§å‡‘ï¼‰
struct Packed {
    char c;
    int i;
    char c2;
};
#pragma pack()  // æ¢å¤é»˜è®¤
cout << sizeof(Packed);  // 6å­—èŠ‚

// alignas (C++11): æŒ‡å®šå¯¹é½
struct alignas(16) Aligned {
    int x;
};
cout << sizeof(Aligned);  // 16å­—èŠ‚ï¼ˆå¯¹é½åˆ°16ï¼‰

// alignof: æŸ¥è¯¢å¯¹é½å€¼
cout << alignof(int);     // 4
cout << alignof(double);  // 8
cout << alignof(Aligned); // 16
```

#### 3ï¸âƒ£ è™šå‡½æ•°å¯¹å¯¹è±¡å¤§å°çš„å½±å“ï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

```cpp
class NoVirtual {
    int x;
};
// sizeof: 4å­—èŠ‚

class OneVirtual {
    int x;
    virtual void func() {}
};
// sizeof: 16å­—èŠ‚ï¼ˆ64ä½ï¼‰
// [vptr:8][x:4][padding:4]

class TenVirtual {
    int x;
    virtual void f1() {}
    virtual void f2() {}
    // ... 10ä¸ªè™šå‡½æ•°
};
// sizeof: 16å­—èŠ‚ï¼ˆä»ç„¶åªæœ‰ä¸€ä¸ªvptrï¼‰

// ğŸ”‘ ç»“è®ºï¼šè™šå‡½æ•°æ•°é‡ä¸å½±å“å¯¹è±¡å¤§å°ï¼Œåªè¦æœ‰è™šå‡½æ•°å°±æœ‰vptr
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
å†…å­˜å¯¹é½æ˜¯ä¸ºäº†ï¼š

1. ç¡¬ä»¶è¦æ±‚
   æŸäº›CPUè¦æ±‚æ•°æ®åœ°å€å¿…é¡»æ˜¯æ•°æ®å¤§å°çš„å€æ•°

2. æ€§èƒ½ä¼˜åŒ–
   å¯¹é½çš„æ•°æ®è®¿é—®æ›´å¿«ï¼ˆcache lineåˆ©ç”¨ç‡é«˜ï¼‰

å¯¹é½è§„åˆ™ï¼š
- åŸºæœ¬ç±»å‹å¯¹é½å€¼ = sizeof(type)
- ç»“æ„ä½“æˆå‘˜åç§» = å¯¹é½å€¼çš„å€æ•°
- ç»“æ„ä½“å¤§å° = æœ€å¤§å¯¹é½å€¼çš„å€æ•°

ç©ºç±»å¤§å°ï¼š1å­—èŠ‚ï¼ˆä¿è¯å”¯ä¸€åœ°å€ï¼‰
è™šå‡½æ•°å¼€é”€ï¼š8å­—èŠ‚vptrï¼ˆ64ä½ç³»ç»Ÿï¼‰

ã€è¿½é—®-å¦‚ä½•ä¼˜åŒ–ã€‘
1. å¤§å­—æ®µæ”¾å‰é¢ï¼Œå‡å°‘padding
2. ä½¿ç”¨#pragma packç´§å‡‘å¸ƒå±€ï¼ˆç‰ºç‰²æ€§èƒ½ï¼‰
3. ç©ºåŸºç±»ä¼˜åŒ–ï¼ˆEBOï¼‰

ã€è¿½é—®-è™šå‡½æ•°å¼€é”€ã€‘
åªè¦æœ‰è™šå‡½æ•°ï¼Œå¯¹è±¡å°±å¤šä¸€ä¸ªvptrï¼ˆ8å­—èŠ‚ï¼‰
è™šå‡½æ•°æ•°é‡ä¸å½±å“å¯¹è±¡å¤§å°ï¼Œåªå½±å“è™šè¡¨å¤§å°
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šç©ºç±»å¤§å°ä¸º0
âœ… **æ­£ç¡®**ï¼š1å­—èŠ‚ï¼ˆä¿è¯æ¯ä¸ªå¯¹è±¡æœ‰å”¯ä¸€åœ°å€ï¼‰

âŒ **é”™è¯¯2**ï¼šè™šå‡½æ•°è¶Šå¤šï¼Œå¯¹è±¡è¶Šå¤§
âœ… **æ­£ç¡®**ï¼šå¯¹è±¡å¤§å°ä¸å˜ï¼Œè™šè¡¨å˜å¤§ï¼ˆåœ¨ä»£ç æ®µï¼‰

âŒ **é”™è¯¯3**ï¼š#pragma pack(1)æ€»æ˜¯å¥½çš„
âœ… **æ­£ç¡®**ï¼šçœå†…å­˜ä½†ç‰ºç‰²æ€§èƒ½ï¼Œè°¨æ…ä½¿ç”¨

---

## ğŸ“Œ å¤šç»§æ‰¿ä¸è±å½¢ç»§æ‰¿ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **å¤šç»§æ‰¿** | **è±å½¢ç»§æ‰¿** | **è™šç»§æ‰¿** | **virtual** | **äºŒä¹‰æ€§** | **è™šåŸºç±»** | **æ„é€ é¡ºåº** | **å†…å­˜å¸ƒå±€**

### âœ… å¤šç»§æ‰¿åŸºç¡€

**ä»€ä¹ˆæ˜¯å¤šç»§æ‰¿ï¼š**
```cpp
class A {
public:
    void funcA() { cout << "A"; }
};

class B {
public:
    void funcB() { cout << "B"; }
};

// Cå¤šç»§æ‰¿è‡ªAå’ŒB
class C : public A, public B {
public:
    void funcC() {
        funcA();  // âœ… ç»§æ‰¿Açš„æ–¹æ³•
        funcB();  // âœ… ç»§æ‰¿Bçš„æ–¹æ³•
    }
};

C c;
c.funcA();  // âœ… æ­£ç¡®
c.funcB();  // âœ… æ­£ç¡®
```

### ğŸ’¡ è±å½¢ç»§æ‰¿é—®é¢˜ï¼ˆâ­â­â­â­â­ é«˜é¢‘è¿½é—®ï¼‰

**ä»€ä¹ˆæ˜¯è±å½¢ç»§æ‰¿ï¼š**
```
       Animal
       /    \
      /      \
   Tiger    Lion
      \      /
       \    /
       Liger
```

**ä»£ç ç¤ºä¾‹ï¼š**
```cpp
class Animal {
public:
    int age;
    void eat() { cout << "Animal eat"; }
};

class Tiger : public Animal {
public:
    void roar() { cout << "Tiger roar"; }
};

class Lion : public Animal {
public:
    void hunt() { cout << "Lion hunt"; }
};

// âŒ è±å½¢ç»§æ‰¿é—®é¢˜
class Liger : public Tiger, public Lion {
public:
    void show() {
        // âŒ äºŒä¹‰æ€§ï¼æœ‰ä¸¤ä¸ªageï¼šTiger::age å’Œ Lion::age
        // age = 10;  // ç¼–è¯‘é”™è¯¯ï¼šambiguous

        // å¿…é¡»æ˜ç¡®æŒ‡å®š
        Tiger::age = 10;
        Lion::age = 5;

        // âŒ æµªè´¹å†…å­˜ï¼šAnimalçš„æˆå‘˜è¢«å¤åˆ¶äº†ä¸¤ä»½
    }
};
```

**å†…å­˜å¸ƒå±€ï¼š**
```
Ligerå¯¹è±¡å†…å­˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tigeréƒ¨åˆ†          â”‚
â”‚  â”œâ”€ Animal::age     â”‚  â† ç¬¬ä¸€ä»½Animalæ•°æ®
â”‚  â””â”€ Tigeræ•°æ®       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Lionéƒ¨åˆ†           â”‚
â”‚  â”œâ”€ Animal::age     â”‚  â† ç¬¬äºŒä»½Animalæ•°æ®ï¼ˆå†—ä½™ï¼ï¼‰
â”‚  â””â”€ Lionæ•°æ®        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ligeræ•°æ®          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ’» è™šç»§æ‰¿è§£å†³æ–¹æ¡ˆï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

**ä½¿ç”¨è™šç»§æ‰¿ï¼š**
```cpp
class Animal {
public:
    int age;
    Animal() { cout << "Animalæ„é€ \n"; }
};

// ğŸ”‘ å…³é”®ï¼šä½¿ç”¨virtualç»§æ‰¿
class Tiger : virtual public Animal {
public:
    Tiger() { cout << "Tigeræ„é€ \n"; }
};

class Lion : virtual public Animal {
public:
    Lion() { cout << "Lionæ„é€ \n"; }
};

class Liger : public Tiger, public Lion {
public:
    Liger() { cout << "Ligeræ„é€ \n"; }

    void show() {
        age = 10;  // âœ… æ­£ç¡®ï¼åªæœ‰ä¸€ä¸ªage
        eat();     // âœ… æ­£ç¡®ï¼åªæœ‰ä¸€ä¸ªeat()
    }
};
```

**è™šç»§æ‰¿åçš„å†…å­˜å¸ƒå±€ï¼š**
```
Ligerå¯¹è±¡å†…å­˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tigeréƒ¨åˆ†          â”‚
â”‚  â””â”€ vbptr â”€â”€â”€â”€â”     â”‚  â† è™šåŸºç±»æŒ‡é’ˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
â”‚  Lionéƒ¨åˆ†     â”‚     â”‚
â”‚  â””â”€ vbptr â”€â”€â”€â”€â”¤     â”‚  â† è™šåŸºç±»æŒ‡é’ˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  Ligeræ•°æ®    â”‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  Animaléƒ¨åˆ†   â”‚â—„â”€â”€â”€â”€â”˜  â† åªæœ‰ä¸€ä»½Animalæ•°æ®
â”‚  â””â”€ age       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ è™šç»§æ‰¿çš„æ„é€ é¡ºåºï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
class Animal {
public:
    Animal() { cout << "1. Animal\n"; }
};

class Tiger : virtual public Animal {
public:
    Tiger() { cout << "2. Tiger\n"; }
};

class Lion : virtual public Animal {
public:
    Lion() { cout << "3. Lion\n"; }
};

class Liger : public Tiger, public Lion {
public:
    Liger() { cout << "4. Liger\n"; }
};

Liger l;
// è¾“å‡ºé¡ºåºï¼š
// 1. Animal    â† ğŸ”‘ è™šåŸºç±»æœ€å…ˆæ„é€ 
// 2. Tiger
// 3. Lion
// 4. Liger
```

ğŸ”‘ **å¾—åˆ†ç‚¹ï¼šè™šåŸºç±»ç”±æœ€ç»ˆæ´¾ç”Ÿç±»æ„é€ ï¼Œä¸”æœ€å…ˆæ„é€ **

#### 2ï¸âƒ£ è™šç»§æ‰¿çš„æ€§èƒ½å¼€é”€ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// è™šç»§æ‰¿çš„ä»£ä»·ï¼š
1. é¢å¤–çš„è™šåŸºç±»æŒ‡é’ˆï¼ˆvbptrï¼‰
2. é—´æ¥è®¿é—®æˆå‘˜ï¼ˆé€šè¿‡vbptræŸ¥è¡¨ï¼‰
3. æ„é€ å‡½æ•°å¤æ‚åº¦å¢åŠ 

// ç©ºé—´å¼€é”€ï¼š
sizeof(Tiger)  // æ™®é€šç»§æ‰¿ï¼šAnimalå¤§å° + Tigerå¤§å°
sizeof(Tiger)  // è™šç»§æ‰¿ï¼šAnimalå¤§å° + Tigerå¤§å° + vbptr(8å­—èŠ‚)
```

#### 3ï¸âƒ£ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨å¤šç»§æ‰¿ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// âœ… åˆç†ä½¿ç”¨åœºæ™¯ï¼šæ¥å£ç»§æ‰¿
class Serializable {
public:
    virtual void serialize() = 0;
};

class Comparable {
public:
    virtual int compare(const Comparable&) = 0;
};

class Student : public Serializable, public Comparable {
    // âœ… ç»§æ‰¿å¤šä¸ªæ¥å£ï¼ˆçº¯è™šç±»ï¼‰ï¼Œæ²¡æœ‰è±å½¢ç»§æ‰¿é—®é¢˜
};

// âŒ ä¸æ¨èï¼šç»§æ‰¿å¤šä¸ªæœ‰çŠ¶æ€çš„ç±»
class Car : public Engine, public Wheel {
    // âŒ å®¹æ˜“å‡ºç°è±å½¢ç»§æ‰¿å’ŒäºŒä¹‰æ€§é—®é¢˜
};
```

ğŸ”‘ **å¾—åˆ†ç‚¹ï¼šå¤šç»§æ‰¿ä¸»è¦ç”¨äºæ¥å£ç»§æ‰¿ï¼Œé¿å…ç»§æ‰¿å¤šä¸ªæœ‰çŠ¶æ€çš„ç±»**

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
å¤šç»§æ‰¿å…è®¸ä¸€ä¸ªç±»ç»§æ‰¿å¤šä¸ªåŸºç±»ï¼Œä½†ä¼šå¼•å‘è±å½¢ç»§æ‰¿é—®é¢˜ï¼š

è±å½¢ç»§æ‰¿ï¼š
      A
     / \
    B   C
     \ /
      D

é—®é¢˜ï¼š
1. äºŒä¹‰æ€§ï¼šDä¸­æœ‰ä¸¤ä»½Açš„æˆå‘˜ï¼Œè®¿é—®æ—¶ç¼–è¯‘å™¨ä¸çŸ¥é“ç”¨å“ªä¸ª
2. å†…å­˜æµªè´¹ï¼šAçš„æ•°æ®è¢«å­˜å‚¨ä¸¤ä»½

è§£å†³æ–¹æ¡ˆï¼šè™šç»§æ‰¿ï¼ˆvirtualï¼‰
- Bå’ŒCè™šç»§æ‰¿Aï¼ŒDä¸­åªä¿ç•™ä¸€ä»½Açš„æ•°æ®
- é€šè¿‡è™šåŸºç±»æŒ‡é’ˆï¼ˆvbptrï¼‰è®¿é—®è™šåŸºç±»æˆå‘˜
- è™šåŸºç±»ç”±æœ€ç»ˆæ´¾ç”Ÿç±»æ„é€ ï¼Œä¸”æœ€å…ˆæ„é€ 

ã€è¿½é—®-è™šç»§æ‰¿æ„é€ é¡ºåºã€‘
è™šåŸºç±»æœ€å…ˆæ„é€ ï¼Œç”±æœ€ç»ˆæ´¾ç”Ÿç±»çš„æ„é€ å‡½æ•°è´Ÿè´£è°ƒç”¨ã€‚
å³ä½¿ä¸­é—´ç±»ï¼ˆBã€Cï¼‰çš„åˆå§‹åŒ–åˆ—è¡¨ä¸­è°ƒç”¨äº†Açš„æ„é€ ï¼Œ
ä¹Ÿä¼šè¢«å¿½ç•¥ï¼Œç”±Dçš„æ„é€ å‡½æ•°ç»Ÿä¸€è°ƒç”¨Açš„æ„é€ ã€‚

ã€è¿½é—®-æ€§èƒ½å¼€é”€ã€‘
è™šç»§æ‰¿æœ‰é¢å¤–å¼€é”€ï¼š
1. æ¯ä¸ªè™šç»§æ‰¿ç±»å¢åŠ ä¸€ä¸ªvbptrï¼ˆ8å­—èŠ‚ï¼‰
2. è®¿é—®è™šåŸºç±»æˆå‘˜éœ€è¦é—´æ¥å¯»å€
3. æ„é€ å’Œææ„é€»è¾‘æ›´å¤æ‚

ã€è¿½é—®-ä½¿ç”¨å»ºè®®ã€‘
å¤šç»§æ‰¿ä¸»è¦ç”¨äºæ¥å£ç»§æ‰¿ï¼ˆçº¯è™šç±»ï¼‰ï¼Œ
é¿å…ç»§æ‰¿å¤šä¸ªæœ‰çŠ¶æ€çš„ç±»ï¼Œä¼˜å…ˆè€ƒè™‘ç»„åˆè€Œéç»§æ‰¿ã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸ºè™šç»§æ‰¿æ²¡æœ‰æ€§èƒ½å¼€é”€
âœ… **æ­£ç¡®**ï¼šæœ‰vbptrå’Œé—´æ¥è®¿é—®çš„å¼€é”€

âŒ **é”™è¯¯2**ï¼šè™šç»§æ‰¿æ—¶åŸºç±»æ„é€ é¡ºåºä¸æ™®é€šç»§æ‰¿ç›¸åŒ
âœ… **æ­£ç¡®**ï¼šè™šåŸºç±»æœ€å…ˆæ„é€ ï¼Œç”±æœ€ç»ˆæ´¾ç”Ÿç±»è´Ÿè´£

âŒ **é”™è¯¯3**ï¼šå¤šç»§æ‰¿æ€»æ˜¯ä¸å¥½çš„
âœ… **æ­£ç¡®**ï¼šæ¥å£ç»§æ‰¿ï¼ˆå¤šä¸ªçº¯è™šç±»ï¼‰æ˜¯åˆç†çš„

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°vbptrï¼ˆè™šåŸºç±»æŒ‡é’ˆï¼‰å’Œvtableçš„åŒºåˆ«
- çŸ¥é“C++æ ‡å‡†åº“é¿å…å¤šç»§æ‰¿ï¼ˆé™¤äº†iostreamä½“ç³»ï¼‰
- äº†è§£å…¶ä»–è¯­è¨€å¯¹å¤šç»§æ‰¿çš„å¤„ç†ï¼ˆJavaç¦æ­¢ï¼ŒPythonå…è®¸ï¼‰
- æåˆ°ç»„åˆä¼˜äºç»§æ‰¿åŸåˆ™

---

## ğŸ“Œ staticå…³é”®å­—ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **é™æ€æˆå‘˜å˜é‡** | **é™æ€æˆå‘˜å‡½æ•°** | **é™æ€å±€éƒ¨å˜é‡** | **ç±»å¤–åˆå§‹åŒ–** | **ç”Ÿå‘½å‘¨æœŸ** | **å†…éƒ¨é“¾æ¥** | **å•ä¾‹æ¨¡å¼**

### âœ… staticçš„äº”ç§ç”¨æ³•

#### 1ï¸âƒ£ ä¿®é¥°å±€éƒ¨å˜é‡ï¼ˆâ­â­â­â­â­ï¼‰

```cpp
void func() {
    static int count = 0;  // ğŸ”‘ åªåˆå§‹åŒ–ä¸€æ¬¡
    count++;
    cout << count << endl;
}

func();  // è¾“å‡ºï¼š1
func();  // è¾“å‡ºï¼š2
func();  // è¾“å‡ºï¼š3

// ğŸ”‘ ç‰¹ç‚¹ï¼š
// 1. ç”Ÿå‘½å‘¨æœŸï¼šç¨‹åºå¼€å§‹åˆ°ç»“æŸï¼ˆä¸æ˜¯å‡½æ•°è°ƒç”¨æœŸé—´ï¼‰
// 2. ä½œç”¨åŸŸï¼šä»…åœ¨å‡½æ•°å†…å¯è§
// 3. åˆå§‹åŒ–ï¼šç¬¬ä¸€æ¬¡æ‰§è¡Œåˆ°è¯¥è¯­å¥æ—¶åˆå§‹åŒ–
// 4. å­˜å‚¨ä½ç½®ï¼šé™æ€å­˜å‚¨åŒºï¼ˆä¸æ˜¯æ ˆï¼‰
```

#### 2ï¸âƒ£ ä¿®é¥°å…¨å±€å˜é‡/å‡½æ•°ï¼ˆâ­â­â­â­ï¼‰

```cpp
// file1.cpp
static int g_value = 10;  // ğŸ”‘ ä»…åœ¨file1.cppå¯è§
static void helper() {    // ğŸ”‘ ä»…åœ¨file1.cppå¯è§
    cout << g_value;
}

// file2.cpp
extern int g_value;  // âŒ é“¾æ¥é”™è¯¯ï¼šæ‰¾ä¸åˆ°g_value
// å› ä¸ºg_valueæ˜¯é™æ€çš„ï¼Œåªåœ¨file1.cppå¯è§

// ğŸ”‘ ä½œç”¨ï¼šé™åˆ¶é“¾æ¥æ€§ï¼ˆinternal linkageï¼‰
// ç±»ä¼¼äºåŒ¿åå‘½åç©ºé—´
namespace {
    int g_value = 10;  // ç­‰ä»·äºstatic int g_value
}
```

#### 3ï¸âƒ£ ä¿®é¥°ç±»çš„æˆå‘˜å˜é‡ï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

```cpp
class Test {
public:
    static int count;  // ğŸ”‘ å£°æ˜ï¼ˆä¸æ˜¯å®šä¹‰ï¼‰
    int value;

    Test() {
        count++;  // æ‰€æœ‰å¯¹è±¡å…±äº«
        value = 0;
    }
};

// ğŸ”‘ å¿…é¡»åœ¨ç±»å¤–å®šä¹‰å’Œåˆå§‹åŒ–
int Test::count = 0;

Test t1;  // count = 1
Test t2;  // count = 2
cout << Test::count;  // è¾“å‡ºï¼š2

// ğŸ”‘ ç‰¹ç‚¹ï¼š
// 1. æ‰€æœ‰å¯¹è±¡å…±äº«ä¸€ä¸ªå‰¯æœ¬
// 2. ä¸å±äºä»»ä½•å¯¹è±¡ï¼Œå±äºç±»
// 3. å¯ä»¥é€šè¿‡ç±»åè®¿é—®ï¼šTest::count
// 4. å¿…é¡»åœ¨ç±»å¤–åˆå§‹åŒ–ï¼ˆé™¤äº†const staticæ•´å‹ï¼‰
```

**å†…å­˜å¸ƒå±€ï¼š**
```
é™æ€å­˜å‚¨åŒºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test::count  â”‚  â† æ‰€æœ‰Testå¯¹è±¡å…±äº«
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯¹è±¡t1ï¼š              å¯¹è±¡t2ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  value   â”‚         â”‚  value   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4ï¸âƒ£ ä¿®é¥°ç±»çš„æˆå‘˜å‡½æ•°ï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

```cpp
class Test {
    static int count;
    int value;
public:
    // é™æ€æˆå‘˜å‡½æ•°
    static void setCount(int c) {
        count = c;   // âœ… å¯ä»¥è®¿é—®é™æ€æˆå‘˜
        // value = 10;  // âŒ é”™è¯¯ï¼ä¸èƒ½è®¿é—®éé™æ€æˆå‘˜
        // this->value; // âŒ é”™è¯¯ï¼æ²¡æœ‰thisæŒ‡é’ˆ
    }

    static int getCount() {
        return count;
    }
};

// è°ƒç”¨æ–¹å¼1ï¼šé€šè¿‡ç±»å
Test::setCount(100);

// è°ƒç”¨æ–¹å¼2ï¼šé€šè¿‡å¯¹è±¡
Test t;
t.setCount(100);  // ä¸æ¨èï¼Œå®¹æ˜“è¯¯å¯¼

// ğŸ”‘ ç‰¹ç‚¹ï¼š
// 1. æ²¡æœ‰thisæŒ‡é’ˆ
// 2. åªèƒ½è®¿é—®é™æ€æˆå‘˜
// 3. ä¸èƒ½æ˜¯è™šå‡½æ•°
// 4. ä¸èƒ½æ˜¯constå‡½æ•°
```

#### 5ï¸âƒ£ const staticç‰¹æ®Šæƒ…å†µï¼ˆâ­â­â­â­ï¼‰

```cpp
class Test {
public:
    // âœ… const staticæ•´å‹å¯ä»¥ç±»å†…åˆå§‹åŒ–
    const static int MAX = 100;

    // âŒ éæ•´å‹å¿…é¡»ç±»å¤–åˆå§‹åŒ–
    const static double PI;  // å£°æ˜
};

const double Test::PI = 3.14;  // ç±»å¤–å®šä¹‰

// C++17: inline static
class Modern {
public:
    inline static int count = 0;  // âœ… C++17å¯ä»¥ç±»å†…åˆå§‹åŒ–
    inline static string name = "test";  // âœ…
};
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ ä¸ºä»€ä¹ˆé™æ€æˆå‘˜å˜é‡è¦ç±»å¤–åˆå§‹åŒ–ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
class Test {
    static int count = 0;  // âŒ é”™è¯¯ï¼ˆé™¤äº†const staticæ•´å‹ï¼‰
};

// åŸå› ï¼š
1. ç±»çš„å£°æ˜å¯èƒ½å‡ºç°åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼ˆé€šè¿‡includeï¼‰
2. å¦‚æœå…è®¸ç±»å†…åˆå§‹åŒ–ï¼Œæ¯ä¸ªincludeçš„åœ°æ–¹éƒ½ä¼šåˆå§‹åŒ–ä¸€æ¬¡
3. è¿åäº†"åªå®šä¹‰ä¸€æ¬¡"çš„åŸåˆ™

// æ­£ç¡®åšæ³•ï¼š
// Test.h
class Test {
    static int count;  // å£°æ˜
};

// Test.cpp
int Test::count = 0;  // å®šä¹‰ï¼ˆåªåœ¨ä¸€ä¸ªcppæ–‡ä»¶ä¸­ï¼‰
```

#### 2ï¸âƒ£ é™æ€æˆå‘˜å‡½æ•°å¯ä»¥æ˜¯è™šå‡½æ•°å—ï¼Ÿï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

âŒ **ä¸å¯ä»¥**

```cpp
class Base {
public:
    static virtual void func();  // âŒ ç¼–è¯‘é”™è¯¯
};

// åŸå› ï¼š
1. è™šå‡½æ•°é€šè¿‡å¯¹è±¡çš„vptrè°ƒç”¨
2. é™æ€å‡½æ•°æ²¡æœ‰thisæŒ‡é’ˆï¼Œæ²¡æœ‰å¯¹è±¡
3. é™æ€å‡½æ•°å±äºç±»ï¼Œä¸å±äºå¯¹è±¡
4. é™æ€å‡½æ•°åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†åœ°å€ï¼Œä¸éœ€è¦åŠ¨æ€ç»‘å®š
```

#### 3ï¸âƒ£ é™æ€å±€éƒ¨å˜é‡çº¿ç¨‹å®‰å…¨å—ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
void func() {
    static int count = 0;  // âŒ å¤šçº¿ç¨‹ä¸å®‰å…¨
    count++;
}

// C++11ä¹‹å‰ï¼šä¸å®‰å…¨
thread t1(func);
thread t2(func);
// å¯èƒ½ä¸¢å¤±count++

// C++11ä¹‹åï¼šåˆå§‹åŒ–æ˜¯çº¿ç¨‹å®‰å…¨çš„
void func() {
    static Singleton s;  // âœ… C++11ä¿è¯åªåˆå§‹åŒ–ä¸€æ¬¡
}

// ä½†è¯»å†™ä»ä¸å®‰å…¨ï¼š
void func() {
    static int count = 0;  // åˆå§‹åŒ–å®‰å…¨
    count++;  // âŒ è¯»å†™ä¸å®‰å…¨ï¼Œéœ€è¦åŠ é”
}
```

#### 4ï¸âƒ£ å•ä¾‹æ¨¡å¼çš„å®ç°ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

**é¥¿æ±‰å¼ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ï¼š**
```cpp
class Singleton {
private:
    static Singleton instance;  // ç±»åŠ è½½æ—¶åˆå§‹åŒ–
    Singleton() {}
public:
    static Singleton& getInstance() {
        return instance;
    }
};

Singleton Singleton::instance;  // ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ–
```

**æ‡’æ±‰å¼ï¼ˆC++11ï¼Œçº¿ç¨‹å®‰å…¨ï¼‰ï¼š**
```cpp
class Singleton {
private:
    Singleton() {}
public:
    static Singleton& getInstance() {
        static Singleton instance;  // ğŸ”‘ ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶åˆå§‹åŒ–
        return instance;            // C++11ä¿è¯çº¿ç¨‹å®‰å…¨
    }

    // ç¦æ­¢æ‹·è´
    Singleton(const Singleton&) = delete;
    Singleton& operator=(const Singleton&) = delete;
};
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
staticå…³é”®å­—ä¸»è¦æœ‰äº”ç§ç”¨æ³•ï¼š

1. é™æ€å±€éƒ¨å˜é‡
   - ç”Ÿå‘½å‘¨æœŸï¼šç¨‹åºå¼€å§‹åˆ°ç»“æŸ
   - ä½œç”¨åŸŸï¼šå‡½æ•°å†…
   - åªåˆå§‹åŒ–ä¸€æ¬¡

2. é™æ€å…¨å±€å˜é‡/å‡½æ•°
   - é™åˆ¶é“¾æ¥æ€§ï¼Œåªåœ¨å½“å‰æ–‡ä»¶å¯è§
   - é˜²æ­¢å‘½åå†²çª

3. é™æ€æˆå‘˜å˜é‡
   - æ‰€æœ‰å¯¹è±¡å…±äº«
   - å±äºç±»ï¼Œä¸å±äºå¯¹è±¡
   - å¿…é¡»ç±»å¤–åˆå§‹åŒ–ï¼ˆC++17å‰ï¼‰

4. é™æ€æˆå‘˜å‡½æ•°
   - æ²¡æœ‰thisæŒ‡é’ˆ
   - åªèƒ½è®¿é—®é™æ€æˆå‘˜
   - ä¸èƒ½æ˜¯è™šå‡½æ•°

ã€è¿½é—®-ä¸ºä»€ä¹ˆè¦ç±»å¤–åˆå§‹åŒ–ã€‘
å› ä¸ºç±»å£°æ˜å¯èƒ½å‡ºç°åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œ
å¦‚æœå…è®¸ç±»å†…åˆå§‹åŒ–ï¼Œä¼šå¯¼è‡´é‡å¤å®šä¹‰ã€‚
åªåœ¨ä¸€ä¸ªcppæ–‡ä»¶ä¸­å®šä¹‰ï¼Œä¿è¯å•ä¸€å®šä¹‰ã€‚

ã€è¿½é—®-é™æ€å‡½æ•°ä¸ºä»€ä¹ˆä¸èƒ½æ˜¯è™šå‡½æ•°ã€‘
è™šå‡½æ•°éœ€è¦é€šè¿‡å¯¹è±¡çš„vptråŠ¨æ€ç»‘å®šï¼Œ
è€Œé™æ€å‡½æ•°æ²¡æœ‰thisæŒ‡é’ˆï¼Œæ²¡æœ‰å¯¹è±¡ï¼Œ
åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†åœ°å€ï¼Œä¸éœ€è¦åŠ¨æ€ç»‘å®šã€‚

ã€è¿½é—®-å•ä¾‹æ¨¡å¼ã€‘
C++11åæ¨èä½¿ç”¨æ‡’æ±‰å¼+é™æ€å±€éƒ¨å˜é‡ï¼Œ
å› ä¸ºC++11ä¿è¯é™æ€å±€éƒ¨å˜é‡åˆå§‹åŒ–æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šé™æ€æˆå‘˜å˜é‡å¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–
âœ… **æ­£ç¡®**ï¼šå¿…é¡»åœ¨ç±»å¤–åˆå§‹åŒ–ï¼ˆé™¤äº†const staticæ•´å‹ï¼‰

âŒ **é”™è¯¯2**ï¼šé™æ€æˆå‘˜å‡½æ•°å¯ä»¥è®¿é—®éé™æ€æˆå‘˜
âœ… **æ­£ç¡®**ï¼šåªèƒ½è®¿é—®é™æ€æˆå‘˜ï¼Œå› ä¸ºæ²¡æœ‰thisæŒ‡é’ˆ

âŒ **é”™è¯¯3**ï¼šé™æ€å±€éƒ¨å˜é‡åœ¨æ ˆä¸Š
âœ… **æ­£ç¡®**ï¼šåœ¨é™æ€å­˜å‚¨åŒºï¼Œç”Ÿå‘½å‘¨æœŸæ˜¯æ•´ä¸ªç¨‹åº

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°C++17çš„inline static
- çŸ¥é“é™æ€å±€éƒ¨å˜é‡åˆå§‹åŒ–çš„çº¿ç¨‹å®‰å…¨æ€§ï¼ˆC++11ï¼‰
- äº†è§£Meyer's Singletonï¼ˆé™æ€å±€éƒ¨å˜é‡å®ç°å•ä¾‹ï¼‰
- æåˆ°staticä¸åŒ¿åå‘½åç©ºé—´çš„ç­‰ä»·æ€§

---

## ğŸ“Œ å³å€¼å¼•ç”¨ä¸ç§»åŠ¨è¯­ä¹‰ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **å·¦å€¼** | **å³å€¼** | **å³å€¼å¼•ç”¨** | **std::move** | **ç§»åŠ¨æ„é€ ** | **ç§»åŠ¨èµ‹å€¼** | **å®Œç¾è½¬å‘** | **std::forward**

### âœ… å·¦å€¼å’Œå³å€¼çš„åŒºåˆ«

```cpp
// å·¦å€¼ï¼ˆlvalueï¼‰ï¼šæœ‰åå­—ï¼Œå¯ä»¥å–åœ°å€
int a = 10;      // aæ˜¯å·¦å€¼
int* p = &a;     // âœ… å¯ä»¥å–åœ°å€

// å³å€¼ï¼ˆrvalueï¼‰ï¼šä¸´æ—¶å¯¹è±¡ï¼Œä¸èƒ½å–åœ°å€
int b = 20;
int c = a + b;   // a+bæ˜¯å³å€¼ï¼ˆä¸´æ—¶ç»“æœï¼‰
// int* p = &(a+b);  // âŒ é”™è¯¯ï¼šä¸èƒ½å–å³å€¼çš„åœ°å€

// å­—ç¬¦ä¸²å­—é¢é‡
string s = "hello";  // "hello"æ˜¯å³å€¼

// å‡½æ•°è¿”å›å€¼
int func() { return 42; }
int x = func();  // func()è¿”å›å€¼æ˜¯å³å€¼
```

**åˆ¤æ–­æŠ€å·§ï¼š**
```cpp
èƒ½æ”¾åœ¨ = å·¦è¾¹çš„æ˜¯å·¦å€¼
åªèƒ½æ”¾åœ¨ = å³è¾¹çš„æ˜¯å³å€¼

int a = 10;  // aæ˜¯å·¦å€¼
10 = a;      // âŒ é”™è¯¯ï¼š10æ˜¯å³å€¼ï¼Œä¸èƒ½è¢«èµ‹å€¼
```

### ğŸ’¡ å³å€¼å¼•ç”¨ï¼ˆâ­â­â­â­â­ æ ¸å¿ƒï¼‰

**è¯­æ³•ï¼š**
```cpp
// å·¦å€¼å¼•ç”¨ï¼ˆ&ï¼‰
int a = 10;
int& ref1 = a;        // âœ… å·¦å€¼å¼•ç”¨ç»‘å®šå·¦å€¼
// int& ref2 = 10;    // âŒ é”™è¯¯ï¼šä¸èƒ½ç»‘å®šå³å€¼

const int& ref3 = 10; // âœ… constå·¦å€¼å¼•ç”¨å¯ä»¥ç»‘å®šå³å€¼

// å³å€¼å¼•ç”¨ï¼ˆ&&ï¼‰
int&& ref4 = 10;      // âœ… å³å€¼å¼•ç”¨ç»‘å®šå³å€¼
int&& ref5 = a + 10;  // âœ… ç»‘å®šä¸´æ—¶å¯¹è±¡

// int&& ref6 = a;    // âŒ é”™è¯¯ï¼šä¸èƒ½ç»‘å®šå·¦å€¼
int&& ref7 = std::move(a);  // âœ… moveå°†å·¦å€¼è½¬ä¸ºå³å€¼
```

### ğŸ’» ç§»åŠ¨è¯­ä¹‰ï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦ç§»åŠ¨è¯­ä¹‰ï¼š**
```cpp
class BigData {
    int* data;
    size_t size;
public:
    // æ‹·è´æ„é€ ï¼šæ·±æ‹·è´ï¼Œæ…¢
    BigData(const BigData& other) {
        size = other.size;
        data = new int[size];
        memcpy(data, other.data, size * sizeof(int));  // ğŸŒ æ…¢
        cout << "æ‹·è´æ„é€ \n";
    }

    // ç§»åŠ¨æ„é€ ï¼šçªƒå–èµ„æºï¼Œå¿«
    BigData(BigData&& other) noexcept {
        data = other.data;      // ğŸ”‘ çªƒå–æŒ‡é’ˆ
        size = other.size;
        other.data = nullptr;   // ğŸ”‘ æ¸…ç©ºåŸå¯¹è±¡
        other.size = 0;
        cout << "ç§»åŠ¨æ„é€ \n";
    }
};

BigData func() {
    BigData temp(1000000);
    return temp;  // ğŸ”‘ è¿”å›æ—¶è§¦å‘ç§»åŠ¨æ„é€ 
}

BigData b = func();  // è¾“å‡ºï¼šç§»åŠ¨æ„é€ ï¼ˆä¸æ˜¯æ‹·è´æ„é€ ï¼‰
```

**ç§»åŠ¨è¯­ä¹‰çš„æ•ˆç‡å¯¹æ¯”ï¼š**
```
æ‹·è´æ„é€ ï¼š
  æºå¯¹è±¡   â†’  æ–°å¯¹è±¡
  [data] â”€å¤åˆ¶â†’ [data]
  ä¿ç•™åŸæ•°æ®    æ·±æ‹·è´

ç§»åŠ¨æ„é€ ï¼š
  æºå¯¹è±¡   â†’  æ–°å¯¹è±¡
  [data] â”€çªƒå–â†’ [data]
  [NULL]        ç›´æ¥è½¬ç§»æŒ‡é’ˆ
  æ¸…ç©ºèµ„æº      æ— æ‹·è´
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ std::moveåšäº†ä»€ä¹ˆï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
template<typename T>
typename remove_reference<T>::type&& move(T&& t) noexcept {
    return static_cast<typename remove_reference<T>::type&&>(t);
}

// ğŸ”‘ æ ¸å¿ƒï¼šmoveåªæ˜¯ç±»å‹è½¬æ¢ï¼Œä¸ç§»åŠ¨ä»»ä½•ä¸œè¥¿
// å®ƒå°†å·¦å€¼è½¬æ¢ä¸ºå³å€¼å¼•ç”¨

vector<int> v1 = {1, 2, 3};
vector<int> v2 = std::move(v1);  // moveåªæ˜¯è½¬æ¢ç±»å‹
                                  // çœŸæ­£çš„ç§»åŠ¨åœ¨vectorçš„ç§»åŠ¨æ„é€ ä¸­

cout << v1.size();  // 0ï¼ˆv1è¢«"æç©º"ï¼‰
cout << v2.size();  // 3
```

#### 2ï¸âƒ£ ç§»åŠ¨åçš„å¯¹è±¡èƒ½å†ç”¨å—ï¼Ÿï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

```cpp
vector<int> v1 = {1, 2, 3};
vector<int> v2 = std::move(v1);

// v1å¤„äº"æœ‰æ•ˆä½†æœªæŒ‡å®š"çŠ¶æ€
cout << v1.size();  // 0ï¼ˆé€šå¸¸ï¼‰
v1.push_back(4);    // âœ… å¯ä»¥ç»§ç»­ä½¿ç”¨
v1 = {5, 6, 7};     // âœ… å¯ä»¥é‡æ–°èµ‹å€¼

// âŒ é”™è¯¯ç¤ºèŒƒï¼š
string s1 = "hello";
string s2 = std::move(s1);
cout << s1[0];  // âŒ æœªå®šä¹‰è¡Œä¸ºï¼s1å¯èƒ½ä¸ºç©º
```

ğŸ”‘ **å¾—åˆ†ç‚¹ï¼šç§»åŠ¨åçš„å¯¹è±¡å¤„äºæœ‰æ•ˆä½†æœªæŒ‡å®šçŠ¶æ€ï¼Œå¯ä»¥èµ‹å€¼å’Œææ„ï¼Œä½†ä¸åº”è¯¥ä½¿ç”¨å…¶å€¼**

#### 3ï¸âƒ£ ä»€ä¹ˆæ—¶å€™ä¼šè‡ªåŠ¨ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰ï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

```cpp
// 1ï¸âƒ£ è¿”å›å±€éƒ¨å¯¹è±¡ï¼ˆRVOä¼˜åŒ–å¤±è´¥æ—¶ï¼‰
BigData func() {
    BigData temp;
    return temp;  // è‡ªåŠ¨ä½¿ç”¨ç§»åŠ¨æ„é€ 
}

// 2ï¸âƒ£ å®¹å™¨æ‰©å®¹
vector<BigData> vec;
vec.push_back(BigData());  // è‡ªåŠ¨ä½¿ç”¨ç§»åŠ¨æ„é€ 

// 3ï¸âƒ£ æ˜¾å¼std::move
BigData b1;
BigData b2 = std::move(b1);  // æ˜¾å¼ç§»åŠ¨

// âŒ ä¸ä¼šè‡ªåŠ¨ç§»åŠ¨çš„æƒ…å†µï¼š
BigData func(BigData& b) {
    return b;  // âŒ bæ˜¯å·¦å€¼å¼•ç”¨ï¼Œæ‹·è´è€Œä¸æ˜¯ç§»åŠ¨
}

BigData func(BigData& b) {
    return std::move(b);  // âœ… æ˜¾å¼ç§»åŠ¨
}
```

#### 4ï¸âƒ£ å®Œç¾è½¬å‘æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// é—®é¢˜ï¼šå¦‚ä½•å°†å‚æ•°åŸå°ä¸åŠ¨åœ°è½¬å‘ï¼Ÿ
template<typename T>
void wrapper(T& arg) {
    func(arg);  // argæ˜¯å·¦å€¼ï¼Œå³ä½¿ä¼ å…¥å³å€¼ä¹Ÿå˜æˆå·¦å€¼äº†
}

// è§£å†³ï¼šstd::forward + ä¸‡èƒ½å¼•ç”¨
template<typename T>
void wrapper(T&& arg) {  // ğŸ”‘ ä¸‡èƒ½å¼•ç”¨ï¼ˆè½¬å‘å¼•ç”¨ï¼‰
    func(std::forward<T>(arg));  // ğŸ”‘ å®Œç¾è½¬å‘
}

void func(int& x) { cout << "å·¦å€¼\n"; }
void func(int&& x) { cout << "å³å€¼\n"; }

int a = 10;
wrapper(a);   // è¾“å‡ºï¼šå·¦å€¼
wrapper(10);  // è¾“å‡ºï¼šå³å€¼  â† å®Œç¾è½¬å‘ä¿æŒäº†å³å€¼ç‰¹æ€§
```

**ä¸‡èƒ½å¼•ç”¨çš„è§„åˆ™ï¼š**
```cpp
template<typename T>
void func(T&& arg);  // âœ… ä¸‡èƒ½å¼•ç”¨ï¼ˆæ¨¡æ¿å‚æ•°ï¼‰

auto&& var = ...;    // âœ… ä¸‡èƒ½å¼•ç”¨ï¼ˆautoï¼‰

void func(int&& arg);  // âŒ æ™®é€šå³å€¼å¼•ç”¨ï¼ˆå…·ä½“ç±»å‹ï¼‰
```

#### 5ï¸âƒ£ å¦‚ä½•å®ç°ä¸€ä¸ªæ”¯æŒç§»åŠ¨çš„ç±»ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
class MyString {
    char* data;
    size_t len;
public:
    // æ„é€ å‡½æ•°
    MyString(const char* str = "") {
        len = strlen(str);
        data = new char[len + 1];
        strcpy(data, str);
    }

    // æ‹·è´æ„é€ 
    MyString(const MyString& other) {
        len = other.len;
        data = new char[len + 1];
        strcpy(data, other.data);
    }

    // ğŸ”‘ ç§»åŠ¨æ„é€ 
    MyString(MyString&& other) noexcept {
        data = other.data;    // çªƒå–èµ„æº
        len = other.len;
        other.data = nullptr; // æ¸…ç©ºåŸå¯¹è±¡
        other.len = 0;
    }

    // æ‹·è´èµ‹å€¼
    MyString& operator=(const MyString& other) {
        if (this != &other) {
            delete[] data;
            len = other.len;
            data = new char[len + 1];
            strcpy(data, other.data);
        }
        return *this;
    }

    // ğŸ”‘ ç§»åŠ¨èµ‹å€¼
    MyString& operator=(MyString&& other) noexcept {
        if (this != &other) {
            delete[] data;        // é‡Šæ”¾è‡ªå·±çš„èµ„æº
            data = other.data;    // çªƒå–èµ„æº
            len = other.len;
            other.data = nullptr; // æ¸…ç©ºåŸå¯¹è±¡
            other.len = 0;
        }
        return *this;
    }

    // ææ„å‡½æ•°
    ~MyString() {
        delete[] data;
    }
};

// ğŸ”‘ äº”æ³•åˆ™ï¼ˆC++11ï¼‰ï¼š
// å¦‚æœå®šä¹‰äº†ä»¥ä¸‹ä»»æ„ä¸€ä¸ªï¼Œåº”è¯¥å®šä¹‰æ‰€æœ‰äº”ä¸ªï¼š
// 1. ææ„å‡½æ•°
// 2. æ‹·è´æ„é€ 
// 3. æ‹·è´èµ‹å€¼
// 4. ç§»åŠ¨æ„é€ 
// 5. ç§»åŠ¨èµ‹å€¼
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
å³å€¼å¼•ç”¨æ˜¯C++11å¼•å…¥çš„ç‰¹æ€§ï¼Œç”¨&&è¡¨ç¤ºï¼Œä¸»è¦ç”¨äºï¼š

1. ç§»åŠ¨è¯­ä¹‰
   - é¿å…æ·±æ‹·è´ï¼Œæé«˜æ€§èƒ½
   - ç§»åŠ¨æ„é€ å’Œç§»åŠ¨èµ‹å€¼
   - "çªƒå–"ä¸´æ—¶å¯¹è±¡çš„èµ„æº

2. å®Œç¾è½¬å‘
   - ä¿æŒå‚æ•°çš„å·¦å€¼/å³å€¼å±æ€§
   - std::forwardå®ç°

æ ¸å¿ƒæ¦‚å¿µï¼š
- å·¦å€¼ï¼šæœ‰åå­—ï¼Œå¯å–åœ°å€
- å³å€¼ï¼šä¸´æ—¶å¯¹è±¡ï¼Œä¸å¯å–åœ°å€
- std::moveï¼šå°†å·¦å€¼è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ï¼ˆåªæ˜¯ç±»å‹è½¬æ¢ï¼‰

ã€è¿½é—®-moveåšäº†ä»€ä¹ˆã€‘
std::moveåªæ˜¯ç±»å‹è½¬æ¢ï¼Œå°†å·¦å€¼å¼ºåˆ¶è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ã€‚
çœŸæ­£çš„"ç§»åŠ¨"å‘ç”Ÿåœ¨ç§»åŠ¨æ„é€ å‡½æ•°æˆ–ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ä¸­ï¼Œ
é€šè¿‡çªƒå–èµ„æºæŒ‡é’ˆã€æ¸…ç©ºåŸå¯¹è±¡æ¥å®ç°ã€‚

ã€è¿½é—®-ç§»åŠ¨åèƒ½å†ç”¨å—ã€‘
ç§»åŠ¨åçš„å¯¹è±¡å¤„äº"æœ‰æ•ˆä½†æœªæŒ‡å®š"çŠ¶æ€ï¼š
- å¯ä»¥èµ‹å€¼
- å¯ä»¥ææ„
- ä¸åº”è¯¥ä½¿ç”¨å…¶å€¼ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰

ã€è¿½é—®-æ€§èƒ½æå‡ã€‘
å¯¹äºç®¡ç†èµ„æºçš„ç±»ï¼ˆå¦‚vectorã€stringï¼‰ï¼Œ
ç§»åŠ¨æ¯”æ‹·è´å¿«å¾—å¤šï¼š
- æ‹·è´ï¼šO(n)ï¼ˆæ·±æ‹·è´æ‰€æœ‰å…ƒç´ ï¼‰
- ç§»åŠ¨ï¼šO(1)ï¼ˆåªè½¬ç§»æŒ‡é’ˆï¼‰
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸ºmoveä¼šç§»åŠ¨å¯¹è±¡
âœ… **æ­£ç¡®**ï¼šmoveåªæ˜¯ç±»å‹è½¬æ¢ï¼Œå®é™…ç§»åŠ¨åœ¨ç§»åŠ¨æ„é€ ä¸­

âŒ **é”™è¯¯2**ï¼šç§»åŠ¨åçš„å¯¹è±¡ä¸èƒ½å†ç”¨
âœ… **æ­£ç¡®**ï¼šå¯ä»¥èµ‹å€¼å’Œææ„ï¼Œä½†ä¸åº”ä½¿ç”¨å…¶å€¼

âŒ **é”™è¯¯3**ï¼šæ‰€æœ‰å³å€¼å¼•ç”¨éƒ½æ˜¯ä¸‡èƒ½å¼•ç”¨
âœ… **æ­£ç¡®**ï¼šåªæœ‰T&&ï¼ˆæ¨¡æ¿ï¼‰å’Œauto&&æ˜¯ä¸‡èƒ½å¼•ç”¨

âŒ **é”™è¯¯4**ï¼šè¿”å›å±€éƒ¨å¯¹è±¡åº”è¯¥ç”¨std::move
âœ… **æ­£ç¡®**ï¼šç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¼˜åŒ–ï¼ˆRVOï¼‰ï¼Œæ‰‹åŠ¨moveåè€Œé˜»æ­¢ä¼˜åŒ–

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°RVO/NRVOä¼˜åŒ–ï¼ˆè¿”å›å€¼ä¼˜åŒ–ï¼‰
- çŸ¥é“noexceptå¯¹ç§»åŠ¨è¯­ä¹‰çš„å½±å“ï¼ˆvectoræ‰©å®¹ï¼‰
- äº†è§£å¼•ç”¨æŠ˜å è§„åˆ™ï¼ˆT& && â†’ T&ï¼‰
- æåˆ°emplace_backæ¯”push_backé«˜æ•ˆçš„åŸå› 

---

## ğŸ“Œ C++11æ–°ç‰¹æ€§ï¼ˆâ­â­â­â­ é«˜é¢‘ï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **auto** | **nullptr** | **lambda** | **range-for** | **override/final** | **=default/=delete** | **åˆ—è¡¨åˆå§‹åŒ–** | **å˜é•¿æ¨¡æ¿**

### âœ… æ ¸å¿ƒæ–°ç‰¹æ€§

#### 1ï¸âƒ£ autoç±»å‹æ¨å¯¼ï¼ˆâ­â­â­â­â­ï¼‰

```cpp
// C++03ï¼šéœ€è¦æ˜¾å¼å†™ç±»å‹
vector<int>::iterator it = vec.begin();
map<string, vector<int>>::iterator mit = m.begin();

// C++11ï¼šè‡ªåŠ¨æ¨å¯¼
auto it = vec.begin();  // âœ… ç®€æ´
auto mit = m.begin();   // âœ… é¿å…å†™å¤æ‚ç±»å‹

// æ³¨æ„äº‹é¡¹ï¼š
auto x = 10;      // int
auto& y = x;      // int&
const auto& z = x;  // const int&

auto a = {1, 2, 3};  // std::initializer_list<int>
```

**ä½¿ç”¨å»ºè®®ï¼š**
```cpp
// âœ… æ¨èä½¿ç”¨autoçš„åœºæ™¯
auto it = vec.begin();  // è¿­ä»£å™¨
auto lambda = [](int x) { return x * 2; };  // lambda
auto ptr = make_unique<int>(10);  // æ™ºèƒ½æŒ‡é’ˆ

// âŒ ä¸æ¨èçš„åœºæ™¯
auto x = 10;  // ç±»å‹ä¸æ˜ç¡®ï¼Œå¯è¯»æ€§å·®
// åº”è¯¥å†™ï¼šint x = 10;
```

#### 2ï¸âƒ£ nullptrï¼ˆâ­â­â­â­â­ï¼‰

```cpp
// C++03çš„é—®é¢˜ï¼š
void func(int x) { cout << "int\n"; }
void func(char* p) { cout << "ptr\n"; }

func(NULL);  // âŒ è°ƒç”¨func(int)ï¼Œå› ä¸ºNULLæ˜¯0

// C++11è§£å†³ï¼š
func(nullptr);  // âœ… è°ƒç”¨func(char*)

// nullptrçš„ç±»å‹ï¼š
nullptr_t n = nullptr;
int* p = nullptr;  // âœ…
// int x = nullptr;  // âŒ é”™è¯¯ï¼šä¸èƒ½è½¬æ¢ä¸ºint
```

#### 3ï¸âƒ£ lambdaè¡¨è¾¾å¼ï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

**åŸºæœ¬è¯­æ³•ï¼š**
```cpp
[capture](parameters) -> return_type { body }

// ç¤ºä¾‹ï¼š
auto add = [](int a, int b) { return a + b; };
cout << add(3, 5);  // è¾“å‡ºï¼š8

// è¿”å›ç±»å‹æ¨å¯¼
auto multiply = [](int a, int b) { return a * b; };  // è‡ªåŠ¨æ¨å¯¼ä¸ºint
```

**æ•è·åˆ—è¡¨ï¼ˆâ­â­â­â­â­ é«˜é¢‘è¿½é—®ï¼‰ï¼š**
```cpp
int x = 10, y = 20;

// [=] å€¼æ•è·ï¼šæ‹·è´å¤–éƒ¨å˜é‡
auto f1 = [=]() { return x + y; };  // âœ…
// auto f2 = [=]() { x++; };  // âŒ é”™è¯¯ï¼šä¸èƒ½ä¿®æ”¹

// [&] å¼•ç”¨æ•è·ï¼šå¯ä¿®æ”¹å¤–éƒ¨å˜é‡
auto f3 = [&]() { x++; y++; };  // âœ…

// [x, &y] æ··åˆæ•è·
auto f4 = [x, &y]() {
    // xæ˜¯æ‹·è´ï¼Œä¸èƒ½æ”¹
    y++;  // yæ˜¯å¼•ç”¨ï¼Œå¯ä»¥æ”¹
};

// [this] æ•è·æˆå‘˜å˜é‡
class Test {
    int value = 10;
public:
    void func() {
        auto f = [this]() { return value; };  // æ•è·thisæŒ‡é’ˆ
        cout << f();
    }
};

// [=, &x] é»˜è®¤å€¼æ•è·ï¼Œxå¼•ç”¨æ•è·
auto f5 = [=, &x]() { x++; return y; };
```

**mutableå…³é”®å­—ï¼š**
```cpp
int x = 10;
auto f = [x]() mutable {
    x++;  // âœ… mutableå…è®¸ä¿®æ”¹æ‹·è´çš„x
    return x;
};
f();  // è¿”å›11
cout << x;  // è¾“å‡ºï¼š10ï¼ˆåŸå§‹xæœªæ”¹å˜ï¼‰
```

#### 4ï¸âƒ£ èŒƒå›´forå¾ªç¯ï¼ˆâ­â­â­â­ï¼‰

```cpp
vector<int> vec = {1, 2, 3, 4, 5};

// C++03
for (vector<int>::iterator it = vec.begin(); it != vec.end(); ++it) {
    cout << *it;
}

// C++11
for (int x : vec) {  // æ‹·è´
    cout << x;
}

for (int& x : vec) {  // å¼•ç”¨ï¼Œå¯ä¿®æ”¹
    x *= 2;
}

for (const auto& x : vec) {  // ğŸŒŸ æ¨èï¼šé¿å…æ‹·è´
    cout << x;
}
```

#### 5ï¸âƒ£ overrideå’Œfinalï¼ˆâ­â­â­â­â­ï¼‰

```cpp
class Base {
public:
    virtual void func1() {}
    virtual void func2() {}
    virtual void func3() {}
};

class Derived : public Base {
public:
    // overrideï¼šæ˜ç¡®è¡¨ç¤ºé‡å†™åŸºç±»è™šå‡½æ•°
    void func1() override {}  // âœ… æ­£ç¡®é‡å†™
    // void func2() const override {}  // âŒ ç¼–è¯‘é”™è¯¯ï¼šç­¾åä¸åŒ¹é…
    void func3() override final {}  // æœ€ç»ˆç‰ˆæœ¬ï¼Œä¸èƒ½å†è¢«é‡å†™
};

class Final final {  // finalç±»ï¼šä¸èƒ½è¢«ç»§æ‰¿
    // ...
};

// class Derived : public Final {};  // âŒ ç¼–è¯‘é”™è¯¯
```

#### 6ï¸âƒ£ =defaultå’Œ=deleteï¼ˆâ­â­â­â­â­ï¼‰

```cpp
class NonCopyable {
public:
    NonCopyable() = default;  // ä½¿ç”¨é»˜è®¤æ„é€ 

    // ç¦æ­¢æ‹·è´
    NonCopyable(const NonCopyable&) = delete;
    NonCopyable& operator=(const NonCopyable&) = delete;

    // å…è®¸ç§»åŠ¨
    NonCopyable(NonCopyable&&) = default;
    NonCopyable& operator=(NonCopyable&&) = default;
};

// ç¦æ­¢æŸäº›ç±»å‹çš„éšå¼è½¬æ¢
class Test {
public:
    Test(int x) {}
    Test(double) = delete;  // ç¦æ­¢doubleè½¬æ¢
};

Test t1(10);   // âœ…
// Test t2(3.14);  // âŒ ç¼–è¯‘é”™è¯¯
```

#### 7ï¸âƒ£ åˆ—è¡¨åˆå§‹åŒ–ï¼ˆâ­â­â­â­ï¼‰

```cpp
// ç»Ÿä¸€åˆå§‹åŒ–è¯­æ³•
int x{10};
int arr[]{1, 2, 3};
vector<int> vec{1, 2, 3, 4, 5};
map<int, string> m{{1, "one"}, {2, "two"}};

// é˜²æ­¢çª„åŒ–è½¬æ¢
int a = 3.14;   // âœ… å…è®¸ï¼ˆC++03ï¼‰
// int b{3.14};  // âŒ é”™è¯¯ï¼šçª„åŒ–è½¬æ¢

// åˆå§‹åŒ–åˆ—è¡¨æ„é€ 
class Point {
public:
    Point(initializer_list<int> lst) {
        // ...
    }
};

Point p{1, 2, 3};  // è°ƒç”¨initializer_listæ„é€ 
```

#### 8ï¸âƒ£ å˜é•¿æ¨¡æ¿ï¼ˆâ­â­â­â­ï¼‰

```cpp
// é€’å½’å±•å¼€
template<typename T>
void print(T t) {
    cout << t << endl;
}

template<typename T, typename... Args>
void print(T first, Args... args) {
    cout << first << ", ";
    print(args...);  // é€’å½’è°ƒç”¨
}

print(1, 2.5, "hello");  // è¾“å‡ºï¼š1, 2.5, hello

// C++17æŠ˜å è¡¨è¾¾å¼ï¼ˆæ›´ç®€æ´ï¼‰
template<typename... Args>
void print(Args... args) {
    ((cout << args << " "), ...);  // æŠ˜å è¡¨è¾¾å¼
}
```

### ğŸ”¥ å…¶ä»–é‡è¦æ–°ç‰¹æ€§

#### 9ï¸âƒ£ usingåˆ«åï¼ˆâ­â­â­â­ï¼‰

```cpp
// C++03: typedef
typedef void (*FuncPtr)(int, int);

// C++11: usingï¼ˆæ›´æ¸…æ™°ï¼‰
using FuncPtr = void(*)(int, int);

// æ¨¡æ¿åˆ«åï¼ˆtypedefåšä¸åˆ°ï¼‰
template<typename T>
using Vec = vector<T>;

Vec<int> v;  // ç­‰ä»·äºvector<int>
```

#### ğŸ”Ÿ å§”æ‰˜æ„é€ ï¼ˆâ­â­â­ï¼‰

```cpp
class Test {
    int x, y;
public:
    Test() : Test(0, 0) {}  // å§”æ‰˜ç»™ä¸‹é¢çš„æ„é€ 
    Test(int a) : Test(a, 0) {}  // å§”æ‰˜
    Test(int a, int b) : x(a), y(b) {}  // çœŸæ­£çš„æ„é€ 
};
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€å¸¸è§å›ç­”ã€‘
C++11ä¸»è¦æ–°ç‰¹æ€§åŒ…æ‹¬ï¼š

1. autoç±»å‹æ¨å¯¼ - ç®€åŒ–ä»£ç ï¼Œè‡ªåŠ¨æ¨å¯¼ç±»å‹
2. nullptr - æ›¿ä»£NULLï¼Œç±»å‹å®‰å…¨
3. lambdaè¡¨è¾¾å¼ - åŒ¿åå‡½æ•°ï¼Œç®€åŒ–å›è°ƒ
4. æ™ºèƒ½æŒ‡é’ˆ - unique_ptrã€shared_ptrã€weak_ptr
5. å³å€¼å¼•ç”¨å’Œç§»åŠ¨è¯­ä¹‰ - æé«˜æ€§èƒ½
6. range-forå¾ªç¯ - ç®€åŒ–éå†
7. override/final - æ˜ç¡®è™šå‡½æ•°é‡å†™
8. =default/=delete - æ§åˆ¶ç‰¹æ®Šæˆå‘˜å‡½æ•°
9. åˆ—è¡¨åˆå§‹åŒ– - ç»Ÿä¸€åˆå§‹åŒ–è¯­æ³•
10. å˜é•¿æ¨¡æ¿ - å¯å˜å‚æ•°æ¨¡æ¿

ã€è¿½é—®-lambdaæ•è·ã€‘
- [=] å€¼æ•è·ï¼šæ‹·è´å¤–éƒ¨å˜é‡ï¼Œä¸å¯ä¿®æ”¹ï¼ˆé™¤émutableï¼‰
- [&] å¼•ç”¨æ•è·ï¼šå¯ä¿®æ”¹å¤–éƒ¨å˜é‡
- [this] æ•è·æˆå‘˜å˜é‡
- [x, &y] æ··åˆæ•è·

ã€è¿½é—®-overrideçš„ä½œç”¨ã€‘
æ˜ç¡®è¡¨ç¤ºé‡å†™åŸºç±»è™šå‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥ï¼š
1. åŸºç±»å¿…é¡»æœ‰è¿™ä¸ªè™šå‡½æ•°
2. å‡½æ•°ç­¾åå¿…é¡»å®Œå…¨åŒ¹é…
é˜²æ­¢å› æ‹¼å†™é”™è¯¯æˆ–ç­¾åä¸åŒ¹é…å¯¼è‡´çš„éšè—è€Œéé‡å†™
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šlambdaå€¼æ•è·å¯ä»¥ä¿®æ”¹å¤–éƒ¨å˜é‡
âœ… **æ­£ç¡®**ï¼šéœ€è¦åŠ mutableï¼Œä¸”åªä¿®æ”¹æ‹·è´

âŒ **é”™è¯¯2**ï¼šnullptrå’ŒNULLå®Œå…¨ä¸€æ ·
âœ… **æ­£ç¡®**ï¼šnullptrç±»å‹å®‰å…¨ï¼ŒNULLæ˜¯æ•´æ•°0

âŒ **é”™è¯¯3**ï¼šautoæ€»æ˜¯å¥½çš„
âœ… **æ­£ç¡®**ï¼šç®€å•ç±»å‹ä¸å»ºè®®ç”¨autoï¼Œé™ä½å¯è¯»æ€§

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°C++14/17çš„æ”¹è¿›ï¼ˆæ³›å‹lambdaã€if constexprï¼‰
- çŸ¥é“lambdaçš„åº•å±‚å®ç°ï¼ˆä»¿å‡½æ•°ï¼‰
- äº†è§£å®Œç¾è½¬å‘å’Œä¸‡èƒ½å¼•ç”¨
- æåˆ°åˆ—è¡¨åˆå§‹åŒ–çš„ä¼˜å…ˆçº§é—®é¢˜

---

## ğŸ“Œ constexprï¼ˆâ­â­â­â­ é«˜é¢‘ï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **ç¼–è¯‘æœŸå¸¸é‡** | **å¸¸é‡è¡¨è¾¾å¼** | **constexprå‡½æ•°** | **constexpr if** | **å­—é¢é‡ç±»å‹** | **æ€§èƒ½ä¼˜åŒ–**

### âœ… constexpr vs const

```cpp
// const: è¿è¡Œæ—¶æˆ–ç¼–è¯‘æ—¶å¸¸é‡
const int x = 10;           // ç¼–è¯‘æ—¶
const int y = func();       // è¿è¡Œæ—¶

// constexpr: å¿…é¡»æ˜¯ç¼–è¯‘æ—¶å¸¸é‡
constexpr int a = 10;       // âœ… ç¼–è¯‘æ—¶
// constexpr int b = func();  // âŒ é”™è¯¯ï¼ˆé™¤éfuncæ˜¯constexprï¼‰

// ğŸ”‘ åŒºåˆ«ï¼š
// conståªä¿è¯ä¸å¯ä¿®æ”¹
// constexprä¿è¯ç¼–è¯‘æ—¶è®¡ç®—
```

### ğŸ’¡ constexprå‡½æ•°ï¼ˆâ­â­â­â­â­ æ ¸å¿ƒï¼‰

**C++11è§„åˆ™ï¼š**
```cpp
// constexprå‡½æ•°å¿…é¡»ï¼š
// 1. åªæœ‰ä¸€ä¸ªreturnè¯­å¥
// 2. ä¸èƒ½æœ‰å±€éƒ¨å˜é‡
constexpr int square(int x) {
    return x * x;
}

constexpr int x = square(5);  // ç¼–è¯‘æ—¶è®¡ç®—ï¼Œx=25
int arr[square(5)];  // âœ… å¯ä»¥ç”¨äºæ•°ç»„å¤§å°

// é€’å½’å®ç°é˜¶ä¹˜
constexpr int factorial(int n) {
    return n <= 1 ? 1 : n * factorial(n - 1);
}

constexpr int result = factorial(5);  // ç¼–è¯‘æ—¶è®¡ç®—ï¼Œresult=120
```

**C++14æ”¾å®½é™åˆ¶ï¼š**
```cpp
// C++14å¯ä»¥æœ‰å¤šæ¡è¯­å¥
constexpr int fibonacci(int n) {
    if (n <= 1) return n;

    int a = 0, b = 1;
    for (int i = 2; i <= n; ++i) {
        int temp = a + b;
        a = b;
        b = temp;
    }
    return b;
}

constexpr int fib10 = fibonacci(10);  // ç¼–è¯‘æ—¶è®¡ç®—
```

### ğŸ’» constexprç±»ï¼ˆâ­â­â­â­ï¼‰

```cpp
class Point {
    int x_, y_;
public:
    constexpr Point(int x, int y) : x_(x), y_(y) {}

    constexpr int x() const { return x_; }
    constexpr int y() const { return y_; }

    constexpr int distance() const {
        return x_ * x_ + y_ * y_;
    }
};

constexpr Point p(3, 4);
constexpr int dist = p.distance();  // ç¼–è¯‘æ—¶è®¡ç®—ï¼Œdist=25

// å¯ä»¥ç”¨äºæ•°ç»„å¤§å°
int arr[p.distance()];  // âœ…
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ constexprå’Œå®çš„åŒºåˆ«ï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

```cpp
// å®ï¼šæ–‡æœ¬æ›¿æ¢ï¼Œä¸å®‰å…¨
#define SQUARE(x) x * x
int result = SQUARE(1 + 2);  // âŒ å±•å¼€ä¸º 1 + 2 * 1 + 2 = 5

// constexprï¼šç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶è®¡ç®—
constexpr int square(int x) { return x * x; }
int result = square(1 + 2);  // âœ… æ­£ç¡®ç»“æœï¼š9
```

#### 2ï¸âƒ£ ä»€ä¹ˆæ—¶å€™ç”¨constexprï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// âœ… æ¨èä½¿ç”¨åœºæ™¯ï¼š
// 1. ç¼–è¯‘æ—¶è®¡ç®—
constexpr int size = 1024;
int arr[size];

// 2. ä¼˜åŒ–æ€§èƒ½ï¼ˆé¿å…è¿è¡Œæ—¶è®¡ç®—ï¼‰
constexpr double pi = 3.1415926;
constexpr double area(double r) { return pi * r * r; }

// 3. æ¨¡æ¿å…ƒç¼–ç¨‹
template<int N>
struct Factorial {
    static constexpr int value = N * Factorial<N-1>::value;
};

// âŒ ä¸é€‚åˆçš„åœºæ™¯ï¼š
// æ¶‰åŠè¿è¡Œæ—¶æ‰èƒ½ç¡®å®šçš„å€¼
constexpr int x = getUserInput();  // âŒ é”™è¯¯
```

#### 3ï¸âƒ£ C++17çš„constexpr ifï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
template<typename T>
auto getValue(T t) {
    if constexpr (is_pointer_v<T>) {  // ç¼–è¯‘æ—¶åˆ¤æ–­
        return *t;  // Tæ˜¯æŒ‡é’ˆ
    } else {
        return t;   // Tä¸æ˜¯æŒ‡é’ˆ
    }
}

int x = 10;
int* p = &x;

auto a = getValue(x);   // è¿”å›x
auto b = getValue(p);   // è¿”å›*p

// ğŸ”‘ æ™®é€šif vs constexpr ifï¼š
// æ™®é€šifï¼šä¸¤ä¸ªåˆ†æ”¯éƒ½è¦ç¼–è¯‘é€šè¿‡
// constexpr ifï¼šæœªé€‰ä¸­çš„åˆ†æ”¯ä¸ç¼–è¯‘
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
constexprè¡¨ç¤ºç¼–è¯‘æœŸå¸¸é‡ï¼Œä¸»è¦ç”¨äºï¼š

1. constexprå˜é‡
   - å¿…é¡»åœ¨ç¼–è¯‘æ—¶ç¡®å®š
   - å¯ç”¨äºæ•°ç»„å¤§å°ã€æ¨¡æ¿å‚æ•°

2. constexprå‡½æ•°
   - å‚æ•°æ˜¯å¸¸é‡æ—¶ï¼Œç¼–è¯‘æ—¶è®¡ç®—
   - å‚æ•°æ˜¯å˜é‡æ—¶ï¼Œè¿è¡Œæ—¶è®¡ç®—

3. constexprç±»
   - æ„é€ å‡½æ•°å’Œæˆå‘˜å‡½æ•°å¯ä»¥æ˜¯constexpr
   - æ”¯æŒç¼–è¯‘æ—¶å¯¹è±¡åˆ›å»º

ä¼˜åŠ¿ï¼š
- æé«˜æ€§èƒ½ï¼ˆç¼–è¯‘æ—¶è®¡ç®—ï¼Œæ— è¿è¡Œæ—¶å¼€é”€ï¼‰
- ç±»å‹å®‰å…¨ï¼ˆä¼˜äºå®ï¼‰
- å¯è°ƒè¯•ï¼ˆæœ‰ç¬¦å·è¡¨ï¼‰

ã€è¿½é—®-å’ŒconståŒºåˆ«ã€‘
conståªä¿è¯ä¸å¯ä¿®æ”¹ï¼Œå¯ä»¥æ˜¯è¿è¡Œæ—¶å¸¸é‡
constexprä¿è¯ç¼–è¯‘æ—¶å¸¸é‡ï¼Œæ›´ä¸¥æ ¼

ã€è¿½é—®-å’ŒinlineåŒºåˆ«ã€‘
inlineå»ºè®®å†…è”ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€
constexprä¿è¯ç¼–è¯‘æ—¶è®¡ç®—ï¼Œå¯èƒ½å®Œå…¨æ¶ˆé™¤å‡½æ•°è°ƒç”¨
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šconstexprå‡½æ•°æ€»æ˜¯ç¼–è¯‘æ—¶è®¡ç®—
âœ… **æ­£ç¡®**ï¼šå‚æ•°æ˜¯å˜é‡æ—¶ï¼Œè¿è¡Œæ—¶è®¡ç®—

âŒ **é”™è¯¯2**ï¼šæ‰€æœ‰constéƒ½å¯ä»¥æ”¹æˆconstexpr
âœ… **æ­£ç¡®**ï¼šconstexprè¦æ±‚ç¼–è¯‘æ—¶å¯è®¡ç®—

âŒ **é”™è¯¯3**ï¼šconstexprå’Œinlineç­‰ä»·
âœ… **æ­£ç¡®**ï¼šconstexpréšå«inlineï¼Œä½†å«ä¹‰ä¸åŒ

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°C++20çš„constexpræ”¹è¿›ï¼ˆè™šå‡½æ•°ã€åŠ¨æ€å†…å­˜ï¼‰
- çŸ¥é“constexpræ„é€ å‡½æ•°çš„é™åˆ¶
- äº†è§£å­—é¢é‡ç±»å‹ï¼ˆliteral typeï¼‰
- æåˆ°constevalï¼ˆC++20ï¼Œå¿…é¡»ç¼–è¯‘æ—¶è®¡ç®—ï¼‰

---

## ğŸ“Œ mapå’Œsetåº•å±‚å®ç°ï¼ˆâ­â­â­â­ é«˜é¢‘ï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **çº¢é»‘æ ‘** | **æœ‰åº** | **O(logn)** | **pair** | **lower_bound** | **upper_bound** | **unordered_map** | **å“ˆå¸Œè¡¨**

### âœ… mapåº•å±‚ç»“æ„

```cpp
// mapåº•å±‚æ˜¯çº¢é»‘æ ‘ï¼ŒèŠ‚ç‚¹å­˜å‚¨pair<key, value>
template<typename Key, typename Value>
class map {
    // çº¢é»‘æ ‘èŠ‚ç‚¹
    struct Node {
        pair<const Key, Value> data;  // ğŸ”‘ keyæ˜¯const
        Node* left;
        Node* right;
        Node* parent;
        Color color;  // çº¢æˆ–é»‘
    };

    Node* root;
    size_t size;
};
```

**å†…å­˜å¸ƒå±€ï¼š**
```
       [10, "ten"]é»‘
       /          \
  [5, "five"]çº¢  [15, "fifteen"]çº¢
  /      \         /           \
[3]é»‘  [7]é»‘   [12]é»‘       [18]é»‘

ğŸ”‘ ç‰¹ç‚¹ï¼š
1. æŒ‰keyæœ‰åºï¼ˆé»˜è®¤å‡åºï¼‰
2. keyå”¯ä¸€
3. æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ï¼šO(logn)
```

### ğŸ’¡ mapçš„å…³é”®æ“ä½œï¼ˆâ­â­â­â­â­ï¼‰

**æ’å…¥ï¼š**
```cpp
map<int, string> m;

// æ–¹å¼1ï¼š[]è¿ç®—ç¬¦
m[1] = "one";  // å¦‚æœkeyä¸å­˜åœ¨ï¼Œæ’å…¥ï¼›å­˜åœ¨åˆ™è¦†ç›–

// æ–¹å¼2ï¼šinsert
m.insert({2, "two"});  // è¿”å›pair<iterator, bool>
auto [it, success] = m.insert({2, "TWO"});  // C++17
// success = falseï¼ˆkeyå·²å­˜åœ¨ï¼‰

// æ–¹å¼3ï¼šemplaceï¼ˆC++11ï¼ŒåŸåœ°æ„é€ ï¼‰
m.emplace(3, "three");  // é¿å…ä¸´æ—¶å¯¹è±¡

// ğŸ”‘ []å’Œinsertçš„åŒºåˆ«ï¼š
m[100];  // keyä¸å­˜åœ¨ï¼Œæ’å…¥default valueï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰
m.insert({100, "hundred"});  // keyä¸å­˜åœ¨æ‰æ’å…¥
```

**æŸ¥æ‰¾ï¼š**
```cpp
// find: è¿”å›è¿­ä»£å™¨
auto it = m.find(5);
if (it != m.end()) {
    cout << it->second;  // è®¿é—®value
}

// count: è¿”å›0æˆ–1ï¼ˆkeyå”¯ä¸€ï¼‰
if (m.count(5)) {
    cout << "å­˜åœ¨";
}

// []: ä¸å­˜åœ¨ä¼šæ’å…¥
string s = m[999];  // âš ï¸ ä¼šæ’å…¥{999, ""}

// at: ä¸å­˜åœ¨æŠ›å¼‚å¸¸
try {
    string s = m.at(999);  // æŠ›å‡ºout_of_range
} catch(...) {}
```

**lower_bound / upper_boundï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰ï¼š**
```cpp
map<int, string> m = {{1,"a"}, {3,"c"}, {5,"e"}, {7,"g"}};

// lower_bound: ç¬¬ä¸€ä¸ª >= key çš„ä½ç½®
auto it1 = m.lower_bound(3);  // æŒ‡å‘{3, "c"}
auto it2 = m.lower_bound(4);  // æŒ‡å‘{5, "e"}

// upper_bound: ç¬¬ä¸€ä¸ª > key çš„ä½ç½®
auto it3 = m.upper_bound(3);  // æŒ‡å‘{5, "e"}
auto it4 = m.upper_bound(4);  // æŒ‡å‘{5, "e"}

// ğŸ”‘ åº”ç”¨ï¼šæŸ¥æ‰¾èŒƒå›´
// æŸ¥æ‰¾[2, 6)èŒƒå›´çš„å…ƒç´ 
auto start = m.lower_bound(2);  // >= 2
auto end = m.upper_bound(6);    // > 6
for (auto it = start; it != end; ++it) {
    cout << it->first << endl;  // è¾“å‡ºï¼š3, 5
}
```

### ğŸ’» setåº•å±‚å®ç°

```cpp
// setåº•å±‚ä¹Ÿæ˜¯çº¢é»‘æ ‘ï¼ŒèŠ‚ç‚¹åªå­˜key
template<typename Key>
class set {
    struct Node {
        const Key data;  // ğŸ”‘ keyæ˜¯constï¼ˆä¸å¯ä¿®æ”¹ï¼‰
        Node* left;
        Node* right;
        Color color;
    };
};

// setçš„keyæ—¢æ˜¯keyä¹Ÿæ˜¯value
set<int> s = {3, 1, 4, 1, 5};
// å†…éƒ¨å­˜å‚¨ï¼š1, 3, 4, 5ï¼ˆè‡ªåŠ¨å»é‡ã€æ’åºï¼‰

// æ’å…¥
s.insert(2);
s.emplace(6);

// æŸ¥æ‰¾
if (s.find(3) != s.end()) {
    cout << "å­˜åœ¨";
}

// lower_bound / upper_bound
auto it1 = s.lower_bound(3);  // æŒ‡å‘3
auto it2 = s.upper_bound(3);  // æŒ‡å‘4
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ mapå’Œunordered_mapçš„åŒºåˆ«ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

| ç‰¹æ€§ | map | unordered_map |
|------|-----|---------------|
| **åº•å±‚** | çº¢é»‘æ ‘ | å“ˆå¸Œè¡¨ |
| **æœ‰åºæ€§** | æœ‰åºï¼ˆå‡åºï¼‰ | æ— åº |
| **æŸ¥æ‰¾** | O(logn) | O(1)å¹³å‡ |
| **æ’å…¥** | O(logn) | O(1)å¹³å‡ |
| **åˆ é™¤** | O(logn) | O(1)å¹³å‡ |
| **ç©ºé—´** | è¾ƒå° | è¾ƒå¤§ï¼ˆå“ˆå¸Œè¡¨+é“¾è¡¨ï¼‰ |
| **é€‚ç”¨** | éœ€è¦æœ‰åº | åªéœ€æŸ¥æ‰¾ |

```cpp
map<int, string> m;          // çº¢é»‘æ ‘ï¼Œæœ‰åº
unordered_map<int, string> um;  // å“ˆå¸Œè¡¨ï¼Œæ— åº

m[3] = "c"; m[1] = "a"; m[2] = "b";
// éå†m: 1, 2, 3ï¼ˆæœ‰åºï¼‰

um[3] = "c"; um[1] = "a"; um[2] = "b";
// éå†um: é¡ºåºä¸ç¡®å®šï¼ˆæ— åºï¼‰
```

#### 2ï¸âƒ£ ä¸ºä»€ä¹ˆmapçš„keyå¿…é¡»æ˜¯constï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
map<int, string> m = {{1, "one"}, {2, "two"}};

auto it = m.begin();
// it->first = 100;  // âŒ ç¼–è¯‘é”™è¯¯ï¼škeyæ˜¯const

// åŸå› ï¼š
// 1. mapæŒ‰keyæ’åºï¼Œä¿®æ”¹keyä¼šç ´åæ ‘ç»“æ„
// 2. ä¿®æ”¹keyå¯èƒ½å¯¼è‡´é‡å¤key
// 3. å¦‚æœè¦æ”¹keyï¼Œå¿…é¡»åˆ é™¤å†æ’å…¥

// æ­£ç¡®åšæ³•ï¼š
string value = m[1];
m.erase(1);
m[100] = value;
```

#### 3ï¸âƒ£ è‡ªå®šä¹‰ç±»å‹ä½œä¸ºmapçš„keyï¼Ÿï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

```cpp
struct Person {
    string name;
    int age;

    // ğŸ”‘ å¿…é¡»å®šä¹‰operator<
    bool operator<(const Person& other) const {
        if (name != other.name)
            return name < other.name;
        return age < other.age;
    }
};

map<Person, string> m;
m[{"Alice", 20}] = "Student";

// æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå™¨
struct PersonCmp {
    bool operator()(const Person& a, const Person& b) const {
        return a.age < b.age;  // æŒ‰å¹´é¾„æ’åº
    }
};

map<Person, string, PersonCmp> m2;
```

#### 4ï¸âƒ£ multimapå’Œmultisetï¼Ÿï¼ˆâ­â­â­ï¼‰

```cpp
// multimap: å…è®¸é‡å¤key
multimap<int, string> mm;
mm.insert({1, "one"});
mm.insert({1, "ONE"});  // âœ… å…è®¸é‡å¤key
mm.insert({1, "å£¹"});

// æŸ¥æ‰¾æ‰€æœ‰key=1çš„å…ƒç´ 
auto range = mm.equal_range(1);
for (auto it = range.first; it != range.second; ++it) {
    cout << it->second << endl;
}
// è¾“å‡ºï¼šone, ONE, å£¹

// multiset: å…è®¸é‡å¤å…ƒç´ 
multiset<int> ms = {1, 1, 2, 2, 3};
cout << ms.count(1);  // è¾“å‡ºï¼š2
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
mapå’Œsetåº•å±‚éƒ½æ˜¯çº¢é»‘æ ‘å®ç°ï¼š

mapç‰¹ç‚¹ï¼š
1. å­˜å‚¨pair<const Key, Value>
2. æŒ‰keyè‡ªåŠ¨æ’åºï¼ˆé»˜è®¤å‡åºï¼‰
3. keyå”¯ä¸€ï¼Œä¸å¯ä¿®æ”¹
4. æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ï¼šO(logn)

setç‰¹ç‚¹ï¼š
1. åªå­˜å‚¨key
2. è‡ªåŠ¨å»é‡ã€æ’åº
3. å…ƒç´ ä¸å¯ä¿®æ”¹ï¼ˆæ˜¯constï¼‰

å…³é”®æ“ä½œï¼š
- insert/emplaceï¼šæ’å…¥
- findï¼šæŸ¥æ‰¾ï¼Œè¿”å›è¿­ä»£å™¨
- lower_boundï¼š>= keyçš„ç¬¬ä¸€ä¸ªä½ç½®
- upper_boundï¼š> keyçš„ç¬¬ä¸€ä¸ªä½ç½®

ã€è¿½é—®-å’Œunordered_mapåŒºåˆ«ã€‘
mapæ˜¯çº¢é»‘æ ‘ï¼Œæœ‰åºï¼ŒO(logn)
unordered_mapæ˜¯å“ˆå¸Œè¡¨ï¼Œæ— åºï¼ŒO(1)å¹³å‡
éœ€è¦æœ‰åºæ—¶ç”¨mapï¼Œåªéœ€å¿«é€ŸæŸ¥æ‰¾ç”¨unordered_map

ã€è¿½é—®-è‡ªå®šä¹‰ç±»å‹ä½œkeyã€‘
å¿…é¡»å®šä¹‰operator<æˆ–æä¾›æ¯”è¾ƒå™¨
å› ä¸ºçº¢é»‘æ ‘éœ€è¦æ¯”è¾ƒæ¥ç»´æŠ¤é¡ºåº

ã€è¿½é—®-[]å’ŒatåŒºåˆ«ã€‘
[]ï¼škeyä¸å­˜åœ¨æ—¶æ’å…¥é»˜è®¤å€¼
atï¼škeyä¸å­˜åœ¨æ—¶æŠ›å¼‚å¸¸
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸ºmapæŸ¥æ‰¾æ˜¯O(1)
âœ… **æ­£ç¡®**ï¼šmapæ˜¯O(logn)ï¼Œunordered_mapæ‰æ˜¯O(1)

âŒ **é”™è¯¯2**ï¼šå¯ä»¥ä¿®æ”¹mapçš„key
âœ… **æ­£ç¡®**ï¼škeyæ˜¯constï¼Œä¸èƒ½ä¿®æ”¹

âŒ **é”™è¯¯3**ï¼šsetå¯ä»¥å­˜é‡å¤å…ƒç´ 
âœ… **æ­£ç¡®**ï¼šsetè‡ªåŠ¨å»é‡ï¼Œè¦é‡å¤ç”¨multiset

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°mapè¿­ä»£å™¨ä¸ä¼šå¤±æ•ˆï¼ˆé™¤äº†åˆ é™¤çš„å…ƒç´ ï¼‰
- çŸ¥é“çº¢é»‘æ ‘çš„5æ¡æ€§è´¨
- äº†è§£unordered_mapçš„å“ˆå¸Œå†²çªè§£å†³ï¼ˆé“¾åœ°å€æ³•ï¼‰
- æåˆ°C++17çš„try_emplaceï¼ˆä¸è¦†ç›–å·²å­˜åœ¨çš„keyï¼‰

---

## ğŸ“Œ ç¼–è¯‘é“¾æ¥è¿‡ç¨‹ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **é¢„å¤„ç†** | **ç¼–è¯‘** | **æ±‡ç¼–** | **é“¾æ¥** | **é™æ€é“¾æ¥** | **åŠ¨æ€é“¾æ¥** | **ç¬¦å·è¡¨** | **é‡å®šä½** | **ç›®æ ‡æ–‡ä»¶** | **åº“æ–‡ä»¶**

### âœ… ç¼–è¯‘çš„å››ä¸ªé˜¶æ®µ

```cpp
// æºæ–‡ä»¶ï¼šmain.cpp
#include <iostream>
#define MAX 100

int add(int a, int b);

int main() {
    int x = MAX;
    std::cout << add(1, 2) << std::endl;
    return 0;
}
```

**å®Œæ•´è¿‡ç¨‹ï¼š**
```
main.cpp â”€â”€[é¢„å¤„ç†]â”€â”€> main.i â”€â”€[ç¼–è¯‘]â”€â”€> main.s â”€â”€[æ±‡ç¼–]â”€â”€> main.o â”€â”€[é“¾æ¥]â”€â”€> a.out
æºæ–‡ä»¶      å±•å¼€å®/å¤´æ–‡ä»¶    è½¬ä¸ºæ±‡ç¼–ç      è½¬ä¸ºæœºå™¨ç       åˆå¹¶ç›®æ ‡æ–‡ä»¶    å¯æ‰§è¡Œæ–‡ä»¶
```

#### 1ï¸âƒ£ é¢„å¤„ç†ï¼ˆPreprocessingï¼‰â­â­â­â­â­

```bash
# æŸ¥çœ‹é¢„å¤„ç†ç»“æœ
g++ -E main.cpp -o main.i
```

**é¢„å¤„ç†åšä»€ä¹ˆï¼š**
```cpp
// 1. åˆ é™¤æ³¨é‡Š
// This is a comment  â† åˆ é™¤

// 2. å±•å¼€å®å®šä¹‰
#define MAX 100
int x = MAX;
// é¢„å¤„ç†å â†’ int x = 100;

// 3. å¤„ç†#include
#include <iostream>
// é¢„å¤„ç†å â†’ æ’å…¥iostreamçš„å…¨éƒ¨å†…å®¹ï¼ˆæ•°åƒè¡Œï¼‰

// 4. æ¡ä»¶ç¼–è¯‘
#ifdef DEBUG
    cout << "Debug mode\n";
#endif
// å¦‚æœæœªå®šä¹‰DEBUGï¼Œè¿™æ®µä»£ç è¢«åˆ é™¤

// 5. #pragmaæŒ‡ä»¤
#pragma once  // é˜²æ­¢å¤´æ–‡ä»¶é‡å¤åŒ…å«
```

**å¤´æ–‡ä»¶åŒ…å«çš„é—®é¢˜ï¼š**
```cpp
// A.h
#ifndef A_H
#define A_H
class A {};
#endif

// B.h
#include "A.h"
class B : public A {};

// main.cpp
#include "A.h"
#include "B.h"  // ä¼šå†æ¬¡åŒ…å«A.h

// é¢„å¤„ç†åï¼š
// ç¬¬ä¸€æ¬¡#include "A.h" â†’ å®šä¹‰A_Hå®ï¼ŒåŒ…å«class A
// ç¬¬äºŒæ¬¡é€šè¿‡B.håŒ…å«A.h â†’ A_Hå·²å®šä¹‰ï¼Œè·³è¿‡å†…å®¹
// âœ… é¿å…é‡å¤å®šä¹‰
```

**é¢„å¤„ç†åçš„main.iï¼š**
```cpp
// ... iostreamçš„æ‰€æœ‰å†…å®¹ï¼ˆçº¦17000è¡Œï¼‰
namespace std {
    // ...
}

int add(int a, int b);

int main() {
    int x = 100;  // MAXè¢«æ›¿æ¢
    std::cout << add(1, 2) << std::endl;
    return 0;
}
```

#### 2ï¸âƒ£ ç¼–è¯‘ï¼ˆCompilationï¼‰â­â­â­â­â­

```bash
# ç”Ÿæˆæ±‡ç¼–ä»£ç 
g++ -S main.cpp -o main.s
```

**ç¼–è¯‘åšä»€ä¹ˆï¼š**
```
é¢„å¤„ç†åçš„ä»£ç  â†’ è¯æ³•åˆ†æ â†’ è¯­æ³•åˆ†æ â†’ è¯­ä¹‰åˆ†æ â†’ ä¼˜åŒ– â†’ ç”Ÿæˆæ±‡ç¼–ä»£ç 
```

**main.sï¼ˆæ±‡ç¼–ä»£ç ï¼‰ï¼š**
```asm
    .file   "main.cpp"
    .text
    .globl  main
    .type   main, @function
main:
    pushq   %rbp
    movq    %rsp, %rbp
    subq    $16, %rsp

    movl    $100, -4(%rbp)    # int x = 100

    movl    $2, %esi          # ç¬¬äºŒä¸ªå‚æ•°ï¼š2
    movl    $1, %edi          # ç¬¬ä¸€ä¸ªå‚æ•°ï¼š1
    call    add               # è°ƒç”¨addå‡½æ•°

    movl    %eax, %esi        # addçš„è¿”å›å€¼ä½œä¸ºcoutå‚æ•°
    leaq    _ZSt4cout(%rip), %rdi
    call    _ZNSolsEi         # cout << result

    movl    $0, %eax          # return 0
    leave
    ret
```

**ç¼–è¯‘å™¨ä¼˜åŒ–ï¼ˆ-O2ï¼‰ï¼š**
```cpp
// åŸå§‹ä»£ç 
int add(int a, int b) { return a + b; }
int main() {
    int result = add(1, 2);
    return 0;
}

// -O0ï¼ˆæ— ä¼˜åŒ–ï¼‰ï¼šçœŸçš„è°ƒç”¨addå‡½æ•°
call add

// -O2ï¼ˆä¼˜åŒ–ï¼‰ï¼šå†…è”å±•å¼€
movl $3, %eax  # ç¼–è¯‘æ—¶è®¡ç®—å‡ºç»“æœ

// ğŸ”‘ å¸¸é‡æŠ˜å ã€å†…è”ã€æ­»ä»£ç åˆ é™¤ç­‰ä¼˜åŒ–
```

#### 3ï¸âƒ£ æ±‡ç¼–ï¼ˆAssemblyï¼‰â­â­â­â­

```bash
# ç”Ÿæˆç›®æ ‡æ–‡ä»¶
g++ -c main.cpp -o main.o
```

**æ±‡ç¼–åšä»€ä¹ˆï¼š**
```
æ±‡ç¼–ä»£ç  â†’ æœºå™¨ç  + ç¬¦å·è¡¨ + é‡å®šä½ä¿¡æ¯
```

**main.oï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸å¯è¯»ï¼‰ï¼š**
```
ç›®æ ‡æ–‡ä»¶æ ¼å¼ï¼ˆELF/PEï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ELF Header          â”‚  æ–‡ä»¶ç±»å‹ã€æ¶æ„ä¿¡æ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .textæ®µ             â”‚  æœºå™¨ç ï¼ˆæŒ‡ä»¤ï¼‰
â”‚ 55 48 89 e5 ...     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .dataæ®µ             â”‚  å·²åˆå§‹åŒ–çš„å…¨å±€/é™æ€å˜é‡
â”‚ x: 64 00 00 00      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .bssæ®µ              â”‚  æœªåˆå§‹åŒ–çš„å…¨å±€/é™æ€å˜é‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .rodataæ®µ           â”‚  åªè¯»æ•°æ®ï¼ˆå­—ç¬¦ä¸²å¸¸é‡ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¦å·è¡¨              â”‚  å‡½æ•°åã€å˜é‡å â†’ åœ°å€æ˜ å°„
â”‚ main: 0x0000        â”‚
â”‚ add:  æœªå®šä¹‰(U)     â”‚  â† ğŸ”‘ å¤–éƒ¨ç¬¦å·
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é‡å®šä½è¡¨            â”‚  éœ€è¦é“¾æ¥å™¨ä¿®æ­£çš„åœ°å€
â”‚ call add: ?         â”‚  â† éœ€è¦é“¾æ¥æ—¶å¡«å…¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŸ¥çœ‹ç¬¦å·è¡¨ï¼š**
```bash
nm main.o

# è¾“å‡ºï¼š
0000000000000000 T main           # T: å·²å®šä¹‰çš„å‡½æ•°
                 U add            # U: æœªå®šä¹‰ï¼ˆéœ€è¦é“¾æ¥ï¼‰
                 U _ZSt4cout      # U: æœªå®šä¹‰ï¼ˆcoutï¼‰
```

#### 4ï¸âƒ£ é“¾æ¥ï¼ˆLinkingï¼‰â­â­â­â­â­

```bash
# é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
g++ main.o add.o -o a.out
```

**é“¾æ¥åšä»€ä¹ˆï¼š**
```
1. ç¬¦å·è§£æï¼ˆSymbol Resolutionï¼‰
   - æŸ¥æ‰¾æ‰€æœ‰æœªå®šä¹‰ç¬¦å·ï¼ˆUï¼‰
   - åœ¨å…¶ä»–ç›®æ ‡æ–‡ä»¶æˆ–åº“ä¸­æ‰¾åˆ°å®šä¹‰

2. é‡å®šä½ï¼ˆRelocationï¼‰
   - ç¡®å®šæ¯ä¸ªç¬¦å·çš„æœ€ç»ˆåœ°å€
   - ä¿®æ­£æ‰€æœ‰å¼•ç”¨è¿™äº›ç¬¦å·çš„æŒ‡ä»¤
```

**é“¾æ¥è¿‡ç¨‹è¯¦è§£ï¼š**
```
main.o:
  mainå‡½æ•°: 0x0000
  call add: 0x????  â† æœªçŸ¥åœ°å€

add.o:
  addå‡½æ•°: 0x0000

é“¾æ¥åçš„a.out:
  mainå‡½æ•°: 0x1000
  addå‡½æ•°:  0x1050

ä¿®æ­£mainä¸­çš„è°ƒç”¨:
  call add: 0x1050  â† ğŸ”‘ å¡«å…¥å®é™…åœ°å€
```

### ğŸ’¡ é™æ€é“¾æ¥ vs åŠ¨æ€é“¾æ¥ï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

#### é™æ€é“¾æ¥ï¼ˆStatic Linkingï¼‰

```bash
# é™æ€é“¾æ¥åº“ï¼ˆ.a / .libï¼‰
g++ main.cpp -static -o a.out
```

**ç‰¹ç‚¹ï¼š**
```
ä¼˜ç‚¹ï¼š
âœ… ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å¤–éƒ¨åº“
âœ… è¿è¡Œé€Ÿåº¦å¿«ï¼ˆæ— éœ€è¿è¡Œæ—¶åŠ è½½ï¼‰

ç¼ºç‚¹ï¼š
âŒ å¯æ‰§è¡Œæ–‡ä»¶å¤§ï¼ˆåŒ…å«æ‰€æœ‰åº“ä»£ç ï¼‰
âŒ åº“æ›´æ–°æ—¶éœ€è¦é‡æ–°ç¼–è¯‘
âŒ å†…å­˜æµªè´¹ï¼ˆå¤šä¸ªç¨‹åºåŠ è½½åŒä¸€åº“çš„å‰¯æœ¬ï¼‰

ç¤ºä¾‹ï¼š
main.o (10KB) + libstdc++.a (5MB) = a.out (5.01MB)
```

**é™æ€åº“åˆ¶ä½œï¼š**
```bash
# 1. ç¼–è¯‘ç›®æ ‡æ–‡ä»¶
g++ -c add.cpp -o add.o
g++ -c sub.cpp -o sub.o

# 2. æ‰“åŒ…æˆé™æ€åº“
ar rcs libmath.a add.o sub.o

# 3. ä½¿ç”¨é™æ€åº“
g++ main.cpp -L. -lmath -o a.out
# -L.: åº“æœç´¢è·¯å¾„
# -lmath: é“¾æ¥libmath.a
```

#### åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰

```bash
# åŠ¨æ€é“¾æ¥åº“ï¼ˆ.so / .dllï¼‰
g++ main.cpp -o a.out  # é»˜è®¤åŠ¨æ€é“¾æ¥
```

**ç‰¹ç‚¹ï¼š**
```
ä¼˜ç‚¹ï¼š
âœ… å¯æ‰§è¡Œæ–‡ä»¶å°
âœ… å¤šä¸ªç¨‹åºå…±äº«ä¸€ä»½åº“ï¼ˆèŠ‚çœå†…å­˜ï¼‰
âœ… åº“æ›´æ–°æ— éœ€é‡æ–°ç¼–è¯‘ç¨‹åº

ç¼ºç‚¹ï¼š
âŒ ä¾èµ–å¤–éƒ¨åº“ï¼ˆåº“ç¼ºå¤±ç¨‹åºæ— æ³•è¿è¡Œï¼‰
âŒ è¿è¡Œæ—¶åŠ è½½æœ‰æ€§èƒ½å¼€é”€

ç¤ºä¾‹ï¼š
main.o (10KB) = a.out (10KB)
è¿è¡Œæ—¶åŠ è½½libstdc++.so (5MBï¼Œæ‰€æœ‰ç¨‹åºå…±äº«)
```

**åŠ¨æ€åº“åˆ¶ä½œï¼š**
```bash
# 1. ç¼–è¯‘ä½ç½®æ— å…³ä»£ç 
g++ -fPIC -c add.cpp -o add.o
# -fPIC: Position Independent Codeï¼ˆä½ç½®æ— å…³ä»£ç ï¼‰

# 2. ç”ŸæˆåŠ¨æ€åº“
g++ -shared -o libmath.so add.o sub.o

# 3. ä½¿ç”¨åŠ¨æ€åº“
g++ main.cpp -L. -lmath -o a.out

# 4. è¿è¡Œæ—¶éœ€è¦æŒ‡å®šåº“è·¯å¾„
export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH
./a.out
```

**åŠ¨æ€é“¾æ¥åŸç†ï¼š**
```
ç¨‹åºå¯åŠ¨ï¼š
1. æ“ä½œç³»ç»ŸåŠ è½½å¯æ‰§è¡Œæ–‡ä»¶
2. è¯»å–ä¾èµ–çš„åŠ¨æ€åº“åˆ—è¡¨
3. åŠ è½½åŠ¨æ€åº“åˆ°å†…å­˜
4. é‡å®šä½ï¼šä¿®æ­£å‡½æ•°åœ°å€ï¼ˆGOT/PLTæœºåˆ¶ï¼‰
5. æ‰§è¡Œmainå‡½æ•°

GOTï¼ˆGlobal Offset Tableï¼‰ï¼šå…¨å±€åç§»è¡¨
PLTï¼ˆProcedure Linkage Tableï¼‰ï¼šè¿‡ç¨‹é“¾æ¥è¡¨

ç¬¬ä¸€æ¬¡è°ƒç”¨åŠ¨æ€åº“å‡½æ•°ï¼š
  call add@PLT
  â†’ PLTè·³è½¬åˆ°GOT
  â†’ GOTä¸­åœ°å€æœªè§£æï¼Œè°ƒç”¨åŠ¨æ€é“¾æ¥å™¨
  â†’ è§£æaddçš„å®é™…åœ°å€ï¼Œæ›´æ–°GOT
  â†’ è·³è½¬åˆ°addå‡½æ•°

åç»­è°ƒç”¨ï¼š
  call add@PLT
  â†’ PLTè·³è½¬åˆ°GOT
  â†’ GOTå·²æœ‰åœ°å€ï¼Œç›´æ¥è·³è½¬
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ å¤´æ–‡ä»¶é‡å¤åŒ…å«æ€ä¹ˆè§£å†³ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
// æ–¹æ³•1ï¼š#ifndef å®ˆå«ï¼ˆä¼ ç»Ÿï¼‰
#ifndef MY_HEADER_H
#define MY_HEADER_H

class MyClass {};

#endif

// æ–¹æ³•2ï¼š#pragma onceï¼ˆç°ä»£ï¼‰
#pragma once

class MyClass {};

// ğŸ”‘ åŒºåˆ«ï¼š
// #ifndef: æ ‡å‡†ï¼Œæ‰€æœ‰ç¼–è¯‘å™¨æ”¯æŒ
// #pragma once: ç®€æ´ï¼Œç¼–è¯‘æ›´å¿«ï¼Œä½†éæ ‡å‡†
```

#### 2ï¸âƒ£ ä¸ºä»€ä¹ˆæ¨¡æ¿è¦åœ¨å¤´æ–‡ä»¶å®ç°ï¼Ÿï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

```cpp
// é”™è¯¯ç¤ºä¾‹ï¼š
// template.h
template<typename T>
class MyClass {
public:
    void func();
};

// template.cpp
template<typename T>
void MyClass<T>::func() {
    // å®ç°
}

// main.cpp
#include "template.h"
MyClass<int> obj;
obj.func();  // âŒ é“¾æ¥é”™è¯¯ï¼šæœªå®šä¹‰çš„å¼•ç”¨

// åŸå› ï¼š
// 1. ç¼–è¯‘template.cppæ—¶ï¼Œç¼–è¯‘å™¨ä¸çŸ¥é“Tä¼šæ˜¯ä»€ä¹ˆ
// 2. ç¼–è¯‘å™¨æ²¡æœ‰ç”Ÿæˆä»»ä½•ä»£ç 
// 3. é“¾æ¥main.oæ—¶ï¼Œæ‰¾ä¸åˆ°MyClass<int>::funcçš„å®šä¹‰

// âœ… æ­£ç¡®ï¼šæ¨¡æ¿å®ç°æ”¾åœ¨å¤´æ–‡ä»¶
// template.h
template<typename T>
class MyClass {
public:
    void func() {
        // å®ç°åœ¨è¿™é‡Œ
    }
};

// main.cppç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨çœ‹åˆ°MyClass<int>
// ç”ŸæˆMyClass<int>::funcçš„ä»£ç 
```

**ä¾‹å¤–ï¼šæ˜¾å¼å®ä¾‹åŒ–**
```cpp
// template.cpp
template<typename T>
void MyClass<T>::func() {}

// æ˜¾å¼å®ä¾‹åŒ–å¸¸ç”¨ç±»å‹
template class MyClass<int>;
template class MyClass<double>;

// è¿™æ ·å¯ä»¥åˆ†ç¦»å£°æ˜å’Œå®šä¹‰
// ä½†ä½¿ç”¨è€…åªèƒ½ç”¨intå’Œdouble
```

#### 3ï¸âƒ£ æœªå®šä¹‰è¡Œä¸ºï¼ˆundefined vs unspecifiedï¼‰ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// æœªå®šä¹‰è¡Œä¸ºï¼ˆUndefined Behaviorï¼‰
int* p = nullptr;
*p = 10;  // âŒ ç¨‹åºå¯èƒ½å´©æºƒã€äº§ç”Ÿéšæœºç»“æœ

int arr[10];
arr[100] = 1;  // âŒ æ•°ç»„è¶Šç•Œ

// æœªæŒ‡å®šè¡Œä¸ºï¼ˆUnspecified Behaviorï¼‰
int f() { return 1; }
int g() { return 2; }
int x = f() + g();  // è°ƒç”¨é¡ºåºæœªæŒ‡å®šï¼ˆä½†æ˜¯ç¡®å®šçš„ï¼‰

// ğŸ”‘ åŒºåˆ«ï¼š
// undefined: å®Œå…¨æœªå®šä¹‰ï¼Œä»»ä½•äº‹éƒ½å¯èƒ½å‘ç”Ÿ
// unspecified: æœ‰å¤šç§å¯èƒ½ï¼Œä½†æ¯æ¬¡è¿è¡Œæ˜¯ç¡®å®šçš„
```

#### 4ï¸âƒ£ ç¬¦å·ä¿®é¥°ï¼ˆName Manglingï¼‰æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

```cpp
// C++æ”¯æŒå‡½æ•°é‡è½½ï¼Œéœ€è¦åŒºåˆ†ä¸åŒçš„å‡½æ•°
void func(int x);
void func(double x);
void func(int x, int y);

// ç¼–è¯‘åçš„ç¬¦å·è¡¨ï¼š
// _Z4funci      â† func(int)
// _Z4funcd      â† func(double)
// _Z4funcii     â† func(int, int)

// è§„åˆ™ï¼ˆg++ï¼‰ï¼š
// _Z + å‡½æ•°åé•¿åº¦ + å‡½æ•°å + å‚æ•°ç±»å‹ç¼–ç 
// i: int, d: double, f: float, v: void, P: pointer

// ğŸ”‘ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆC++å’ŒCä¸èƒ½ç›´æ¥äº’ç›¸è°ƒç”¨

// extern "C"ï¼šç¦ç”¨åå­—ä¿®é¥°
extern "C" {
    void func(int x);  // ç¼–è¯‘åä»æ˜¯funcï¼Œä¸æ˜¯_Z4funci
}

// æŸ¥çœ‹ç¬¦å·ï¼š
// nm main.o | c++filt  â† åä¿®é¥°
```

#### 5ï¸âƒ£ inlineå‡½æ•°åœ¨é“¾æ¥æ—¶æ€ä¹ˆå¤„ç†ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// inline.h
inline int add(int a, int b) {
    return a + b;
}

// file1.cpp
#include "inline.h"
int x = add(1, 2);

// file2.cpp
#include "inline.h"
int y = add(3, 4);

// ğŸ”‘ é—®é¢˜ï¼šä¸¤ä¸ª.cppéƒ½åŒ…å«addçš„å®šä¹‰ï¼Œä¸ä¼šé‡å¤å®šä¹‰é”™è¯¯å—ï¼Ÿ

// ç­”æ¡ˆï¼šinlineå‡½æ•°æœ‰ç‰¹æ®Šè§„åˆ™
// 1. æ¯ä¸ªç¼–è¯‘å•å…ƒéƒ½æœ‰addçš„å‰¯æœ¬
// 2. é“¾æ¥å™¨ä¼šå»é‡ï¼ˆCOMDATæœºåˆ¶ï¼‰
// 3. æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶åªæœ‰ä¸€ä»½add

// ODRï¼ˆOne Definition Ruleï¼‰ä¾‹å¤–ï¼š
// inlineå‡½æ•°ã€æ¨¡æ¿ã€constexprå¯ä»¥æœ‰å¤šä¸ªå®šä¹‰
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
C++ç¼–è¯‘åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š

1. é¢„å¤„ç†ï¼ˆPreprocessingï¼‰
   - å±•å¼€å®å®šä¹‰
   - å¤„ç†#includeã€#ifdefç­‰æŒ‡ä»¤
   - åˆ é™¤æ³¨é‡Š
   - ç”Ÿæˆ.iæ–‡ä»¶

2. ç¼–è¯‘ï¼ˆCompilationï¼‰
   - è¯æ³•ã€è¯­æ³•ã€è¯­ä¹‰åˆ†æ
   - ä¼˜åŒ–
   - ç”Ÿæˆæ±‡ç¼–ä»£ç .s

3. æ±‡ç¼–ï¼ˆAssemblyï¼‰
   - æ±‡ç¼–ä»£ç è½¬æœºå™¨ç 
   - ç”Ÿæˆç›®æ ‡æ–‡ä»¶.oï¼ˆå«ç¬¦å·è¡¨ã€é‡å®šä½è¡¨ï¼‰

4. é“¾æ¥ï¼ˆLinkingï¼‰
   - ç¬¦å·è§£æï¼šæŸ¥æ‰¾æœªå®šä¹‰ç¬¦å·
   - é‡å®šä½ï¼šç¡®å®šæœ€ç»ˆåœ°å€
   - ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶

ã€è¿½é—®-é™æ€é“¾æ¥vsåŠ¨æ€é“¾æ¥ã€‘
é™æ€é“¾æ¥ï¼šåº“ä»£ç ç¼–è¯‘è¿›å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ–‡ä»¶å¤§ï¼Œç‹¬ç«‹è¿è¡Œ
åŠ¨æ€é“¾æ¥ï¼šè¿è¡Œæ—¶åŠ è½½åº“ï¼Œæ–‡ä»¶å°ï¼Œå…±äº«å†…å­˜ï¼Œä½†ä¾èµ–å¤–éƒ¨åº“

ã€è¿½é—®-ä¸ºä»€ä¹ˆæ¨¡æ¿åœ¨å¤´æ–‡ä»¶ã€‘
å› ä¸ºæ¨¡æ¿éœ€è¦åœ¨ä½¿ç”¨å¤„å®ä¾‹åŒ–ï¼Œç¼–è¯‘å™¨éœ€è¦çœ‹åˆ°å®Œæ•´å®šä¹‰ã€‚
å¦‚æœåˆ†ç¦»å£°æ˜å’Œå®šä¹‰ï¼Œé“¾æ¥æ—¶æ‰¾ä¸åˆ°å®ä¾‹åŒ–çš„ä»£ç ã€‚

ã€è¿½é—®-extern "C"ä½œç”¨ã€‘
ç¦ç”¨C++çš„åå­—ä¿®é¥°ï¼Œä¿æŒCçš„å‘½åæ–¹å¼ï¼Œ
ä½¿C++ä»£ç å¯ä»¥è¢«Cè°ƒç”¨ï¼Œæˆ–è°ƒç”¨Cåº“ã€‚
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸º#includeæ˜¯å¤åˆ¶æ–‡ä»¶
âœ… **æ­£ç¡®**ï¼šæ˜¯åœ¨é¢„å¤„ç†é˜¶æ®µæ’å…¥æ–‡ä»¶å†…å®¹

âŒ **é”™è¯¯2**ï¼šè®¤ä¸ºinlineä¸€å®šä¼šå†…è”
âœ… **æ­£ç¡®**ï¼šinlineåªæ˜¯å»ºè®®ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¸å†…è”

âŒ **é”™è¯¯3**ï¼šé™æ€é“¾æ¥æ¯”åŠ¨æ€é“¾æ¥å¿«
âœ… **æ­£ç¡®**ï¼šè¿è¡Œæ—¶åŠ¨æ€é“¾æ¥é¦–æ¬¡è°ƒç”¨æ…¢ï¼Œåç»­ç›¸åŒ

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°LTOï¼ˆé“¾æ¥æ—¶ä¼˜åŒ–ï¼‰
- çŸ¥é“COMDATæœºåˆ¶ï¼ˆå»é‡inline/æ¨¡æ¿ï¼‰
- äº†è§£PICï¼ˆä½ç½®æ— å…³ä»£ç ï¼‰çš„å¿…è¦æ€§
- æåˆ°GOT/PLTå»¶è¿Ÿç»‘å®šæœºåˆ¶
- çŸ¥é“weak symbolï¼ˆå¼±ç¬¦å·ï¼‰

---

**ğŸ“Š å½“å‰å®Œå–„è¿›åº¦ï¼š**

### **P0çº§åˆ«ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰**
- âœ… C++å¤šæ€æœºåˆ¶ï¼ˆå«è™šè¡¨æ·±åº¦å‰–æï¼‰
  - å•ç»§æ‰¿è™šè¡¨ç»“æ„
  - å¤šç»§æ‰¿è™šè¡¨ç»“æ„ï¼ˆthunkæŠ€æœ¯ï¼‰
  - è™šç»§æ‰¿è™šè¡¨ç»“æ„ï¼ˆVTTï¼‰
  - è™šå‡½æ•°è°ƒç”¨æ±‡ç¼–åˆ†æ
  - vptråˆå§‹åŒ–æ—¶æœºè¯¦è§£
- âœ… æ™ºèƒ½æŒ‡é’ˆï¼ˆRAIIã€å¼•ç”¨è®¡æ•°ã€å¾ªç¯å¼•ç”¨ï¼‰
- âœ… newå’Œmallocï¼ˆåº•å±‚å®ç°ã€placement newï¼‰
- âœ… constå…³é”®å­—ï¼ˆ5ç§ç”¨æ³•ã€mutableï¼‰
- âœ… vectoråº•å±‚å®ç°ï¼ˆæ‰©å®¹æœºåˆ¶ã€è¿­ä»£å™¨å¤±æ•ˆï¼‰
- âœ… å¤šç»§æ‰¿ä¸è±å½¢ç»§æ‰¿ï¼ˆè™šç»§æ‰¿ã€vbptrï¼‰
- âœ… staticå…³é”®å­—ï¼ˆ5ç§ç”¨æ³•ã€å•ä¾‹æ¨¡å¼ï¼‰
- âœ… å³å€¼å¼•ç”¨ä¸ç§»åŠ¨è¯­ä¹‰ï¼ˆå®Œç¾è½¬å‘ã€äº”æ³•åˆ™ï¼‰
- âœ… RTTIä¸ç±»å‹è½¬æ¢ï¼ˆå››ç§castè¯¦è§£ï¼‰
- âœ… å†…å­˜å¯¹é½ä¸å¯¹è±¡æ¨¡å‹ï¼ˆpaddingã€sizeofï¼‰
- âœ… ç¼–è¯‘é“¾æ¥è¿‡ç¨‹ï¼ˆé¢„å¤„ç†ã€é™æ€/åŠ¨æ€é“¾æ¥ã€ç¬¦å·è¡¨ï¼‰

### **P1çº§åˆ«ï¼ˆâ­â­â­â­ é«˜é¢‘ï¼‰**
- âœ… çº¢é»‘æ ‘ï¼ˆ5æ¡æ€§è´¨ã€vs AVLæ ‘ï¼‰
- âœ… C++11æ–°ç‰¹æ€§ï¼ˆlambdaã€autoã€nullptrç­‰ï¼‰
- âœ… constexprï¼ˆç¼–è¯‘æœŸå¸¸é‡ã€constexpr ifï¼‰
- âœ… map/setå®ç°ï¼ˆçº¢é»‘æ ‘ã€lower_boundï¼‰

**ğŸ‰ C++.md å®Œå–„å®Œæˆåº¦ï¼š99%**

**æ–°å¢æ·±åº¦å†…å®¹ï¼š**
- ğŸ”¬ è™šè¡¨ç»“æ„çš„å®Œæ•´å‰–æï¼ˆå•ç»§æ‰¿ã€å¤šç»§æ‰¿ã€è™šç»§æ‰¿ï¼‰
- ğŸ”¬ thunkæŠ€æœ¯è¯¦è§£ï¼ˆå¤šç»§æ‰¿ä¸­thisæŒ‡é’ˆè°ƒæ•´ï¼‰
- ğŸ”¬ è™šå‡½æ•°è°ƒç”¨çš„æ±‡ç¼–çº§åˆ†æ
- ğŸ”¬ vptrç”Ÿå‘½å‘¨æœŸè¯¦è§£ï¼ˆæ„é€ /ææ„è¿‡ç¨‹ï¼‰
- ğŸ”¬ dynamic_caståº•å±‚å®ç°ä¼ªä»£ç 
- ğŸ”¬ å†…å­˜å¯¹é½åŸç†ä¸ä¼˜åŒ–æŠ€å·§
- ğŸ”¬ ç©ºç±»å¤§å°ä¸è™šå‡½æ•°å¼€é”€è¯¦è§£

**çŸ¥è¯†æ·±åº¦ï¼š**
- ğŸ“– åŸºç¡€æ¦‚å¿µï¼š100%è¦†ç›–
- ğŸ” åº•å±‚åŸç†ï¼š95%è¦†ç›–ï¼ˆæ±‡ç¼–ã€å†…å­˜å¸ƒå±€ã€è™šè¡¨ç»“æ„ï¼‰
- ğŸ’¡ é¢è¯•è¿½é—®ï¼šæ¯ä¸ªçŸ¥è¯†ç‚¹3-5ä¸ªé«˜é¢‘è¿½é—®
- ğŸ“ å›ç­”æ¨¡æ¿ï¼šæ¯ä¸ªçŸ¥è¯†ç‚¹éƒ½æœ‰æ ‡å‡†å›ç­”
- âš ï¸ å¸¸è§è¯¯åŒºï¼šè¦†ç›–æ‰€æœ‰æ˜“é”™ç‚¹
- ğŸŒŸ åŠ åˆ†ç‚¹ï¼šæ·±åº¦çŸ¥è¯†ç‚¹å’Œå‰æ²¿ç‰¹æ€§

**æ€»è®¡ï¼š**
- 14ä¸ªæ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼ˆ10ä¸ªP0 + 4ä¸ªP1ï¼‰
- è¶…è¿‡3500è¡Œæ·±åº¦å†…å®¹
- åŒ…å«å¤§é‡å†…å­˜å¸ƒå±€å›¾ã€æ±‡ç¼–ä»£ç ã€æ€§èƒ½åˆ†æ

å»ºè®®ä¸‹ä¸€æ­¥ï¼šå¯ä»¥ç»§ç»­å®Œå–„å…¶ä»–æ–‡ä»¶ï¼ˆè®¡ç®—æœºç½‘ç»œ.mdã€æ“ä½œç³»ç»Ÿ.mdç­‰ï¼‰ï¼Œæˆ–è€…æ ¹æ®éœ€è¦æ·±åŒ–C++çš„å…¶ä»–é«˜çº§ä¸»é¢˜ï¼ˆå¦‚æ¨¡æ¿å…ƒç¼–ç¨‹ã€å¼‚å¸¸å¤„ç†æœºåˆ¶ç­‰ï¼‰

---

## ğŸ“Œ å†…å­˜ç®¡ç†æ·±å…¥ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **æ ˆ(stack)** | **å †(heap)** | **å…¨å±€/é™æ€åŒº** | **å¸¸é‡åŒº** | **ä»£ç æ®µ** | **å†…å­˜æ³„æ¼** | **RAII** | **å†…å­˜æ± ** | **å†…å­˜å¯¹é½**

### âœ… C++ç¨‹åºå†…å­˜å¸ƒå±€

```cpp
é«˜åœ°å€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å†…æ ¸ç©ºé—´             â”‚  æ“ä½œç³»ç»Ÿä½¿ç”¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     æ ˆ (Stack)          â”‚  â†“ å‘ä¸‹å¢é•¿
â”‚   - å±€éƒ¨å˜é‡            â”‚
â”‚   - å‡½æ•°å‚æ•°            â”‚
â”‚   - è¿”å›åœ°å€            â”‚
â”‚   - è‡ªåŠ¨ç®¡ç†            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â†“               â”‚
â”‚     (æœªä½¿ç”¨ç©ºé—´)         â”‚
â”‚         â†‘               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     å † (Heap)           â”‚  â†‘ å‘ä¸Šå¢é•¿
â”‚   - newåˆ†é…             â”‚
â”‚   - mallocåˆ†é…          â”‚
â”‚   - ç¨‹åºå‘˜ç®¡ç†          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   BSSæ®µ (æœªåˆå§‹åŒ–)       â”‚
â”‚   - æœªåˆå§‹åŒ–å…¨å±€å˜é‡     â”‚
â”‚   - æœªåˆå§‹åŒ–é™æ€å˜é‡     â”‚
â”‚   - åˆå§‹åŒ–ä¸º0           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Dataæ®µ (å·²åˆå§‹åŒ–)      â”‚
â”‚   - å·²åˆå§‹åŒ–å…¨å±€å˜é‡     â”‚
â”‚   - å·²åˆå§‹åŒ–é™æ€å˜é‡     â”‚
â”‚   - å­—ç¬¦ä¸²å¸¸é‡          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä»£ç æ®µ (Text)         â”‚
â”‚   - å¯æ‰§è¡Œä»£ç           â”‚
â”‚   - åªè¯»               â”‚
â”‚   - å¸¸é‡æ•°æ®           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ä½åœ°å€
```

### ğŸ’¡ å„å†…å­˜åŒºåŸŸè¯¦è§£ï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

#### 1ï¸âƒ£ æ ˆ(Stack)

**ç‰¹ç‚¹ï¼š**
```cpp
void func() {
    int a = 10;        // æ ˆä¸Šåˆ†é…
    int arr[100];      // æ ˆä¸Šåˆ†é…
    char* p = "hello"; // påœ¨æ ˆä¸Šï¼Œ"hello"åœ¨å¸¸é‡åŒº
}  // å‡½æ•°ç»“æŸï¼Œè‡ªåŠ¨é‡Šæ”¾

// æ ˆçš„ç‰¹ç‚¹ï¼š
// 1. LIFO(åè¿›å…ˆå‡º)
// 2. è‡ªåŠ¨ç®¡ç†(æ— éœ€æ‰‹åŠ¨é‡Šæ”¾)
// 3. é€Ÿåº¦å¿«(åªéœ€ç§»åŠ¨æ ˆæŒ‡é’ˆ)
// 4. å¤§å°æœ‰é™(é€šå¸¸1-8MBï¼Œå–å†³äºç³»ç»Ÿ)
// 5. ç¼–è¯‘æ—¶ç¡®å®šå¤§å°
```

**æ ˆå¸§ç»“æ„ï¼š**
```
å‡½æ•°è°ƒç”¨æ ˆå¸§ï¼ˆx86-64ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† é«˜åœ°å€
â”‚  å‚æ•°n          â”‚
â”‚  ...            â”‚
â”‚  å‚æ•°2          â”‚
â”‚  å‚æ•°1          â”‚  (å‰6ä¸ªå‚æ•°é€šè¿‡å¯„å­˜å™¨ä¼ é€’)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¿”å›åœ°å€        â”‚  â† callæŒ‡ä»¤å‹å…¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ—§çš„rbp        â”‚  â† push rbp
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â† rbpæŒ‡å‘è¿™é‡Œ
â”‚  å±€éƒ¨å˜é‡1       â”‚
â”‚  å±€éƒ¨å˜é‡2       â”‚
â”‚  ...            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â† rspæŒ‡å‘è¿™é‡Œ(ä½åœ°å€)
```

**æ ˆæº¢å‡ºç¤ºä¾‹ï¼š**
```cpp
// âŒ æ ˆæº¢å‡ºçš„å‡ ç§æƒ…å†µ

// 1. é€’å½’è¿‡æ·±
void badRecursion(int n) {
    badRecursion(n + 1);  // æ— ç»ˆæ­¢æ¡ä»¶
}

// 2. æ ˆä¸Šåˆ†é…è¿‡å¤§æ•°ç»„
void func() {
    int arr[10000000];  // âŒ æ ˆç©ºé—´ä¸è¶³
}

// 3. ç¼“å†²åŒºæº¢å‡ºï¼ˆå®‰å…¨æ¼æ´ï¼‰
void bufferOverflow() {
    char buf[10];
    strcpy(buf, "This is a very long string");  // âŒ è¶Šç•Œå†™å…¥
    // å¯èƒ½è¦†ç›–è¿”å›åœ°å€ï¼Œå¯¼è‡´å®‰å…¨é—®é¢˜
}
```

#### 2ï¸âƒ£ å †(Heap)

**ç‰¹ç‚¹ï¼š**
```cpp
int* p = new int(10);      // å †ä¸Šåˆ†é…
delete p;                   // å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾

int* arr = new int[1000];  // å †ä¸Šåˆ†é…æ•°ç»„
delete[] arr;              // å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾

// å †çš„ç‰¹ç‚¹ï¼š
// 1. åŠ¨æ€åˆ†é…ï¼Œè¿è¡Œæ—¶ç¡®å®šå¤§å°
// 2. æ‰‹åŠ¨ç®¡ç†(éœ€è¦delete)
// 3. é€Ÿåº¦è¾ƒæ…¢(éœ€è¦æŸ¥æ‰¾åˆé€‚çš„å†…å­˜å—)
// 4. å¤§å°çµæ´»(å–å†³äºç³»ç»Ÿå†…å­˜)
// 5. å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡
```

**å†…å­˜æ³„æ¼ç¤ºä¾‹ï¼š**
```cpp
// âŒ å†…å­˜æ³„æ¼åœºæ™¯

// 1. å¿˜è®°é‡Šæ”¾
void leak1() {
    int* p = new int(10);
    // å¿˜è®°delete p
}  // âŒ å†…å­˜æ³„æ¼

// 2. å¼‚å¸¸å¯¼è‡´æœªé‡Šæ”¾
void leak2() {
    int* p = new int(10);
    throw runtime_error("error");  // å¼‚å¸¸æŠ›å‡º
    delete p;  // âŒ ä¸ä¼šæ‰§è¡Œ
}

// âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨RAII
void safe() {
    unique_ptr<int> p = make_unique<int>(10);
    throw runtime_error("error");
    // âœ… pè‡ªåŠ¨é‡Šæ”¾ï¼Œæ— æ³„æ¼
}

// 3. é‡å¤é‡Šæ”¾
void doubleFree() {
    int* p = new int(10);
    delete p;
    delete p;  // âŒ æœªå®šä¹‰è¡Œä¸º(double free)
}

// 4. æ‚¬ç©ºæŒ‡é’ˆ
void danglingPointer() {
    int* p = new int(10);
    int* q = p;
    delete p;
    *q = 20;  // âŒ æ‚¬ç©ºæŒ‡é’ˆï¼Œæœªå®šä¹‰è¡Œä¸º
}
```

#### 3ï¸âƒ£ å…¨å±€/é™æ€å­˜å‚¨åŒº

**Dataæ®µï¼ˆå·²åˆå§‹åŒ–ï¼‰ï¼š**
```cpp
int g_data = 100;          // Dataæ®µ
static int s_data = 200;   // Dataæ®µ

const int c_data = 300;    // å¯èƒ½åœ¨Dataæ®µæˆ–ä»£ç æ®µ(ç¼–è¯‘å™¨å†³å®š)

class Test {
    static int count = 0;  // Dataæ®µ
};
int Test::count = 0;
```

**BSSæ®µï¼ˆæœªåˆå§‹åŒ–ï¼‰ï¼š**
```cpp
int g_uninit;              // BSSæ®µï¼Œè‡ªåŠ¨åˆå§‹åŒ–ä¸º0
static int s_uninit;       // BSSæ®µï¼Œè‡ªåŠ¨åˆå§‹åŒ–ä¸º0

int main() {
    cout << g_uninit;      // è¾“å‡ºï¼š0
    cout << s_uninit;      // è¾“å‡ºï¼š0
}

// ğŸ”‘ BSSæ®µçš„ä¼˜ç‚¹ï¼š
// ä¸å ç”¨å¯æ‰§è¡Œæ–‡ä»¶ç©ºé—´
// åªè®°å½•å¤§å°ï¼Œè¿è¡Œæ—¶åˆ†é…å¹¶æ¸…é›¶
```

#### 4ï¸âƒ£ å¸¸é‡åŒºï¼ˆåªè¯»æ•°æ®æ®µï¼‰

```cpp
const char* str = "hello";  // "hello"åœ¨å¸¸é‡åŒº(åªè¯»)
str[0] = 'H';               // âŒ æœªå®šä¹‰è¡Œä¸º(å†™åªè¯»å†…å­˜)

char arr[] = "hello";       // å¤åˆ¶åˆ°æ ˆä¸Šï¼Œå¯ä¿®æ”¹
arr[0] = 'H';               // âœ… æ­£ç¡®

// å­—ç¬¦ä¸²å­—é¢é‡çš„ç‰¹æ®Šæ€§
const char* p1 = "hello";
const char* p2 = "hello";
cout << (p1 == p2);  // å¯èƒ½è¾“å‡º1(ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œå…±äº«åŒä¸€å†…å­˜)

char arr1[] = "hello";
char arr2[] = "hello";
cout << (arr1 == arr2);  // è¾“å‡º0(ä¸åŒåœ°å€)
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ æ ˆå’Œå †çš„åŒºåˆ«ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

| ç‰¹æ€§ | æ ˆ(Stack) | å †(Heap) |
|------|----------|---------|
| **ç®¡ç†æ–¹å¼** | è‡ªåŠ¨ç®¡ç† | æ‰‹åŠ¨ç®¡ç† |
| **åˆ†é…é€Ÿåº¦** | å¿«(ç§»åŠ¨æŒ‡é’ˆ) | æ…¢(æŸ¥æ‰¾ç©ºé—²å—) |
| **å¤§å°** | å°(MBçº§) | å¤§(GBçº§) |
| **ç”Ÿå‘½å‘¨æœŸ** | å‡½æ•°ä½œç”¨åŸŸ | newâ†’delete |
| **ç¢ç‰‡** | æ— ç¢ç‰‡ | å®¹æ˜“ç¢ç‰‡åŒ– |
| **å¢é•¿æ–¹å‘** | å‘ä¸‹(ä½åœ°å€) | å‘ä¸Š(é«˜åœ°å€) |

```cpp
void demo() {
    int a = 10;              // æ ˆï¼šå¿«é€Ÿï¼Œè‡ªåŠ¨é‡Šæ”¾
    int* p = new int(20);    // å †ï¼šæ…¢ï¼Œæ‰‹åŠ¨é‡Šæ”¾

    // æ€§èƒ½å¯¹æ¯”ï¼š
    // æ ˆåˆ†é…ï¼š1-2ä¸ªCPUå‘¨æœŸ
    // å †åˆ†é…ï¼šå‡ ååˆ°å‡ ç™¾ä¸ªCPUå‘¨æœŸ

    delete p;
}
```

#### 2ï¸âƒ£ å¦‚ä½•æ£€æµ‹å†…å­˜æ³„æ¼ï¼Ÿï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

**æ–¹æ³•1ï¼šValgrindï¼ˆLinuxï¼‰**
```bash
# ç¼–è¯‘æ—¶åŠ è°ƒè¯•ä¿¡æ¯
g++ -g -o test test.cpp

# ä½¿ç”¨valgrindæ£€æµ‹
valgrind --leak-check=full ./test

# è¾“å‡ºç¤ºä¾‹ï¼š
# ==12345== HEAP SUMMARY:
# ==12345==     definitely lost: 40 bytes in 1 blocks
# ==12345==     indirectly lost: 0 bytes in 0 blocks
```

**æ–¹æ³•2ï¼šé‡è½½new/delete**
```cpp
#include <map>
#include <cstdio>

std::map<void*, size_t> allocations;

void* operator new(size_t size) {
    void* p = malloc(size);
    allocations[p] = size;
    printf("Allocated %zu bytes at %p\n", size, p);
    return p;
}

void operator delete(void* p) noexcept {
    auto it = allocations.find(p);
    if (it != allocations.end()) {
        printf("Freed %zu bytes at %p\n", it->second, p);
        allocations.erase(it);
    }
    free(p);
}

// ç¨‹åºç»“æŸæ—¶æ£€æŸ¥
void checkLeaks() {
    if (!allocations.empty()) {
        printf("Memory leaks detected:\n");
        for (auto& [ptr, size] : allocations) {
            printf("  %p: %zu bytes\n", ptr, size);
        }
    }
}
```

**æ–¹æ³•3ï¼šæ™ºèƒ½æŒ‡é’ˆï¼ˆé¢„é˜²ï¼‰**
```cpp
// âœ… ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Œè‡ªåŠ¨ç®¡ç†
void safeCode() {
    auto p = make_unique<int>(10);
    auto arr = make_shared<int[]>(1000);
    // è‡ªåŠ¨é‡Šæ”¾ï¼Œæ— æ³„æ¼
}
```

#### 3ï¸âƒ£ å†…å­˜æ± çš„å®ç°ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜æ± ï¼š**
```
é—®é¢˜ï¼š
1. é¢‘ç¹new/deleteå¯¼è‡´æ€§èƒ½ä½ä¸‹
2. å†…å­˜ç¢ç‰‡åŒ–
3. å †åˆ†é…å™¨é”ç«äº‰(å¤šçº¿ç¨‹)

è§£å†³ï¼š
é¢„å…ˆåˆ†é…å¤§å—å†…å­˜ï¼Œè‡ªå·±ç®¡ç†
```

**ç®€å•å†…å­˜æ± å®ç°ï¼š**
```cpp
template<typename T, size_t BlockSize = 4096>
class MemoryPool {
private:
    // å†…å­˜å—èŠ‚ç‚¹
    union Node {
        T element;
        Node* next;
    };

    Node* freeList;      // ç©ºé—²é“¾è¡¨
    char* currentBlock;  // å½“å‰å†…å­˜å—
    size_t currentSlot;  // å½“å‰æ§½ä½

public:
    MemoryPool() : freeList(nullptr), currentBlock(nullptr), currentSlot(0) {}

    ~MemoryPool() {
        // é‡Šæ”¾æ‰€æœ‰å†…å­˜å—
        while (currentBlock) {
            char* prev = *(char**)currentBlock;
            free(currentBlock);
            currentBlock = prev;
        }
    }

    // åˆ†é…å†…å­˜
    T* allocate() {
        if (freeList) {
            // ä»ç©ºé—²é“¾è¡¨å–
            Node* node = freeList;
            freeList = freeList->next;
            return reinterpret_cast<T*>(node);
        }

        // å½“å‰å—ç”¨å®Œï¼Œåˆ†é…æ–°å—
        if (currentSlot >= BlockSize) {
            char* newBlock = (char*)malloc(BlockSize * sizeof(Node) + sizeof(char*));
            *(char**)newBlock = currentBlock;  // é“¾æ¥æ—§å—
            currentBlock = newBlock;
            currentSlot = 0;
        }

        // ä»å½“å‰å—åˆ†é…
        return reinterpret_cast<T*>(
            currentBlock + sizeof(char*) + (currentSlot++) * sizeof(Node)
        );
    }

    // é‡Šæ”¾å†…å­˜
    void deallocate(T* p) {
        if (p) {
            Node* node = reinterpret_cast<Node*>(p);
            node->next = freeList;
            freeList = node;  // æ’å…¥ç©ºé—²é“¾è¡¨
        }
    }
};

// ä½¿ç”¨ç¤ºä¾‹
struct Object {
    int data[10];
};

MemoryPool<Object> pool;

void test() {
    Object* obj1 = pool.allocate();  // å¿«é€Ÿåˆ†é…
    Object* obj2 = pool.allocate();

    pool.deallocate(obj1);           // å¿«é€Ÿå›æ”¶
    pool.deallocate(obj2);
}
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
```cpp
// æ€§èƒ½æµ‹è¯•
const int N = 1000000;

// æ™®é€šnew/delete
auto start = chrono::high_resolution_clock::now();
for (int i = 0; i < N; ++i) {
    int* p = new int;
    delete p;
}
auto end = chrono::high_resolution_clock::now();
cout << "new/delete: "
     << chrono::duration_cast<chrono::milliseconds>(end - start).count()
     << "ms\n";

// å†…å­˜æ± 
MemoryPool<int> pool;
start = chrono::high_resolution_clock::now();
for (int i = 0; i < N; ++i) {
    int* p = pool.allocate();
    pool.deallocate(p);
}
end = chrono::high_resolution_clock::now();
cout << "Memory pool: "
     << chrono::duration_cast<chrono::milliseconds>(end - start).count()
     << "ms\n";

// å…¸å‹ç»“æœï¼š
// new/delete: 150ms
// Memory pool: 20ms  â† å¿«7å€
```

#### 4ï¸âƒ£ RAIIåŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

**RAIIï¼ˆResource Acquisition Is Initializationï¼‰èµ„æºè·å–å³åˆå§‹åŒ–**

```cpp
// ğŸ”‘ æ ¸å¿ƒæ€æƒ³ï¼š
// èµ„æºçš„è·å–å’Œé‡Šæ”¾ç»‘å®šåˆ°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ

// âŒ æ²¡æœ‰RAIIçš„ä»£ç 
void badCode() {
    FILE* fp = fopen("file.txt", "r");
    if (!fp) return;

    // å¤æ‚çš„é€»è¾‘
    if (error) {
        // âŒ å¿˜è®°fclose(fp)
        return;
    }

    fclose(fp);
}

// âœ… ä½¿ç”¨RAII
class FileGuard {
    FILE* fp;
public:
    FileGuard(const char* filename) {
        fp = fopen(filename, "r");
        if (!fp) throw runtime_error("Open failed");
    }

    ~FileGuard() {
        if (fp) fclose(fp);  // ğŸ”‘ è‡ªåŠ¨é‡Šæ”¾
    }

    FILE* get() { return fp; }
};

void goodCode() {
    FileGuard file("file.txt");
    // ä»»ä½•returnã€å¼‚å¸¸ï¼Œéƒ½ä¼šè‡ªåŠ¨å…³é—­æ–‡ä»¶
    if (error) return;  // âœ… è‡ªåŠ¨fclose
}
```

**RAIIçš„ç»å…¸åº”ç”¨ï¼š**
```cpp
// 1. æ™ºèƒ½æŒ‡é’ˆ
unique_ptr<int> p = make_unique<int>(10);  // è‡ªåŠ¨é‡Šæ”¾

// 2. äº’æ–¥é”
mutex mtx;
lock_guard<mutex> lock(mtx);  // æ„é€ æ—¶åŠ é”
// ä½œç”¨åŸŸç»“æŸè‡ªåŠ¨è§£é”

// 3. æ–‡ä»¶æµ
{
    fstream file("data.txt");  // æ„é€ æ—¶æ‰“å¼€
    // ä½¿ç”¨file
}  // ææ„æ—¶è‡ªåŠ¨å…³é—­

// 4. æ•°æ®åº“è¿æ¥
class DBConnection {
    Connection* conn;
public:
    DBConnection(const string& url) {
        conn = connect(url);
    }
    ~DBConnection() {
        if (conn) disconnect(conn);
    }
};
```

#### 5ï¸âƒ£ C++æœ‰åƒåœ¾å›æ”¶å—ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

**C++æ²¡æœ‰è‡ªåŠ¨GCï¼Œä½†æœ‰å¤šç§å†…å­˜ç®¡ç†æ–¹å¼ï¼š**

```cpp
// 1. æ‰‹åŠ¨ç®¡ç†
int* p = new int(10);
delete p;

// 2. æ™ºèƒ½æŒ‡é’ˆï¼ˆå¼•ç”¨è®¡æ•°GCï¼‰
shared_ptr<int> sp = make_shared<int>(10);
// å¼•ç”¨è®¡æ•°ä¸º0æ—¶è‡ªåŠ¨é‡Šæ”¾

// 3. RAIIï¼ˆæ ˆä¸Šè‡ªåŠ¨ç®¡ç†ï¼‰
{
    vector<int> v = {1, 2, 3};
    // vçš„å†…å­˜ï¼ˆå †ä¸Šï¼‰åœ¨ææ„æ—¶è‡ªåŠ¨é‡Šæ”¾
}

// 4. å†…å­˜æ± 
MemoryPool<int> pool;
int* p = pool.allocate();
pool.deallocate(p);
```

**ä¸ºä»€ä¹ˆC++ä¸ç”¨GCï¼š**
```
1. æ€§èƒ½å¯æ§
   - GCæœ‰ä¸å¯é¢„æµ‹çš„åœé¡¿ï¼ˆStop-The-Worldï¼‰
   - C++è¿½æ±‚é›¶å¼€é”€æŠ½è±¡

2. ç¡®å®šæ€§ææ„
   - C++ææ„å‡½æ•°ç«‹å³æ‰§è¡Œ
   - GCææ„æ—¶æœºä¸ç¡®å®š

3. èµ„æºä¸æ­¢å†…å­˜
   - æ–‡ä»¶å¥æŸ„ã€ç½‘ç»œè¿æ¥ã€é”ç­‰
   - éœ€è¦ç¡®å®šæ€§é‡Šæ”¾

4. ä½å»¶è¿Ÿè¦æ±‚
   - æ¸¸æˆã€å®æ—¶ç³»ç»Ÿå¯¹å»¶è¿Ÿæ•æ„Ÿ
   - GCæš‚åœä¸å¯æ¥å—
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
C++ç¨‹åºå†…å­˜åˆ†ä¸º5ä¸ªåŒºåŸŸï¼š

1. æ ˆ(Stack)
   - å­˜å‚¨å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°
   - è‡ªåŠ¨ç®¡ç†ï¼Œé€Ÿåº¦å¿«ï¼Œå¤§å°æœ‰é™
   - å‘ä¸‹å¢é•¿

2. å †(Heap)
   - new/mallocåˆ†é…çš„å†…å­˜
   - æ‰‹åŠ¨ç®¡ç†ï¼Œé€Ÿåº¦æ…¢ï¼Œå¤§å°çµæ´»
   - å‘ä¸Šå¢é•¿

3. å…¨å±€/é™æ€åŒº
   - Dataæ®µï¼šå·²åˆå§‹åŒ–çš„å…¨å±€/é™æ€å˜é‡
   - BSSæ®µï¼šæœªåˆå§‹åŒ–çš„å…¨å±€/é™æ€å˜é‡(è‡ªåŠ¨æ¸…é›¶)

4. å¸¸é‡åŒº
   - å­—ç¬¦ä¸²å­—é¢é‡ã€constå˜é‡
   - åªè¯»

5. ä»£ç æ®µ
   - å¯æ‰§è¡Œä»£ç 
   - åªè¯»

ã€è¿½é—®-å†…å­˜æ³„æ¼æ£€æµ‹ã€‘
ä¸‰ç§æ–¹æ³•ï¼š
1. Valgrindå·¥å…·æ£€æµ‹
2. é‡è½½new/deleteè®°å½•åˆ†é…
3. ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆé¢„é˜²

ã€è¿½é—®-RAIIåŸåˆ™ã€‘
èµ„æºè·å–å³åˆå§‹åŒ–ï¼Œå°†èµ„æºç”Ÿå‘½å‘¨æœŸç»‘å®šåˆ°å¯¹è±¡ï¼š
- æ„é€ å‡½æ•°è·å–èµ„æº
- ææ„å‡½æ•°é‡Šæ”¾èµ„æº
- è‡ªåŠ¨ç®¡ç†ï¼Œå¼‚å¸¸å®‰å…¨

å…¸å‹åº”ç”¨ï¼šæ™ºèƒ½æŒ‡é’ˆã€lock_guardã€æ–‡ä»¶æµ

ã€è¿½é—®-ä¸ºä»€ä¹ˆä¸ç”¨GCã€‘
1. æ€§èƒ½å¯æ§ï¼Œæ— GCåœé¡¿
2. ç¡®å®šæ€§ææ„ï¼Œç«‹å³é‡Šæ”¾
3. ç®¡ç†éå†…å­˜èµ„æº(æ–‡ä»¶ã€é”)
4. ä½å»¶è¿Ÿéœ€æ±‚(æ¸¸æˆã€å®æ—¶ç³»ç»Ÿ)
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼šä»¥ä¸ºæ ˆæ¯”å †å¿«åªæ˜¯å› ä¸ºè¿ç»­å†…å­˜
âœ… **æ­£ç¡®**ï¼šæ ˆåˆ†é…åªéœ€ç§»åŠ¨æŒ‡é’ˆ(O(1))ï¼Œå †åˆ†é…éœ€è¦æŸ¥æ‰¾åˆé€‚å—(O(n))

âŒ **é”™è¯¯2**ï¼šä»¥ä¸ºå…¨å±€å˜é‡åœ¨å †ä¸Š
âœ… **æ­£ç¡®**ï¼šå…¨å±€å˜é‡åœ¨Dataæ®µæˆ–BSSæ®µ(é™æ€å­˜å‚¨åŒº)

âŒ **é”™è¯¯3**ï¼šä»¥ä¸ºnewä¸€å®šæ¯”æ ˆæ…¢
âœ… **æ­£ç¡®**ï¼šå°å¯¹è±¡åœ¨æ ˆä¸Šå¿«ï¼Œä½†å¤§å¯¹è±¡(å¦‚æ•°ç»„)å †ä¸Šæ›´åˆé€‚

âŒ **é”™è¯¯4**ï¼šä»¥ä¸ºæ™ºèƒ½æŒ‡é’ˆå®Œå…¨è§£å†³å†…å­˜æ³„æ¼
âœ… **æ­£ç¡®**ï¼šå¾ªç¯å¼•ç”¨ä»ä¼šæ³„æ¼ï¼Œéœ€è¦weak_ptr

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°æ ˆæº¢å‡ºçš„å®‰å…¨é—®é¢˜ï¼ˆç¼“å†²åŒºæº¢å‡ºæ”»å‡»ï¼‰
- çŸ¥é“å†…å­˜æ± çš„å®ç°åŸç†å’Œåº”ç”¨åœºæ™¯
- äº†è§£tcmallocã€jemallocç­‰é«˜æ€§èƒ½å†…å­˜åˆ†é…å™¨
- æåˆ°å†…å­˜å¯¹é½å¯¹æ€§èƒ½çš„å½±å“
- çŸ¥é“ç¼–è¯‘å™¨ä¼˜åŒ–ï¼ˆå¦‚å°å¯¹è±¡ä¼˜åŒ–SSOï¼‰

---

## ğŸ“Œ æ‹·è´æ§åˆ¶ä¸ä¸‰/äº”æ³•åˆ™ï¼ˆâ­â­â­â­â­ å¿…è€ƒï¼‰

### ğŸ¯ å¾—åˆ†å…³é”®è¯
> **æ‹·è´æ„é€ ** | **æ‹·è´èµ‹å€¼** | **æ·±æ‹·è´** | **æµ…æ‹·è´** | **ä¸‰æ³•åˆ™** | **äº”æ³•åˆ™** | **é›¶æ³•åˆ™** | **è‡ªèµ‹å€¼æ£€æµ‹**

### âœ… æ‹·è´æ„é€ å‡½æ•°

**è¯­æ³•ï¼š**
```cpp
class MyClass {
public:
    // æ‹·è´æ„é€ å‡½æ•°
    MyClass(const MyClass& other);
};

// è°ƒç”¨æ—¶æœºï¼š
MyClass obj1;
MyClass obj2(obj1);      // 1. ç›´æ¥åˆå§‹åŒ–
MyClass obj3 = obj1;     // 2. æ‹·è´åˆå§‹åŒ–
func(obj1);              // 3. å‡½æ•°ä¼ å‚ï¼ˆå€¼ä¼ é€’ï¼‰
MyClass func() {         // 4. å‡½æ•°è¿”å›å€¼ï¼ˆå¯èƒ½è¢«RVOä¼˜åŒ–ï¼‰
    MyClass temp;
    return temp;
}
```

**æ·±æ‹·è´vsæµ…æ‹·è´ï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰ï¼š**

```cpp
class String {
    char* data;
    size_t len;
public:
    // âŒ æµ…æ‹·è´ï¼ˆç¼–è¯‘å™¨é»˜è®¤ï¼‰
    // String(const String& other) {
    //     data = other.data;  // âŒ åªæ‹·è´æŒ‡é’ˆ
    //     len = other.len;
    // }
    // é—®é¢˜ï¼šä¸¤ä¸ªå¯¹è±¡å…±äº«åŒä¸€å—å†…å­˜
    // ææ„æ—¶ä¼šdouble free

    // âœ… æ·±æ‹·è´ï¼ˆæ­£ç¡®ï¼‰
    String(const String& other) {
        len = other.len;
        data = new char[len + 1];      // ğŸ”‘ åˆ†é…æ–°å†…å­˜
        memcpy(data, other.data, len + 1);  // ğŸ”‘ æ‹·è´å†…å®¹
    }

    ~String() {
        delete[] data;
    }
};
```

**æµ…æ‹·è´çš„é—®é¢˜ç¤ºä¾‹ï¼š**
```cpp
class BadString {
    char* data;
public:
    BadString(const char* str) {
        data = new char[strlen(str) + 1];
        strcpy(data, str);
    }

    // âŒ ä½¿ç”¨ç¼–è¯‘å™¨é»˜è®¤æ‹·è´æ„é€ ï¼ˆæµ…æ‹·è´ï¼‰

    ~BadString() {
        delete[] data;
    }
};

int main() {
    BadString s1("hello");
    {
        BadString s2 = s1;  // æµ…æ‹·è´ï¼Œs1å’Œs2çš„dataæŒ‡å‘åŒä¸€å†…å­˜
    }  // s2ææ„ï¼Œdelete[] data

    // s1çš„dataå·²è¢«é‡Šæ”¾ï¼ˆæ‚¬ç©ºæŒ‡é’ˆï¼‰
    // s1ææ„æ—¶å†delete[] data â†’ âŒ double freeå´©æºƒ
}
```

**æ·±æ‹·è´çš„å†…å­˜å¸ƒå±€ï¼š**
```
æµ…æ‹·è´ï¼š
s1: data â”€â”€â†’ [h][e][l][l][o][\0]
            â†‘
s2: data â”€â”€â”€â”€â”˜  â† ğŸ”‘ å…±äº«åŒä¸€å†…å­˜

æ·±æ‹·è´ï¼š
s1: data â”€â”€â†’ [h][e][l][l][o][\0]

s2: data â”€â”€â†’ [h][e][l][l][o][\0]  â† ğŸ”‘ ç‹¬ç«‹å†…å­˜
```

### ğŸ’¡ æ‹·è´èµ‹å€¼è¿ç®—ç¬¦

**è¯­æ³•ï¼š**
```cpp
class MyClass {
public:
    // æ‹·è´èµ‹å€¼è¿ç®—ç¬¦
    MyClass& operator=(const MyClass& other);
};

// è°ƒç”¨æ—¶æœºï¼š
MyClass obj1, obj2;
obj2 = obj1;  // æ‹·è´èµ‹å€¼
```

**å®Œæ•´å®ç°ï¼ˆâ­â­â­â­â­ å¿…ä¼šæ‰‹å†™ï¼‰ï¼š**
```cpp
class String {
    char* data;
    size_t len;
public:
    // æ‹·è´èµ‹å€¼è¿ç®—ç¬¦
    String& operator=(const String& other) {
        // ğŸ”‘ 1. è‡ªèµ‹å€¼æ£€æµ‹
        if (this == &other) {
            return *this;
        }

        // ğŸ”‘ 2. é‡Šæ”¾æ—§èµ„æº
        delete[] data;

        // ğŸ”‘ 3. æ‹·è´æ–°èµ„æº
        len = other.len;
        data = new char[len + 1];
        memcpy(data, other.data, len + 1);

        // ğŸ”‘ 4. è¿”å›*this
        return *this;
    }
};
```

**ä¸ºä»€ä¹ˆéœ€è¦è‡ªèµ‹å€¼æ£€æµ‹ï¼š**
```cpp
String s1("hello");
s1 = s1;  // è‡ªèµ‹å€¼

// å¦‚æœæ²¡æœ‰è‡ªèµ‹å€¼æ£€æµ‹ï¼š
String& operator=(const String& other) {
    delete[] data;  // é‡Šæ”¾data
    // æ­¤æ—¶other.dataä¹Ÿè¢«é‡Šæ”¾äº†ï¼ˆå› ä¸ºthis == &otherï¼‰
    // ä¸‹é¢è®¿é—®other.dataæ˜¯æœªå®šä¹‰è¡Œä¸º
    data = new char[other.len + 1];
    memcpy(data, other.data, other.len + 1);  // âŒ è®¿é—®å·²é‡Šæ”¾å†…å­˜
    return *this;
}
```

**å¼‚å¸¸å®‰å…¨çš„æ‹·è´èµ‹å€¼ï¼ˆâ­â­â­â­ åŠ åˆ†é¡¹ï¼‰ï¼š**
```cpp
// Copy-And-Swapæƒ¯ç”¨æ³•
class String {
    char* data;
    size_t len;
public:
    // swapå‡½æ•°
    void swap(String& other) noexcept {
        std::swap(data, other.data);
        std::swap(len, other.len);
    }

    // æ‹·è´èµ‹å€¼ï¼ˆå¼‚å¸¸å®‰å…¨ï¼‰
    String& operator=(const String& other) {
        String temp(other);  // ğŸ”‘ æ‹·è´åˆ°ä¸´æ—¶å¯¹è±¡
        swap(temp);          // ğŸ”‘ äº¤æ¢
        return *this;
        // tempææ„ï¼Œé‡Šæ”¾æ—§èµ„æº
    }

    // ä¼˜ç‚¹ï¼š
    // 1. è‡ªåŠ¨å¤„ç†è‡ªèµ‹å€¼
    // 2. å¼‚å¸¸å®‰å…¨ï¼ˆnewå¤±è´¥ä¸ä¼šç ´ååŸå¯¹è±¡ï¼‰
    // 3. ä»£ç å¤ç”¨ï¼ˆåˆ©ç”¨æ‹·è´æ„é€ ï¼‰
};
```

### ğŸ”¥ ä¸‰æ³•åˆ™ã€äº”æ³•åˆ™ã€é›¶æ³•åˆ™ï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

#### ä¸‰æ³•åˆ™ï¼ˆRule of Threeï¼‰

```cpp
// å¦‚æœéœ€è¦è‡ªå®šä¹‰ä»¥ä¸‹ä¹‹ä¸€ï¼Œé€šå¸¸éœ€è¦è‡ªå®šä¹‰å…¨éƒ¨ä¸‰ä¸ªï¼š
class Rule3 {
public:
    // 1ï¸âƒ£ ææ„å‡½æ•°
    ~Rule3() {
        delete[] data;
    }

    // 2ï¸âƒ£ æ‹·è´æ„é€ å‡½æ•°
    Rule3(const Rule3& other) {
        len = other.len;
        data = new char[len];
        memcpy(data, other.data, len);
    }

    // 3ï¸âƒ£ æ‹·è´èµ‹å€¼è¿ç®—ç¬¦
    Rule3& operator=(const Rule3& other) {
        if (this != &other) {
            delete[] data;
            len = other.len;
            data = new char[len];
            memcpy(data, other.data, len);
        }
        return *this;
    }

private:
    char* data;
    size_t len;
};
```

#### äº”æ³•åˆ™ï¼ˆRule of Fiveï¼ŒC++11ï¼‰

```cpp
// C++11å¼•å…¥ç§»åŠ¨è¯­ä¹‰åï¼Œæ‰©å±•ä¸ºäº”æ³•åˆ™ï¼š
class Rule5 {
public:
    // 1ï¸âƒ£ ææ„å‡½æ•°
    ~Rule5() {
        delete[] data;
    }

    // 2ï¸âƒ£ æ‹·è´æ„é€ å‡½æ•°
    Rule5(const Rule5& other) {
        len = other.len;
        data = new char[len];
        memcpy(data, other.data, len);
    }

    // 3ï¸âƒ£ æ‹·è´èµ‹å€¼è¿ç®—ç¬¦
    Rule5& operator=(const Rule5& other) {
        if (this != &other) {
            delete[] data;
            len = other.len;
            data = new char[len];
            memcpy(data, other.data, len);
        }
        return *this;
    }

    // 4ï¸âƒ£ ç§»åŠ¨æ„é€ å‡½æ•°ï¼ˆC++11ï¼‰
    Rule5(Rule5&& other) noexcept {
        data = other.data;      // ğŸ”‘ çªƒå–èµ„æº
        len = other.len;
        other.data = nullptr;   // ğŸ”‘ æ¸…ç©ºåŸå¯¹è±¡
        other.len = 0;
    }

    // 5ï¸âƒ£ ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼ˆC++11ï¼‰
    Rule5& operator=(Rule5&& other) noexcept {
        if (this != &other) {
            delete[] data;         // é‡Šæ”¾è‡ªå·±çš„èµ„æº
            data = other.data;     // çªƒå–
            len = other.len;
            other.data = nullptr;  // æ¸…ç©º
            other.len = 0;
        }
        return *this;
    }

private:
    char* data;
    size_t len;
};
```

**æ‹·è´vsç§»åŠ¨çš„æ€§èƒ½å¯¹æ¯”ï¼š**
```cpp
Rule5 createLarge() {
    Rule5 temp;
    // åˆå§‹åŒ–å¤§é‡æ•°æ®
    return temp;
}

// æ‹·è´ï¼šO(n)
Rule5 obj1 = createLarge();  // å¦‚æœæ²¡æœ‰RVOï¼Œä¼šæ‹·è´

// ç§»åŠ¨ï¼šO(1)
Rule5 obj2 = std::move(createLarge());  // ç§»åŠ¨æ„é€ ï¼Œåªè½¬ç§»æŒ‡é’ˆ

// æ€§èƒ½å·®å¼‚ï¼š
// æ‹·è´ï¼šåˆ†é…å†…å­˜ + æ‹·è´æ‰€æœ‰æ•°æ®
// ç§»åŠ¨ï¼šåªè½¬ç§»æŒ‡é’ˆï¼Œå¸¸æ•°æ—¶é—´
```

#### é›¶æ³•åˆ™ï¼ˆRule of Zeroï¼‰

```cpp
// ğŸŒŸ æœ€ä½³å®è·µï¼šä¸è‡ªå·±ç®¡ç†èµ„æº
class Rule0 {
public:
    // âœ… ä¸éœ€è¦è‡ªå®šä¹‰ä»»ä½•ç‰¹æ®Šæˆå‘˜å‡½æ•°
    // ç¼–è¯‘å™¨ç”Ÿæˆçš„é»˜è®¤å®ç°å°±å¤Ÿäº†

private:
    string name;         // è‡ªåŠ¨ç®¡ç†
    vector<int> data;    // è‡ªåŠ¨ç®¡ç†
    unique_ptr<int> ptr; // è‡ªåŠ¨ç®¡ç†
};

// ğŸ”‘ åŸåˆ™ï¼šè®©æ ‡å‡†åº“ç»„ä»¶ç®¡ç†èµ„æº
// ä¸ç”¨å†™ææ„ã€æ‹·è´æ„é€ ã€æ‹·è´èµ‹å€¼
// ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ç‰ˆæœ¬å·²ç»æ­£ç¡®
```

### ğŸ”¥ é¢è¯•è¿½é—®ç‚¹

#### 1ï¸âƒ£ ä»€ä¹ˆæ—¶å€™ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Ÿï¼ˆâ­â­â­â­â­ å¿…é—®ï¼‰

```cpp
class Test {
public:
    Test() { cout << "æ„é€ \n"; }
    Test(const Test&) { cout << "æ‹·è´æ„é€ \n"; }
    Test& operator=(const Test&) { cout << "æ‹·è´èµ‹å€¼\n"; return *this; }
};

Test t1;           // æ„é€ 

// 1ï¸âƒ£ ç”¨å·²å­˜åœ¨å¯¹è±¡åˆå§‹åŒ–æ–°å¯¹è±¡
Test t2(t1);       // æ‹·è´æ„é€ 
Test t3 = t1;      // æ‹·è´æ„é€ ï¼ˆä¸æ˜¯èµ‹å€¼ï¼ï¼‰

// 2ï¸âƒ£ å‡½æ•°å‚æ•°ï¼ˆå€¼ä¼ é€’ï¼‰
void func(Test t) {}
func(t1);          // æ‹·è´æ„é€ 

// 3ï¸âƒ£ å‡½æ•°è¿”å›å€¼ï¼ˆå¯èƒ½è¢«RVOä¼˜åŒ–ï¼‰
Test func2() {
    Test temp;
    return temp;   // å¯èƒ½æ‹·è´æ„é€ ï¼ˆå–å†³äºRVOï¼‰
}
Test t4 = func2();

// 4ï¸âƒ£ åˆå§‹åŒ–å®¹å™¨å…ƒç´ 
vector<Test> vec;
vec.push_back(t1); // æ‹·è´æ„é€ 
```

#### 2ï¸âƒ£ æ‹·è´æ„é€ å’Œæ‹·è´èµ‹å€¼çš„åŒºåˆ«ï¼Ÿï¼ˆâ­â­â­â­â­ é«˜é¢‘ï¼‰

```cpp
Test t1;
Test t2(t1);  // æ‹·è´æ„é€ ï¼ˆåˆ›å»ºæ–°å¯¹è±¡ï¼‰
Test t3 = t1; // æ‹·è´æ„é€ ï¼ˆè™½ç„¶æœ‰=ï¼Œä½†ä»æ˜¯åˆå§‹åŒ–ï¼‰

Test t4;
t4 = t1;      // æ‹·è´èµ‹å€¼ï¼ˆt4å·²å­˜åœ¨ï¼‰

// ğŸ”‘ åŒºåˆ«ï¼š
// æ‹·è´æ„é€ ï¼šåˆ›å»ºæ–°å¯¹è±¡
// æ‹·è´èµ‹å€¼ï¼šå·²å­˜åœ¨å¯¹è±¡ï¼Œéœ€è¦å…ˆé‡Šæ”¾æ—§èµ„æº
```

#### 3ï¸âƒ£ å¦‚ä½•ç¦æ­¢æ‹·è´ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// C++11ä¹‹å‰
class NonCopyable {
private:
    NonCopyable(const NonCopyable&);  // å£°æ˜ä¸ºprivate
    NonCopyable& operator=(const NonCopyable&);
};

// C++11ä¹‹å
class NonCopyable {
public:
    NonCopyable() = default;
    NonCopyable(const NonCopyable&) = delete;  // âœ… ç¦æ­¢æ‹·è´
    NonCopyable& operator=(const NonCopyable&) = delete;

    // å…è®¸ç§»åŠ¨
    NonCopyable(NonCopyable&&) = default;
    NonCopyable& operator=(NonCopyable&&) = default;
};

// ä½¿ç”¨
NonCopyable obj1;
// NonCopyable obj2 = obj1;  // âŒ ç¼–è¯‘é”™è¯¯
NonCopyable obj3 = std::move(obj1);  // âœ… ç§»åŠ¨
```

#### 4ï¸âƒ£ è¿”å›å€¼ä¼˜åŒ–ï¼ˆRVOï¼‰æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
String createString() {
    String temp("hello");
    return temp;  // ğŸ”‘ ä¸ä¸€å®šæ‹·è´
}

String s = createString();

// C++11å‰ï¼šå¯èƒ½æ‹·è´æ„é€ tempåˆ°s
// C++11åï¼šRVOï¼ˆè¿”å›å€¼ä¼˜åŒ–ï¼‰ï¼Œç›´æ¥åœ¨sçš„ä½ç½®æ„é€ 
// C++17åï¼šå¼ºåˆ¶RVOï¼ˆä¿è¯ä¼˜åŒ–ï¼‰

// ğŸ”‘ ä¸è¦æ‰‹åŠ¨std::moveè¿”å›å€¼
String badCreateString() {
    String temp("hello");
    return std::move(temp);  // âŒ é˜»æ­¢RVO
}

// âœ… ç¼–è¯‘å™¨çŸ¥é“æ€ä¹ˆä¼˜åŒ–
String goodCreateString() {
    String temp("hello");
    return temp;  // âœ… è®©ç¼–è¯‘å™¨ä¼˜åŒ–
}
```

#### 5ï¸âƒ£ æ·±æ‹·è´å’Œæµ…æ‹·è´çš„åº”ç”¨åœºæ™¯ï¼Ÿï¼ˆâ­â­â­â­ï¼‰

```cpp
// æµ…æ‹·è´é€‚ç”¨åœºæ™¯ï¼š
class Point {
    int x, y;  // ğŸ”‘ åŸºæœ¬ç±»å‹ï¼Œæ— éœ€æ·±æ‹·è´
public:
    // ç¼–è¯‘å™¨é»˜è®¤æµ…æ‹·è´å°±å¤Ÿäº†
};

// æ·±æ‹·è´é€‚ç”¨åœºæ™¯ï¼š
class String {
    char* data;  // ğŸ”‘ æŒ‡é’ˆæˆå‘˜ï¼Œéœ€è¦æ·±æ‹·è´
public:
    String(const String& other) {
        // å¿…é¡»æ·±æ‹·è´
        data = new char[strlen(other.data) + 1];
        strcpy(data, other.data);
    }
};

// ğŸŒŸ æœ€ä½³å®è·µï¼šä½¿ç”¨æ ‡å‡†åº“
class BetterString {
    string data;  // âœ… è‡ªåŠ¨æ·±æ‹·è´
public:
    // ä¸éœ€è¦è‡ªå®šä¹‰æ‹·è´æ„é€ 
};
```

### ğŸ“ é¢è¯•å›ç­”æ¨¡æ¿

```
ã€æ ‡å‡†å›ç­”ã€‘
æ‹·è´æ§åˆ¶åŒ…æ‹¬ä¸‰/äº”ä¸ªç‰¹æ®Šæˆå‘˜å‡½æ•°ï¼š

ä¸‰æ³•åˆ™ï¼ˆC++03ï¼‰ï¼š
1. ææ„å‡½æ•°
2. æ‹·è´æ„é€ å‡½æ•°
3. æ‹·è´èµ‹å€¼è¿ç®—ç¬¦

äº”æ³•åˆ™ï¼ˆC++11ï¼‰ï¼š
å¢åŠ ç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦

é›¶æ³•åˆ™ï¼š
ä½¿ç”¨æ ‡å‡†åº“ç»„ä»¶ç®¡ç†èµ„æºï¼Œä¸è‡ªå®šä¹‰ç‰¹æ®Šæˆå‘˜å‡½æ•°

æ·±æ‹·è´vsæµ…æ‹·è´ï¼š
- æµ…æ‹·è´ï¼šåªæ‹·è´æŒ‡é’ˆå€¼ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
- æ·±æ‹·è´ï¼šåˆ†é…æ–°å†…å­˜ï¼Œæ‹·è´å†…å®¹

ã€è¿½é—®-è°ƒç”¨æ—¶æœºã€‘
æ‹·è´æ„é€ ï¼š
1. å¯¹è±¡åˆå§‹åŒ–
2. å‡½æ•°å€¼ä¼ é€’
3. å‡½æ•°è¿”å›å€¼ï¼ˆå¯èƒ½è¢«RVOä¼˜åŒ–ï¼‰

æ‹·è´èµ‹å€¼ï¼š
å·²å­˜åœ¨å¯¹è±¡çš„èµ‹å€¼æ“ä½œ

ã€è¿½é—®-è‡ªèµ‹å€¼æ£€æµ‹ã€‘
å¿…é¡»æ£€æµ‹ï¼Œå¦åˆ™ï¼š
1. å¯èƒ½é‡Šæ”¾è‡ªå·±çš„èµ„æº
2. è®¿é—®å·²é‡Šæ”¾å†…å­˜
3. æœªå®šä¹‰è¡Œä¸º

ã€è¿½é—®-å¼‚å¸¸å®‰å…¨ã€‘
ä½¿ç”¨Copy-And-Swapæƒ¯ç”¨æ³•ï¼š
1. æ‹·è´åˆ°ä¸´æ—¶å¯¹è±¡
2. äº¤æ¢
3. ä¸´æ—¶å¯¹è±¡ææ„é‡Šæ”¾æ—§èµ„æº

ä¼˜ç‚¹ï¼šè‡ªåŠ¨å¤„ç†è‡ªèµ‹å€¼ã€å¼‚å¸¸å®‰å…¨ã€ä»£ç å¤ç”¨
```

### âš ï¸ å¸¸è§è¯¯åŒº

âŒ **é”™è¯¯1**ï¼š`Test t = obj;` æ˜¯æ‹·è´èµ‹å€¼
âœ… **æ­£ç¡®**ï¼šè¿™æ˜¯æ‹·è´æ„é€ ï¼Œåˆå§‹åŒ–è¯­æ³•

âŒ **é”™è¯¯2**ï¼šæ‹·è´èµ‹å€¼ä¸éœ€è¦æ£€æµ‹è‡ªèµ‹å€¼
âœ… **æ­£ç¡®**ï¼šå¿…é¡»æ£€æµ‹ï¼Œå¦åˆ™å¯èƒ½é‡Šæ”¾è‡ªå·±çš„èµ„æº

âŒ **é”™è¯¯3**ï¼šç§»åŠ¨åçš„å¯¹è±¡ä¸èƒ½å†ç”¨
âœ… **æ­£ç¡®**ï¼šå¯ä»¥èµ‹å€¼å’Œææ„ï¼Œä½†ä¸åº”ä½¿ç”¨å…¶å€¼

âŒ **é”™è¯¯4**ï¼šè¿”å›å±€éƒ¨å¯¹è±¡è¦ç”¨std::move
âœ… **æ­£ç¡®**ï¼šä¸è¦moveï¼Œä¼šé˜»æ­¢RVOä¼˜åŒ–

### ğŸŒŸ åŠ åˆ†ç‚¹

- æåˆ°Copy-And-Swapæƒ¯ç”¨æ³•
- çŸ¥é“RVO/NRVOä¼˜åŒ–
- äº†è§£C++17å¼ºåˆ¶RVO
- æåˆ°ç§»åŠ¨è¯­ä¹‰ä¼˜åŒ–å®¹å™¨æ“ä½œ
- çŸ¥é“noexceptå¯¹ç§»åŠ¨è¯­ä¹‰çš„å½±å“ï¼ˆvectoræ‰©å®¹ï¼‰

---
